<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Generator - Hardware Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: calc(100vh - 150px);
        }
        
        /* Left Side - Product Selection */
        .products-section {
            padding: 25px;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }
        
        <!-- Search Bar -->
        .search-bar {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .search-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .brand-filter {
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .brand-filter:focus,
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-info {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .filter-tag {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-tag .clear {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }
        
        .filter-tag .clear:hover {
            opacity: 1;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        /* Product Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .product-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .product-card.selected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .product-name {
            font-weight: 700;
            font-size: 15px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .product-brand {
            font-size: 11px;
            color: #3498db;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .product-category {
            font-size: 11px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stock-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .stock-in { background: #d4edda; color: #155724; }
        .stock-out { background: #f8d7da; color: #721c24; }
        .stock-low { background: #fff3cd; color: #856404; }
        
        .product-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        
        .product-price {
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .product-stock {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .add-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .add-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .add-btn.added {
            background: #28a745;
        }
        
        /* Right Side - Quotation Builder */
        .quotation-section {
            background: #f8f9fa;
            padding: 25px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Customer Form */
        .customer-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        /* Selected Items */
        .selected-items {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            flex: 1;
        }
        
        .item-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .item-name {
            font-weight: 600;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .item-inputs {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1.2fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .item-price-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .price-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        
        .input-group input {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .input-group input[type="number"]:invalid,
        .input-group input.empty-price {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .item-total {
            text-align: right;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
            font-weight: 700;
            color: #27ae60;
            font-size: 14px;
        }
        
        /* Summary */
        .quotation-summary {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 14px;
        }
        
        .summary-row.total {
            border-top: 2px solid #e0e0e0;
            margin-top: 10px;
            padding-top: 15px;
            font-size: 18px;
            font-weight: 700;
            color: #27ae60;
        }
        
        .discount-input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .discount-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .discount-input-group button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .discount-input-group button:hover {
            background: #5568d3;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #28a745;
            color: white;
        }
        
        .btn-primary:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .loading i {
            font-size: 48px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Scrollbar */
        .products-section::-webkit-scrollbar,
        .quotation-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .products-section::-webkit-scrollbar-track,
        .quotation-section::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .products-section::-webkit-scrollbar-thumb,
        .quotation-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .products-section::-webkit-scrollbar-thumb:hover,
        .quotation-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .products-section {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-file-invoice"></i>
                Quotation Generator
            </h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/dashboard'">
                    <i class="fas fa-home"></i> Dashboard
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Side - Products -->
            <div class="products-section">
                <div class="search-bar">
                    <div class="search-filters">
                        <div class="search-container" style="flex: 1;">
                            <input type="text" id="searchInput" class="search-input" placeholder="Search products by name...">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <select id="brandFilter" class="brand-filter">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div class="filter-info" id="filterInfo"></div>
                </div>
                
                <div id="productsGrid" class="products-grid">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Side - Quotation -->
            <div class="quotation-section">
                <!-- Customer Details -->
                <div class="customer-form">
                    <div class="section-title">
                        <i class="fas fa-user"></i>
                        Customer Details
                    </div>
                    
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="customerName" placeholder="Enter customer name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Mobile Number *</label>
                        <input type="tel" id="customerMobile" placeholder="Enter 10-digit mobile number" maxlength="10" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="customerAddress" placeholder="Enter customer address (optional)"></textarea>
                    </div>
                </div>
                
                <!-- Selected Items -->
                <div class="selected-items">
                    <div class="section-title">
                        <i class="fas fa-shopping-cart"></i>
                        Selected Items (<span id="itemCount">0</span>)
                    </div>
                    
                    <div id="selectedItemsList">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No items selected yet</p>
                            <small>Click on products to add them</small>
                        </div>
                    </div>
                </div>
                
                <!-- Summary -->
                <div class="quotation-summary">
                    <div class="section-title">
                        <i class="fas fa-calculator"></i>
                        Summary
                    </div>
                    
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">₹0.00</span>
                    </div>
                    
                    <div class="discount-input-group">
                        <input type="number" id="discountPercent" placeholder="Discount %" min="0" max="100" value="0">
                        <button onclick="applyDiscount()">Apply</button>
                    </div>
                    
                    <div class="summary-row">
                        <span>Discount:</span>
                        <span id="discountAmount">₹0.00</span>
                    </div>
                    
                    <div class="summary-row total">
                        <span>Grand Total:</span>
                        <span id="grandTotal">₹0.00</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="clearQuotation()">
                            <i class="fas fa-redo"></i> Clear
                        </button>
                        <button class="btn btn-primary" onclick="generateQuotation()" id="generateBtn">
                            <i class="fas fa-download"></i> Generate PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allProducts = [];
        let selectedItems = [];
        let discountPercentage = 0;
        let currentBrandFilter = '';
        let currentSearchTerm = '';
        
        // Load products on page load
        window.addEventListener('DOMContentLoaded', loadProducts);
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            currentSearchTerm = e.target.value.toLowerCase();
            filterProducts();
        });
        
        // Brand filter functionality
        document.getElementById('brandFilter').addEventListener('change', function(e) {
            currentBrandFilter = e.target.value;
            filterProducts();
            updateFilterInfo();
        });
        
        // Load all products
        async function loadProducts() {
            try {
                console.log('Loading products from /api/quotations/products');
                
                const response = await fetch('/api/quotations/products');
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    console.error('Error response:', errorData);
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to load products`);
                }
                
                allProducts = await response.json();
                console.log(`Loaded ${allProducts.length} products`);
                
                // Populate brand dropdown
                populateBrandFilter();
                
                displayProducts(allProducts);
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                        <p style="color: #e74c3c; font-weight: 600;">Error loading products</p>
                        <small style="color: #666;">${error.message}</small>
                        <br><br>
                        <button class="btn btn-primary" onclick="loadProducts()" style="margin-top: 10px;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                        <br><br>
                        <small style="color: #999;">Check browser console (F12) for more details</small>
                    </div>
                `;
            }
        }
        
        // Populate brand filter dropdown
        function populateBrandFilter() {
            const brands = [...new Set(allProducts.map(p => p.brand).filter(b => b && b.trim()))].sort();
            const brandFilter = document.getElementById('brandFilter');
            
            // Clear existing options except "All Brands"
            brandFilter.innerHTML = '<option value="">All Brands</option>';
            
            // Add brand options
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });
            
            console.log(`Populated ${brands.length} brands`);
        }
        
        // Update filter info display
        function updateFilterInfo() {
            const filterInfo = document.getElementById('filterInfo');
            const tags = [];
            
            if (currentBrandFilter) {
                tags.push(`
                    <div class="filter-tag">
                        <i class="fas fa-tag"></i>
                        Brand: ${currentBrandFilter}
                        <span class="clear" onclick="clearBrandFilter()">×</span>
                    </div>
                `);
            }
            
            if (currentSearchTerm) {
                tags.push(`
                    <div class="filter-tag">
                        <i class="fas fa-search"></i>
                        Search: "${currentSearchTerm}"
                        <span class="clear" onclick="clearSearch()">×</span>
                    </div>
                `);
            }
            
            filterInfo.innerHTML = tags.join('');
        }
        
        // Clear brand filter
        function clearBrandFilter() {
            currentBrandFilter = '';
            document.getElementById('brandFilter').value = '';
            filterProducts();
            updateFilterInfo();
        }
        
        // Clear search
        function clearSearch() {
            currentSearchTerm = '';
            document.getElementById('searchInput').value = '';
            filterProducts();
            updateFilterInfo();
        }
        
        // Display products
        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-box-open"></i>
                        <p>No products found</p>
                        <small>Try adjusting your filters</small>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const isSelected = selectedItems.some(item => item.product_id === product.product_id);
                const stockClass = product.stock_quantity > 10 ? 'stock-in' : 
                                   product.stock_quantity > 0 ? 'stock-low' : 'stock-out';
                const stockText = product.stock_quantity > 0 ? 'In Stock' : 'Out of Stock';
                
                return `
                    <div class="product-card ${isSelected ? 'selected' : ''}" onclick="addProduct(${product.product_id})">
                        <div class="product-header">
                            <div>
                                <div class="product-name">${product.product_name}</div>
                                ${product.brand ? `<div class="product-brand"><i class="fas fa-tag"></i> ${product.brand}</div>` : ''}
                                <div class="product-category">${product.category_name || 'Uncategorized'}</div>
                            </div>
                            <span class="stock-badge ${stockClass}">${stockText}</span>
                        </div>
                        
                        <div class="product-info">
                            <div>
                                <div class="product-price">Price: Set manually</div>
                                <div class="product-stock">Stock: ${product.stock_quantity}</div>
                            </div>
                            <button class="add-btn ${isSelected ? 'added' : ''}" onclick="event.stopPropagation(); addProduct(${product.product_id})">
                                <i class="fas ${isSelected ? 'fa-check' : 'fa-plus'}"></i>
                                ${isSelected ? 'Added' : 'Add'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter products based on search and brand
        function filterProducts() {
            let filtered = allProducts;
            
            // Apply brand filter
            if (currentBrandFilter) {
                filtered = filtered.filter(product => 
                    product.brand && product.brand.toLowerCase() === currentBrandFilter.toLowerCase()
                );
            }
            
            // Apply search filter (searches in name, brand, and category)
            if (currentSearchTerm) {
                filtered = filtered.filter(product => {
                    const name = product.product_name ? product.product_name.toLowerCase() : '';
                    const brand = product.brand ? product.brand.toLowerCase() : '';
                    const category = product.category_name ? product.category_name.toLowerCase() : '';
                    
                    return name.includes(currentSearchTerm) || 
                           brand.includes(currentSearchTerm) || 
                           category.includes(currentSearchTerm);
                });
            }
            
            displayProducts(filtered);
            updateFilterInfo();
        }
        
        // Add product to quotation
        function addProduct(productId) {
            const product = allProducts.find(p => p.product_id === productId);
            if (!product) return;
            
            // Check if already added
            const existingIndex = selectedItems.findIndex(item => item.product_id === productId);
            
            if (existingIndex >= 0) {
                // Remove if already added
                selectedItems.splice(existingIndex, 1);
            } else {
                // Add new item with empty price that user must fill
                selectedItems.push({
                    product_id: product.product_id,
                    product_name: product.product_name,
                    brand: product.brand || '',  // Add brand information
                    quantity: 1,
                    unit_price: 0,  // User must enter price
                    discount: 0,
                    discount_percentage: 0  // Percentage discount only
                });
            }
            
            updateSelectedItems();
            displayProducts(allProducts.filter(p => 
                p.product_name.toLowerCase().includes(document.getElementById('searchInput').value.toLowerCase())
            ));
        }
        
        // Update selected items display
        function updateSelectedItems() {
            const container = document.getElementById('selectedItemsList');
            const countElem = document.getElementById('itemCount');
            
            countElem.textContent = selectedItems.length;
            
            if (selectedItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No items selected yet</p>
                        <small>Click on products to add them</small>
                    </div>
                `;
            } else {
                container.innerHTML = selectedItems.map((item, index) => {
                    // Create full product name with brand
                    const brandPrefix = item.brand ? `${item.brand} - ` : '';
                    const fullName = brandPrefix + item.product_name;
                    
                    return `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-name">${fullName}</div>
                            <button class="remove-btn" onclick="removeItem(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="item-inputs">
                            <div class="input-group">
                                <label>Quantity</label>
                                <input type="number" value="${item.quantity}" min="1" step="0.01" 
                                       onchange="updateItem(${index}, 'quantity', this.value)">
                            </div>
                            <div class="item-price-section">
                                <div class="input-group">
                                    <label>MRP (₹) *</label>
                                    <input type="number" value="${item.unit_price}" min="0" step="0.01" 
                                           class="${item.unit_price === 0 ? 'empty-price' : ''}"
                                           placeholder="Enter MRP"
                                           onchange="updateItem(${index}, 'unit_price', this.value)">
                                </div>
                            </div>
                            <div class="item-price-section">
                                <div class="input-group">
                                    <label>Discount (%)</label>
                                    <input type="number" 
                                           value="${item.discount_percentage || 0}" 
                                           min="0" 
                                           max="100"
                                           step="0.01" 
                                           placeholder="0"
                                           onchange="updateItemDiscount(${index}, this.value)"
                                           style="flex: 1;">
                                    ${item.discount_percentage > 0 ? 
                                        `<small style="color: #27ae60; font-size: 10px; display: block; margin-top: 4px;">-₹${((item.unit_price * item.quantity * item.discount_percentage) / 100).toFixed(2)}</small>` 
                                        : ''}
                                </div>
                            </div>
                        </div>
                        <div class="item-total">
                            ${item.discount_percentage > 0 ? 
                                `<span style="color: #999; font-size: 11px; text-decoration: line-through;">
                                    Original: ₹${(item.quantity * item.unit_price).toFixed(2)}
                                </span>` : ''}
                            <span style="color: #27ae60; font-weight: 700; font-size: 14px; margin-left: 8px;">
                                Total: ₹${calculateItemTotal(item).toFixed(2)}
                            </span>
                        </div>
                    </div>
                    `;
                }).join('');
            }
            
            updateSummary();
        }
        
        // Calculate item total
        function calculateItemTotal(item) {
            const baseTotal = item.quantity * item.unit_price;
            const discountAmount = (baseTotal * (item.discount_percentage || 0)) / 100;
            return baseTotal - discountAmount;
        }
        
        // Update item discount (percentage only)
        function updateItemDiscount(index, value) {
            const item = selectedItems[index];
            const numValue = parseFloat(value) || 0;
            
            // Limit percentage to 0-100
            item.discount_percentage = Math.min(Math.max(numValue, 0), 100);
            
            // Calculate actual discount amount for backend
            item.discount = ((item.quantity * item.unit_price * item.discount_percentage) / 100);
            
            updateSummary();
            
            // Update the item total display
            const itemCards = document.querySelectorAll('.item-card');
            if (itemCards[index]) {
                const totalElem = itemCards[index].querySelector('.item-total');
                const originalPrice = item.quantity * item.unit_price;
                const finalPrice = calculateItemTotal(item);
                const hasDiscount = item.discount_percentage > 0;
                
                totalElem.innerHTML = `
                    ${hasDiscount ? `<span style="color: #999; font-size: 11px; text-decoration: line-through;">
                        Original: ₹${originalPrice.toFixed(2)}
                    </span>` : ''}
                    <span style="color: #27ae60; font-weight: 700; font-size: 14px; margin-left: 8px;">
                        Total: ₹${finalPrice.toFixed(2)}
                    </span>
                `;
            }
        }
        
        // Update item
        function updateItem(index, field, value) {
            selectedItems[index][field] = parseFloat(value) || 0;
            
            // Recalculate discount amount based on percentage when quantity/price changes
            if (field === 'quantity' || field === 'unit_price') {
                const item = selectedItems[index];
                item.discount = ((item.quantity * item.unit_price * item.discount_percentage) / 100);
            }
            
            updateSummary();
            
            // Update the item total display
            const itemCards = document.querySelectorAll('.item-card');
            if (itemCards[index]) {
                const totalElem = itemCards[index].querySelector('.item-total');
                const item = selectedItems[index];
                const originalPrice = item.quantity * item.unit_price;
                const finalPrice = calculateItemTotal(item);
                const hasDiscount = item.discount_percentage > 0;
                
                totalElem.innerHTML = `
                    ${hasDiscount ? `<span style="color: #999; font-size: 11px; text-decoration: line-through;">
                        Original: ₹${originalPrice.toFixed(2)}
                    </span>` : ''}
                    <span style="color: #27ae60; font-weight: 700; font-size: 14px; margin-left: 8px;">
                        Total: ₹${finalPrice.toFixed(2)}
                    </span>
                `;
            }
        }
        
        // Remove item
        function removeItem(index) {
            selectedItems.splice(index, 1);
            updateSelectedItems();
            displayProducts(allProducts.filter(p => 
                p.product_name.toLowerCase().includes(document.getElementById('searchInput').value.toLowerCase())
            ));
        }
        
        // Update summary
        function updateSummary() {
            const subtotal = selectedItems.reduce((sum, item) => sum + calculateItemTotal(item), 0);
            const discountAmount = (subtotal * discountPercentage) / 100;
            const grandTotal = subtotal - discountAmount;
            
            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('discountAmount').textContent = `₹${discountAmount.toFixed(2)}`;
            document.getElementById('grandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
        }
        
        // Apply discount
        function applyDiscount() {
            const discountInput = document.getElementById('discountPercent');
            discountPercentage = parseFloat(discountInput.value) || 0;
            
            if (discountPercentage < 0) discountPercentage = 0;
            if (discountPercentage > 100) discountPercentage = 100;
            
            discountInput.value = discountPercentage;
            updateSummary();
        }
        
        // Clear quotation
        function clearQuotation() {
            if (confirm('Are you sure you want to clear this quotation?')) {
                selectedItems = [];
                discountPercentage = 0;
                document.getElementById('customerName').value = '';
                document.getElementById('customerMobile').value = '';
                document.getElementById('customerAddress').value = '';
                document.getElementById('discountPercent').value = '0';
                updateSelectedItems();
                displayProducts(allProducts);
            }
        }
        
        // Generate quotation PDF
        async function generateQuotation() {
            // Validate customer details
            const customerName = document.getElementById('customerName').value.trim();
            const customerMobile = document.getElementById('customerMobile').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            
            if (!customerName) {
                alert('Please enter customer name');
                document.getElementById('customerName').focus();
                return;
            }
            
            if (!customerMobile || customerMobile.length !== 10) {
                alert('Please enter a valid 10-digit mobile number');
                document.getElementById('customerMobile').focus();
                return;
            }
            
            if (selectedItems.length === 0) {
                alert('Please add at least one item to the quotation');
                return;
            }
            
            // Validate that all items have prices entered
            const itemsWithoutPrice = selectedItems.filter(item => !item.unit_price || item.unit_price === 0);
            if (itemsWithoutPrice.length > 0) {
                alert(`Please enter prices for all items!\n\nItems missing prices:\n${itemsWithoutPrice.map(item => '• ' + item.product_name).join('\n')}`);
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            try {
                const quotationData = {
                    customer_name: customerName,
                    customer_mobile: customerMobile,
                    customer_address: customerAddress,
                    items: selectedItems,
                    discount_percentage: discountPercentage
                };
                
                const response = await fetch('/api/quotations/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quotationData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate quotation');
                }
                
                // Get the PDF blob
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Quotation_${customerName.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                alert('Quotation generated successfully!');
                
                // Ask if user wants to create another quotation
                if (confirm('Quotation downloaded! Do you want to create another quotation?')) {
                    clearQuotation();
                }
                
            } catch (error) {
                console.error('Error generating quotation:', error);
                alert('Error generating quotation: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-download"></i> Generate PDF';
            }
        }
    </script>
</body>
</html>