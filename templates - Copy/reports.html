<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Hardware Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        
        /* Navbar */
        .navbar { background: #2c3e50; color: white; padding: 15px 30px; }
        .navbar-container { display: flex; justify-content: space-between; align-items: center;   }
        .navbar-brand { font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .navbar-menu { display: flex; gap: 10px; flex-wrap: wrap; }
        .navbar-menu a { color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .navbar-menu a:hover { background: #34495e; }
        .navbar-menu a.active { background: #3498db; }
        
        /* Container */
        .container {  margin: 30px auto; padding: 0 10px; }
        .page-header { margin-bottom: 30px; }
        .page-header h1 { color: #2c3e50; font-size: 28px; margin-bottom: 10px; }
        .page-header p { color: #666; font-size: 14px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; color: #666; font-size: 14px; transition: all 0.3s; }
        .tab:hover { background: #e8f4f8; }
        .tab.active { background: #3498db; color: white; }
        
        /* Panel */
        .panel { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .panel h2 { color: #2c3e50; margin-bottom: 20px; font-size: 22px; }
        
        /* Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filters input, .filters select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .filters input:focus, .filters select:focus { outline: none; border-color: #3498db; }
        .filters label { font-size: 14px; color: #666; }
        
        /* Quick Date Buttons */
        .quick-dates { display: flex; gap: 10px; flex-wrap: wrap; }
        .quick-date-btn { padding: 8px 16px; background: #ecf0f1; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; transition: all 0.3s; }
        .quick-date-btn:hover { background: #3498db; color: white; }
        .quick-date-btn.active { background: #3498db; color: white; }
        
        /* Button */
        .btn { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4); }
        .btn:active { transform: translateY(0); }
        
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table th { background: #ecf0f1; padding: 12px; text-align: left; font-weight: 600; font-size: 13px; color: #2c3e50; }
        table td { padding: 12px; border-bottom: 1px solid #ecf0f1; font-size: 14px; }
        table tr:hover { background: #f8f9fa; }
        table tbody tr:last-child td { border-bottom: none; }
        table tbody tr { cursor: pointer; }
        
        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; cursor: pointer; transition: all 0.3s; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .summary-card:nth-child(2) { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .summary-card:nth-child(3) { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .summary-card:nth-child(4) { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .summary-card:nth-child(5) { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .summary-card h4 { font-size: 13px; margin-bottom: 8px; opacity: 0.9; font-weight: 500; }
        .summary-card .value { font-size: 28px; font-weight: bold; }
        .summary-card .subtitle { font-size: 12px; opacity: 0.8; margin-top: 5px; }
        
        /* Charts Grid */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container h3 { color: #2c3e50; margin-bottom: 15px; font-size: 18px; }
        
        /* Report Sections */
        .report-section { display: none; }
        .report-section.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; backdrop-filter: blur(3px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 0; border-radius: 12px; width: 90%; max-width: 950px; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideDown 0.3s; position: relative; }
        
        /* Bill Details Modal - Slide from right with NO backdrop blur */
        #billModal { 
            z-index: 1100; 
            background-color: transparent; /* No dark backdrop */
            backdrop-filter: none; /* No blur */
            align-items: flex-start; 
            justify-content: flex-end; 
            padding: 20px;
            pointer-events: none; /* Allow clicking through to day bills modal */
        }
        #billModal .modal-content { 
            width: 550px; 
            max-width: 95vw; 
            height: calc(100vh - 40px); 
            max-height: none;
            animation: slideInRight 0.3s; 
            margin: 0;
            pointer-events: all; /* Re-enable pointer events on content */
        }
        
        /* Day Bills Modal - Move to left when bill details is open */
        #dayBillsModal.with-bill-details { 
            justify-content: flex-start; 
            padding-left: 20px;
        }
        #dayBillsModal.with-bill-details .modal-content {
            width: calc(100vw - 620px); /* Take remaining space */
            max-width: 800px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Bill Navigation Arrows */
        .bill-nav { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            background: rgba(255, 255, 255, 0.95); 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            transition: all 0.3s; 
            z-index: 10;
            border: 2px solid #e0e0e0;
        }
        .bill-nav:hover { 
            background: #3498db; 
            color: white; 
            transform: translateY(-50%) scale(1.1); 
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
            border-color: #3498db;
        }
        .bill-nav:active { transform: translateY(-50%) scale(0.95); }
        .bill-nav.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .bill-nav-prev { left: 10px; }  /* Inside modal */
        .bill-nav-next { right: 10px; }  /* Inside modal */
        .bill-nav i { font-size: 18px; }
        
        /* Bill Counter */
        .bill-counter { 
            position: absolute; 
            top: 75px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(52, 152, 219, 0.95); 
            color: white; 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: 600; 
            z-index: 10; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        @keyframes slideDown {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid rgba(255,255,255,0.2); }
        .modal-header h2 { font-size: 18px; margin: 0; display: flex; align-items: center; gap: 8px; }
        .modal-body { padding: 20px; max-height: calc(90vh - 140px); overflow-y: auto; }
        .modal-body::-webkit-scrollbar { width: 6px; }
        .modal-body::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .modal-body::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-footer { padding: 12px 20px; background: #f8f9fa; border-top: 1px solid #e0e0e0; text-align: right; display: flex; gap: 8px; justify-content: flex-end; }
        .close { color: white; font-size: 24px; font-weight: bold; cursor: pointer; transition: all 0.3s; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        
        /* Bill Details in Modal */
        .bill-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .info-item { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 12px; border-radius: 6px; border-left: 3px solid #3498db; transition: all 0.3s; }
        .info-item:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info-item label { font-size: 10px; color: #666; display: block; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .info-item .value { font-size: 14px; font-weight: 700; color: #2c3e50; }
        .info-item.highlight { border-left-color: #27ae60; }
        .info-item.highlight .value { color: #27ae60; font-size: 18px; }
        
        .section-header { margin: 20px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0; display: flex; align-items: center; gap: 8px; }
        .section-header h3 { color: #2c3e50; font-size: 15px; margin: 0; }
        .section-header i { color: #3498db; font-size: 14px; }
        
        .payment-method-tag { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; margin-right: 6px; }
        .payment-cash { background: #d4edda; color: #155724; }
        .payment-upi { background: #d1ecf1; color: #0c5460; }
        .payment-credit { background: #fff3cd; color: #856404; }
        
        /* Compact table for bill items */
        #billModal table { font-size: 12px; }
        #billModal table th { padding: 8px 6px; font-size: 11px; }
        #billModal table td { padding: 8px 6px; }
        #billModal table tfoot td { padding: 10px 6px; font-size: 13px; }
        
        /* Alert */
        .alert { padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .alert-error { background: #fee; color: #c33; border: 1px solid #fcc; }
        .alert-success { background: #efe; color: #3c3; border: 1px solid #cfc; }
        .alert-info { background: #e8f4f8; color: #2980b9; border: 1px solid #3498db; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading i { font-size: 32px; animation: spin 1s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Badge */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .summary-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
        <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <i class="fas fa-toolbox"></i>
                <span>Hardware Store</span>
            </div>
            <div class="navbar-menu">
                <a href="/staff/dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="staff_billing">
                    <i class="fas fa-cash-register"></i>
                    <span>Billing</span>
                </a>
                <a href="inventory">
                    <i class="fas fa-boxes"></i>
                    <span>Inventory</span>
                </a>
                <a href="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </a>
                <a href="reports" class="active">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-chart-line"></i> Reports & Analytics</h1>
            <p>Comprehensive business insights and detailed analysis</p>
        </div>
        
        <div id="alertContainer"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('sales')">
                <i class="fas fa-dollar-sign"></i> Sales Report
            </button>
            <button class="tab" onclick="switchTab('products')">
                <i class="fas fa-box"></i> Product Sales
            </button>
            <button class="tab" onclick="switchTab('stock')">
                <i class="fas fa-warehouse"></i> Stock Report
            </button>
        </div>
        
        <!-- Sales Report -->
        <div id="salesReport" class="report-section active">
            <div class="panel">
                <h2><i class="fas fa-calendar-day"></i> Sales Report</h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Tip:</strong> Click on cards or table rows to view detailed bill information
                </div>
                
                <div class="quick-dates">
                    <button class="quick-date-btn active" onclick="setQuickDate('today')">Today</button>
                    <button class="quick-date-btn" onclick="setQuickDate('yesterday')">Yesterday</button>
                    <button class="quick-date-btn" onclick="setQuickDate('week')">Last 7 Days</button>
                    <button class="quick-date-btn" onclick="setQuickDate('month')">This Month</button>
                    <button class="quick-date-btn" onclick="setQuickDate('lastMonth')">Last Month</button>
                </div>
                
                <div class="filters" style="margin-top: 15px;">
                    <div>
                        <label>From Date:</label>
                        <input type="date" id="salesStartDate">
                    </div>
                    <div>
                        <label>To Date:</label>
                        <input type="date" id="salesEndDate">
                    </div>
                    <button class="btn" onclick="loadSalesReport()">
                        <i class="fas fa-search"></i> Load Report
                    </button>
                </div>
                
                <div id="salesSummary" class="summary-cards">
                    <!-- Summary cards will be populated here -->
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-bar"></i> Daily Sales Trend</h3>
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Payment Method Distribution</h3>
                        <canvas id="paymentMethodChart"></canvas>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>Daily Breakdown</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Total Bills</th>
                                <th>Total Sales</th>
                                <th>Cash</th>
                                <th>UPI</th>
                                <th>Credit</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable">
                            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i> Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Product Report -->
        <div id="productsReport" class="report-section">
            <div class="panel">
                <h2><i class="fas fa-box-open"></i> Product Sales Report</h2>
                
                <div class="quick-dates">
                    <button class="quick-date-btn active" onclick="setProductQuickDate('today')">Today</button>
                    <button class="quick-date-btn" onclick="setProductQuickDate('yesterday')">Yesterday</button>
                    <button class="quick-date-btn" onclick="setProductQuickDate('week')">Last 7 Days</button>
                    <button class="quick-date-btn" onclick="setProductQuickDate('month')">This Month</button>
                    <button class="quick-date-btn" onclick="setProductQuickDate('lastMonth')">Last Month</button>
                </div>
                
                <div class="filters" style="margin-top: 15px;">
                    <div>
                        <label>From Date:</label>
                        <input type="date" id="productStartDate">
                    </div>
                    <div>
                        <label>To Date:</label>
                        <input type="date" id="productEndDate">
                    </div>
                    <button class="btn" onclick="loadProductReport()">
                        <i class="fas fa-search"></i> Load Report
                    </button>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-bar"></i> Top 10 Products by Revenue</h3>
                        <canvas id="topProductsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-line"></i> Top 10 Products by Quantity</h3>
                        <canvas id="topQuantityChart"></canvas>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>Product Details</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Brand</th>
                                <th>Quantity Sold</th>
                                <th>Total Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr><td colspan="4" class="loading"><i class="fas fa-spinner"></i> Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Stock Report -->
        <div id="stockReport" class="report-section">
            <div class="panel">
                <h2><i class="fas fa-warehouse"></i> Stock Report</h2>
                
                <button class="btn" onclick="loadStockReport()">
                    <i class="fas fa-sync"></i> Refresh Stock Report
                </button>
                
                <div class="charts-grid" style="margin-top: 20px;">
                    <div class="chart-container">
                        <h3><i class="fas fa-exclamation-triangle"></i> Low Stock Alert</h3>
                        <canvas id="lowStockChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Stock Status Overview</h3>
                        <canvas id="stockStatusChart"></canvas>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>Stock Details</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Brand</th>
                                <th>Unit</th>
                                <th>Current Stock</th>
                                <th>Low Stock Threshold</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="stockTable">
                            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i> Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bill Details Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <!-- Bill Navigation -->
            <div class="bill-nav bill-nav-prev" id="prevBillBtn" onclick="navigateBill(-1)">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="bill-nav bill-nav-next" id="nextBillBtn" onclick="navigateBill(1)">
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <!-- Bill Counter -->
            <div class="bill-counter" id="billCounter">
                Bill 1 of 10
            </div>
            
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> Bill Details</h2>
                <span class="close" onclick="closeBillModal()">&times;</span>
            </div>
            <div class="modal-body" id="billModalBody">
                <div class="loading"><i class="fas fa-spinner"></i> Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBillModal()"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>
    
    <!-- Day Bills Modal -->
    <div id="dayBillsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dayBillsTitle"><i class="fas fa-list"></i> Bills for Date</h2>
                <span class="close" onclick="closeDayBillsModal()">&times;</span>
            </div>
            <div class="modal-body" id="dayBillsModalBody">
                <div class="loading"><i class="fas fa-spinner"></i> Loading...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDayBillsModal()"><i class="fas fa-times"></i> Close</button>
            </div>
        </div>
    </div>
    
    <script>
        let salesTrendChart = null;
        let paymentMethodChart = null;
        let topProductsChart = null;
        let topQuantityChart = null;
        let lowStockChart = null;
        let stockStatusChart = null;
        let currentSalesData = [];
        
        // Bill navigation variables
        let currentBills = [];
        let currentBillIndex = 0;
        
        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'sales') {
                document.getElementById('salesReport').classList.add('active');
            } else if (tab === 'products') {
                document.getElementById('productsReport').classList.add('active');
            } else if (tab === 'stock') {
                document.getElementById('stockReport').classList.add('active');
                loadStockReport();
            }
        }
        
        // Set quick date ranges
        function setQuickDate(range) {
            const today = new Date();
            let startDate, endDate;
            
            // Remove active class from all buttons
            document.querySelectorAll('.quick-date-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(range) {
                case 'today':
                    startDate = endDate = today;
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = endDate = yesterday;
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 6);
                    endDate = today;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }
            
            document.getElementById('salesStartDate').value = formatDate(startDate);
            document.getElementById('salesEndDate').value = formatDate(endDate);
            
            loadSalesReport();
        }
        
        function setProductQuickDate(range) {
            const today = new Date();
            let startDate, endDate;
            
            // Remove active class from all buttons in product section
            document.querySelectorAll('#productsReport .quick-date-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            switch(range) {
                case 'today':
                    startDate = endDate = today;
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = endDate = yesterday;
                    break;
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 6);
                    endDate = today;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'lastMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
            }
            
            document.getElementById('productStartDate').value = formatDate(startDate);
            document.getElementById('productEndDate').value = formatDate(endDate);
            
            loadProductReport();
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Alert functions
        function showAlert(message, type = 'error') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${message}`;
            
            const container = document.getElementById('alertContainer');
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i> Loading...</td></tr>';
        }
        
        // Load Sales Report
        async function loadSalesReport() {
            const startDate = document.getElementById('salesStartDate').value;
            const endDate = document.getElementById('salesEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates');
                return;
            }
            
            showLoading('salesTable');
            
            try {
                const response = await fetch(`/api/reports/sales?start_date=${startDate}&end_date=${endDate}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch sales report');
                }
                
                const data = await response.json();
                currentSalesData = data;
                
                if (!data || data.length === 0) {
                    document.getElementById('salesTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No sales found for the selected date range</td></tr>';
                    document.getElementById('salesSummary').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">No data available</div>';
                    return;
                }
                
                // Calculate totals
                let totalBills = 0, totalSales = 0, cashSales = 0, upiSales = 0, creditSales = 0;
                
                data.forEach(row => {
                    totalBills += parseInt(row.total_bills) || 0;
                    totalSales += parseFloat(row.total_sales) || 0;
                    cashSales += parseFloat(row.cash_sales) || 0;
                    upiSales += parseFloat(row.upi_sales) || 0;
                    creditSales += parseFloat(row.credit_sales) || 0;
                });
                
                // Update summary cards - Make them clickable
                document.getElementById('salesSummary').innerHTML = `
                    <div class="summary-card" onclick="showAllBills('${startDate}', '${endDate}')">
                        <h4>Total Bills</h4>
                        <div class="value">${totalBills}</div>
                        <div class="subtitle">Click to view all bills</div>
                    </div>
                    <div class="summary-card">
                        <h4>Total Sales</h4>
                        <div class="value">₹${totalSales.toFixed(2)}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Cash Sales</h4>
                        <div class="value">₹${cashSales.toFixed(2)}</div>
                    </div>
                    <div class="summary-card">
                        <h4>UPI Sales</h4>
                        <div class="value">₹${upiSales.toFixed(2)}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Credit Sales</h4>
                        <div class="value">₹${creditSales.toFixed(2)}</div>
                    </div>
                `;
                
                // Populate table - Make rows clickable
                const tbody = document.getElementById('salesTable');
                tbody.innerHTML = data.map(row => `
                    <tr onclick="showDayBills('${row.date}')">
                        <td><strong>${new Date(row.date).toLocaleDateString('en-IN', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}</strong></td>
                        <td><strong>${row.total_bills}</strong> <span class="badge badge-info">Click to view</span></td>
                        <td><strong>₹${parseFloat(row.total_sales).toFixed(2)}</strong></td>
                        <td>₹${parseFloat(row.cash_sales).toFixed(2)}</td>
                        <td>₹${parseFloat(row.upi_sales).toFixed(2)}</td>
                        <td>₹${parseFloat(row.credit_sales).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                // Update charts
                updateSalesTrendChart(data);
                updatePaymentMethodChart(cashSales, upiSales, creditSales);
                
                showAlert('Sales report loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading sales report:', error);
                showAlert('Error loading sales report: ' + error.message);
                document.getElementById('salesTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f44;">Error loading data. Please try again.</td></tr>';
            }
        }
        
        // Update Sales Trend Chart
        function updateSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart');
            
            if (salesTrendChart) {
                salesTrendChart.destroy();
            }
            
            salesTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(row => new Date(row.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Total Sales',
                        data: data.map(row => parseFloat(row.total_sales)),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Update Payment Method Chart
        function updatePaymentMethodChart(cash, upi, credit) {
            const ctx = document.getElementById('paymentMethodChart');
            
            if (paymentMethodChart) {
                paymentMethodChart.destroy();
            }
            
            paymentMethodChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'UPI', 'Credit'],
                    datasets: [{
                        data: [cash, upi, credit],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(241, 196, 15, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Load Product Report
        async function loadProductReport() {
            const startDate = document.getElementById('productStartDate').value;
            const endDate = document.getElementById('productEndDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates');
                return;
            }
            
            showLoading('productsTable');
            
            try {
                const response = await fetch(`/api/reports/products?start_date=${startDate}&end_date=${endDate}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch product report');
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    document.getElementById('productsTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">No product sales found for the selected date range</td></tr>';
                    return;
                }
                
                // Populate table
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = data.map(row => `
                    <tr>
                        <td><strong>${row.product_name}</strong></td>
                        <td>${row.brand || '-'}</td>
                        <td>${parseFloat(row.total_qty_sold).toFixed(2)}</td>
                        <td><strong>₹${parseFloat(row.total_revenue).toFixed(2)}</strong></td>
                    </tr>
                `).join('');
                
                // Update charts (top 10)
                const top10Revenue = data.slice(0, 10);
                const top10Quantity = [...data].sort((a, b) => parseFloat(b.total_qty_sold) - parseFloat(a.total_qty_sold)).slice(0, 10);
                
                updateTopProductsChart(top10Revenue);
                updateTopQuantityChart(top10Quantity);
                
                showAlert('Product report loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading product report:', error);
                showAlert('Error loading product report: ' + error.message);
                document.getElementById('productsTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #f44;">Error loading data. Please try again.</td></tr>';
            }
        }
        
        // Update Top Products Chart
        function updateTopProductsChart(data) {
            const ctx = document.getElementById('topProductsChart');
            
            if (topProductsChart) {
                topProductsChart.destroy();
            }
            
            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(row => row.product_name.substring(0, 20) + (row.product_name.length > 20 ? '...' : '')),
                    datasets: [{
                        label: 'Revenue (₹)',
                        data: data.map(row => parseFloat(row.total_revenue)),
                        backgroundColor: 'rgba(155, 89, 182, 0.8)',
                        borderColor: 'rgba(155, 89, 182, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Update Top Quantity Chart
        function updateTopQuantityChart(data) {
            const ctx = document.getElementById('topQuantityChart');
            
            if (topQuantityChart) {
                topQuantityChart.destroy();
            }
            
            topQuantityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(row => row.product_name.substring(0, 20) + (row.product_name.length > 20 ? '...' : '')),
                    datasets: [{
                        label: 'Quantity Sold',
                        data: data.map(row => parseFloat(row.total_qty_sold)),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Load Stock Report
        async function loadStockReport() {
            showLoading('stockTable');
            
            try {
                const response = await fetch('/api/reports/stock');
                
                if (!response.ok) {
                    throw new Error('Failed to fetch stock report');
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    document.getElementById('stockTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No stock data available</td></tr>';
                    return;
                }
                
                // Populate table
                const tbody = document.getElementById('stockTable');
                tbody.innerHTML = data.map(row => {
                    const isLowStock = parseFloat(row.current_stock) <= parseFloat(row.low_stock_threshold);
                    return `
                        <tr style="${isLowStock ? 'background: #fff3cd;' : ''}">
                            <td><strong>${row.product_name}</strong></td>
                            <td>${row.brand || '-'}</td>
                            <td>${row.unit}</td>
                            <td><strong>${parseFloat(row.current_stock).toFixed(2)}</strong></td>
                            <td>${parseFloat(row.low_stock_threshold).toFixed(2)}</td>
                            <td>
                                ${isLowStock ? 
                                    '<strong style="color: #856404;"><i class="fas fa-exclamation-triangle"></i> Low Stock</strong>' : 
                                    '<span style="color: #155724;"><i class="fas fa-check-circle"></i> In Stock</span>'}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Update stock charts
                updateStockCharts(data);
                
                showAlert('Stock report loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading stock report:', error);
                showAlert('Error loading stock report: ' + error.message);
                document.getElementById('stockTable').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f44;">Error loading data. Please try again.</td></tr>';
            }
        }
        
        // Update Stock Charts
        function updateStockCharts(data) {
            // Low stock chart (top 10 low stock items)
            const lowStockItems = data
                .filter(row => parseFloat(row.current_stock) <= parseFloat(row.low_stock_threshold))
                .slice(0, 10);
            
            const ctx1 = document.getElementById('lowStockChart');
            
            if (lowStockChart) {
                lowStockChart.destroy();
            }
            
            lowStockChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: lowStockItems.map(row => row.product_name.substring(0, 15) + (row.product_name.length > 15 ? '...' : '')),
                    datasets: [{
                        label: 'Current Stock',
                        data: lowStockItems.map(row => parseFloat(row.current_stock)),
                        backgroundColor: 'rgba(231, 76, 60, 0.8)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
            
            // Stock status pie chart
            const lowStockCount = data.filter(row => parseFloat(row.current_stock) <= parseFloat(row.low_stock_threshold)).length;
            const inStockCount = data.length - lowStockCount;
            
            const ctx2 = document.getElementById('stockStatusChart');
            
            if (stockStatusChart) {
                stockStatusChart.destroy();
            }
            
            stockStatusChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['In Stock', 'Low Stock'],
                    datasets: [{
                        data: [inStockCount, lowStockCount],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(231, 76, 60, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Show bills for a specific day
        async function showDayBills(date) {
            event.stopPropagation();
            
            const modal = document.getElementById('dayBillsModal');
            const modalBody = document.getElementById('dayBillsModalBody');
            const title = document.getElementById('dayBillsTitle');
            
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Loading bills...</div>';
            
            const formattedDate = new Date(date).toLocaleDateString('en-IN', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            title.innerHTML = `<i class="fas fa-calendar-day"></i> Bills for ${formattedDate}`;
            
            try {
                const response = await fetch(`/api/reports/bills-by-date?date=${date}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch bills');
                }
                
                const bills = await response.json();
                
                // Store bills globally for navigation
                currentBills = bills;
                
                if (!bills || bills.length === 0) {
                    modalBody.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px;">
                            <i class="fas fa-inbox" style="font-size: 64px; color: #95a5a6; margin-bottom: 20px;"></i>
                            <h3 style="color: #7f8c8d; margin-bottom: 10px;">No Bills Found</h3>
                            <p style="color: #999;">There are no bills for this date</p>
                        </div>
                    `;
                    return;
                }
                
                const totalAmount = bills.reduce((sum, bill) => sum + parseFloat(bill.total_amount), 0);
                
                modalBody.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 3px;">Total Bills</div>
                                <div style="font-size: 28px; font-weight: bold;">${bills.length}</div>
                            </div>
                            <div style="width: 2px; height: 35px; background: rgba(255,255,255,0.3);"></div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 3px;">Total Amount</div>
                                <div style="font-size: 28px; font-weight: bold;">₹${totalAmount.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="margin: 0; font-size: 12px;">
                            <thead>
                                <tr>
                                    <th style="width: 18%; padding: 8px 6px;">Bill No.</th>
                                    <th style="width: 22%; padding: 8px 6px;">Customer</th>
                                    <th style="width: 18%; text-align: right; padding: 8px 6px;">Amount</th>
                                    <th style="width: 20%; padding: 8px 6px;">Payment</th>
                                    <th style="width: 12%; text-align: center; padding: 8px 6px;">Time</th>
                                    <th style="width: 10%; text-align: center; padding: 8px 6px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${bills.map((bill, index) => {
                                    const paymentSplit = JSON.parse(bill.payment_split || '{}');
                                    const paymentMethods = [];
                                    if (paymentSplit.cash > 0) paymentMethods.push('<span class="badge badge-success" style="font-size: 10px; padding: 3px 8px;"><i class="fas fa-money-bill-wave"></i> Cash</span>');
                                    if (paymentSplit.upi > 0) paymentMethods.push('<span class="badge badge-info" style="font-size: 10px; padding: 3px 8px;"><i class="fas fa-mobile-alt"></i> UPI</span>');
                                    if (paymentSplit.credit > 0) paymentMethods.push('<span class="badge badge-warning" style="font-size: 10px; padding: 3px 8px;"><i class="fas fa-credit-card"></i> Credit</span>');
                                    if (paymentSplit.credit_note > 0) paymentMethods.push('<span class="badge badge-warning" style="font-size: 10px; padding: 3px 8px;"><i class="fas fa-credit-card"></i> Credit Note</span>');
                                    
                                    return `
                                        <tr style="background: ${index % 2 === 0 ? '#fff' : '#f8f9fa'};">
                                            <td style="padding: 8px 6px;"><strong style="color: #3498db;">${bill.bill_number}</strong></td>
                                            <td style="padding: 8px 6px;">
                                                <strong>${bill.customer_name || 'Walk-in'}</strong><br>
                                                <small style="color: #7f8c8d; font-size: 10px;">${bill.customer_contact || 'No contact'}</small>
                                            </td>
                                            <td style="text-align: right; padding: 8px 6px;"><strong style="color: #27ae60;">₹${parseFloat(bill.total_amount).toFixed(2)}</strong></td>
                                            <td style="padding: 8px 6px;">${paymentMethods.join(' ')}</td>
                                            <td style="text-align: center; padding: 8px 6px;">
                                                <span class="badge" style="background: #e8f4f8; color: #2980b9; font-size: 10px; padding: 3px 8px;">
                                                    <i class="fas fa-clock"></i> ${new Date(bill.created_at).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}
                                                </span>
                                            </td>
                                            <td style="text-align: center; padding: 8px 6px;">
                                                <button class="btn" style="padding: 5px 10px; font-size: 11px;" onclick="showBillDetailsByIndex(${index})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading day bills:', error);
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 20px;"></i>
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">Error Loading Bills</h3>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Show all bills for date range
        async function showAllBills(startDate, endDate) {
            showDayBills(startDate); // Reuse the same modal for simplicity
            // You can modify this to show all bills between date range if needed
        }
        
        // Show bill details by index (for navigation)
        function showBillDetailsByIndex(index) {
            if (event) event.stopPropagation();
            
            if (!currentBills || currentBills.length === 0) {
                showAlert('No bills available');
                return;
            }
            
            currentBillIndex = index;
            const bill = currentBills[currentBillIndex];
            
            if (!bill) {
                showAlert('Bill not found');
                return;
            }
            
            // Mark day bills modal as having bill details open
            const dayBillsModal = document.getElementById('dayBillsModal');
            dayBillsModal.classList.add('with-bill-details');
            
            // Update navigation buttons
            updateBillNavigation();
            
            // Load bill details
            showBillDetails(bill.bill_id);
        }
        
        // Navigate between bills (left/right arrows)
        function navigateBill(direction) {
            event.stopPropagation();
            
            const newIndex = currentBillIndex + direction;
            
            if (newIndex < 0 || newIndex >= currentBills.length) {
                return; // Can't navigate further
            }
            
            showBillDetailsByIndex(newIndex);
        }
        
        // Update navigation button states
        function updateBillNavigation() {
            const prevBtn = document.getElementById('prevBillBtn');
            const nextBtn = document.getElementById('nextBillBtn');
            const counter = document.getElementById('billCounter');
            
            // Update counter
            counter.textContent = `Bill ${currentBillIndex + 1} of ${currentBills.length}`;
            
            // Update prev button
            if (currentBillIndex === 0) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }
            
            // Update next button
            if (currentBillIndex === currentBills.length - 1) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        }
        
        // Show bill details
        async function showBillDetails(billId) {
            // Prevent event bubbling
            if (event) event.stopPropagation();
            
            const billModal = document.getElementById('billModal');
            const dayBillsModal = document.getElementById('dayBillsModal');
            const modalBody = document.getElementById('billModalBody');
            
            // Optionally hide the day bills modal (uncomment if you want only one modal at a time)
            // dayBillsModal.classList.remove('active');
            
            billModal.classList.add('active');
            modalBody.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Loading bill details...</div>';
            
            try {
                const response = await fetch(`/api/reports/bill-details/${billId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch bill details');
                }
                
                const bill = await response.json();
                const paymentSplit = JSON.parse(bill.payment_split || '{}');
                
                // Create payment method tags
                let paymentTags = '';
                if (paymentSplit.cash > 0) paymentTags += `<span class="payment-method-tag payment-cash"><i class="fas fa-money-bill-wave"></i> Cash: ₹${parseFloat(paymentSplit.cash).toFixed(2)}</span>`;
                if (paymentSplit.upi > 0) paymentTags += `<span class="payment-method-tag payment-upi"><i class="fas fa-mobile-alt"></i> UPI: ₹${parseFloat(paymentSplit.upi).toFixed(2)}</span>`;
                if (paymentSplit.credit > 0) paymentTags += `<span class="payment-method-tag payment-credit"><i class="fas fa-credit-card"></i> Credit: ₹${parseFloat(paymentSplit.credit).toFixed(2)}</span>`;
                if (paymentSplit.credit_note> 0) paymentTags += `<span class="payment-method-tag payment-credit"><i class="fas fa-credit-card"></i> Credit Note: ₹${parseFloat(paymentSplit.credit_note).toFixed(2)}</span>`;
                
                modalBody.innerHTML = `
                    <div class="bill-info">
                        <div class="info-item">
                            <label><i class="fas fa-hashtag"></i> Bill Number</label>
                            <div class="value">${bill.bill_number}</div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-calendar-alt"></i> Date & Time</label>
                            <div class="value">${new Date(bill.created_at).toLocaleString('en-IN', { 
                                day: '2-digit', 
                                month: 'short', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}</div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-user"></i> Customer</label>
                            <div class="value">${bill.customer_name || 'Walk-in'}</div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-phone"></i> Contact</label>
                            <div class="value">${bill.customer_contact || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-user-tie"></i> Billed By</label>
                            <div class="value">${bill.staff_name || 'Staff'}</div>
                        </div>
                        <div class="info-item highlight">
                            <label><i class="fas fa-rupee-sign"></i> Total</label>
                            <div class="value">₹${parseFloat(bill.total_amount).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div class="section-header">
                        <i class="fas fa-wallet"></i>
                        <h3>Payment</h3>
                    </div>
                    <div style="margin-bottom: 15px;">
                        ${paymentTags || '<span style="color: #999; font-size: 12px;">No payment info</span>'}
                    </div>
                    
                    <div class="section-header">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Items</h3>
                    </div>
                    <table style="margin: 0;">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Product</th>
                                <th style="width: 15%; text-align: center;">Qty</th>
                                <th style="width: 20%; text-align: right;">Price</th>
                                <th style="width: 25%; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bill.items.map(item => `
                                <tr>
                                    <td><strong>${item.product_name}</strong></td>
                                    <td style="text-align: center;">${parseFloat(item.quantity).toFixed(1)}</td>
                                    <td style="text-align: right;">₹${parseFloat(item.unit_price).toFixed(2)}</td>
                                    <td style="text-align: right;"><strong>₹${parseFloat(item.total).toFixed(2)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            ${bill.discount_amount > 0 ? `
                                <tr style="background: #fff3cd;">
                                    <td colspan="3" style="text-align: right; font-weight: 600; color: #856404; font-size: 12px;">
                                        <i class="fas fa-tag"></i> Discount:
                                    </td>
                                    <td style="text-align: right; font-weight: 600; color: #856404;">-₹${parseFloat(bill.discount_amount).toFixed(2)}</td>
                                </tr>
                            ` : ''}
                            <tr style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-top: 2px solid #28a745;">
                                <td colspan="3" style="text-align: right; padding: 12px 6px; font-weight: 700; font-size: 14px; color: #155724;">
                                    <i class="fas fa-check-circle"></i> Grand Total:
                                </td>
                                <td style="text-align: right; padding: 12px 6px; font-weight: 700; font-size: 16px; color: #155724;">₹${parseFloat(bill.total_amount).toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    ${bill.notes ? `
                        <div class="section-header" style="margin-top: 15px;">
                            <i class="fas fa-sticky-note"></i>
                            <h3>Notes</h3>
                        </div>
                        <div style="padding: 10px; background: #fff9e6; border-left: 3px solid #ffc107; border-radius: 4px; color: #856404; font-size: 12px;">
                            <i class="fas fa-info-circle"></i> ${bill.notes}
                        </div>
                    ` : ''}
                `;
            } catch (error) {
                console.error('Error loading bill details:', error);
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 20px;"></i>
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">Error Loading Bill Details</h3>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Close modals
        function closeBillModal() {
            event.stopPropagation();
            document.getElementById('billModal').classList.remove('active');
            
            // Remove the with-bill-details class from day bills modal
            const dayBillsModal = document.getElementById('dayBillsModal');
            dayBillsModal.classList.remove('with-bill-details');
        }
        
        function closeDayBillsModal() {
            event.stopPropagation();
            document.getElementById('dayBillsModal').classList.remove('active');
        }
        
        // Close modal on outside click only
        window.onclick = function(event) {
            const billModal = document.getElementById('billModal');
            const dayBillsModal = document.getElementById('dayBillsModal');
            
            // Close bill modal if clicking its backdrop area (but not if clicking through to day bills)
            if (event.target === billModal) {
                billModal.classList.remove('active');
                dayBillsModal.classList.remove('with-bill-details');
            }
            
            // Close day bills modal only if bill modal is not open
            if (event.target === dayBillsModal && !billModal.classList.contains('active')) {
                dayBillsModal.classList.remove('active');
            }
        }
        
        // Prevent modal content clicks from closing modal
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        });
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Set today's date by default
            const today = new Date();
            document.getElementById('salesStartDate').value = formatDate(today);
            document.getElementById('salesEndDate').value = formatDate(today);
            document.getElementById('productStartDate').value = formatDate(today);
            document.getElementById('productEndDate').value = formatDate(today);
            
            // Load today's sales report automatically
            loadSalesReport();
            
            // Add keyboard navigation for bill slider
            document.addEventListener('keydown', function(e) {
                const billModal = document.getElementById('billModal');
                
                // Only if bill modal is open
                if (billModal.classList.contains('active')) {
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        navigateBill(-1);
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        navigateBill(1);
                    } else if (e.key === 'Escape') {
                        closeBillModal();
                    }
                }
            });
        });
    </script>
</body>
</html>