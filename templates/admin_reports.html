<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Hardware Store Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --topbar-height: 60px;
            --primary-color: #4a5568;
            --secondary-color: #718096;
            --accent-color: #2d3748;
            --success-color: #48bb78;
            --danger-color: #e53e3e;
            --warning-color: #ed8936;
            --info-color: #4299e1;
            --bg-color: #f7fafc;
            --card-bg: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --sidebar-bg: #2d3748;
            --sidebar-hover: #4a5568;
            --sidebar-active: #1a202c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            padding: 0;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem 1.25rem;
            background-color: var(--sidebar-active);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-brand {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 0.75rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            color: #cbd5e0;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-link i {
            font-size: 1.25rem;
            width: 24px;
        }

        .nav-link:hover {
            background-color: var(--sidebar-hover);
            color: white;
        }

        .nav-link.active {
            background-color: var(--sidebar-active);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .topbar {
            height: var(--topbar-height);
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .topbar h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .content-wrapper {
            padding: 2rem;
        }

        /* Report Cards */
        .report-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .report-section.analytics {
            background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
            border: 2px solid var(--info-color);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .report-title i {
            font-size: 1.5rem;
            color: var(--info-color);
        }

        /* Date Filters */
        .date-filters {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Buttons */
        .btn-custom {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary-custom {
            background-color: var(--info-color);
            color: white;
        }

        .btn-primary-custom:hover {
            background-color: #3182ce;
            transform: translateY(-1px);
        }

        .btn-success-custom {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success-custom:hover {
            background-color: #38a169;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .summary-card.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .summary-card.warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .summary-card.info {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .summary-card-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .summary-card-value {
            font-size: 2rem;
            font-weight: 700;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table thead {
            background-color: var(--bg-color);
        }

        .report-table th {
            padding: 0.875rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            text-transform: uppercase;
        }

        .report-table td {
            padding: 0.875rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .report-table tbody tr:hover {
            background-color: var(--bg-color);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .chart-empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .chart-empty-state i {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.4;
        }

        .chart-empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 1rem;
        }

        /* Custom Flatpickr Styles */
        .flatpickr-calendar {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .flatpickr-months {
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 1rem 0;
        }

        .flatpickr-current-month {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .flatpickr-day {
            border-radius: 6px;
            font-weight: 500;
        }

        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange {
            background: #8b5cf6 !important;
            border-color: #8b5cf6 !important;
            color: white !important;
        }

        .flatpickr-day.inRange {
            background: #8b5cf6 !important;
            border-color: #8b5cf6 !important;
            color: white !important;
            box-shadow: none;
        }

        .flatpickr-day:hover {
            background: #e9d5ff;
            border-color: #e9d5ff;
        }

        .flatpickr-day.today {
            border-color: #8b5cf6;
        }

        .flatpickr-months .flatpickr-prev-month:hover svg,
        .flatpickr-months .flatpickr-next-month:hover svg {
            fill: #8b5cf6;
        }

        /* Date input styling */
        .date-input-wrapper {
            position: relative;
        }

        .date-input-wrapper i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .date-range-input {
            padding-right: 40px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Chart Styles */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            overflow: hidden;
        }

        .chart-container:last-child {
            margin-bottom: 0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-title i {
            color: var(--info-color);
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            min-height: 250px;
            max-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .chart-wrapper.tall {
            min-height: 400px;
            max-height: 500px;
        }

        .chart-wrapper canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .charts-grid:last-child {
            margin-bottom: 0;
        }

        /* Tab Navigation Styles */
        .tabs-container {
            background: white;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .tabs-nav {
            display: flex;
            background: #f7fafc;
            border-bottom: 2px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tab-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #718096;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #e2e8f0;
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--info-color);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .tab-button i {
            font-size: 1.1rem;
        }

        .tab-content {
            padding: 2rem;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                padding: 0.5rem;
            }
            
            .tab-button {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Bill Details Modal Styles */
        .bill-details-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px 8px 0 0;
            margin: -1rem -1rem 1.5rem -1rem;
        }

        .bill-details-header h5 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .bill-details-header .bill-number {
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .bill-info-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .bill-info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .bill-info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .bill-info-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            letter-spacing: 0.5px;
        }

        .bill-info-value {
            font-size: 1rem;
            font-weight: 500;
            color: #2d3748;
        }

        .payment-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .payment-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-badge.cash {
            background: #d4edda;
            color: #155724;
        }

        .payment-badge.upi {
            background: #d1ecf1;
            color: #0c5460;
        }

        .payment-badge.card {
            background: #cce5ff;
            color: #004085;
        }

        .payment-badge.credit {
            background: #fff3cd;
            color: #856404;
        }

        .items-section {
            margin: 1.5rem 0;
        }

        .items-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .bill-items-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .bill-items-table thead {
            background: #f8f9fa;
        }

        .bill-items-table th {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            border-bottom: 2px solid #e9ecef;
        }

        .bill-items-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #f1f3f5;
            color: #2d3748;
        }

        .bill-items-table tbody tr:last-child td {
            border-bottom: none;
        }

        .bill-items-table tbody tr:hover {
            background: #f8f9fa;
        }

        .bill-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .bill-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.95rem;
        }

        .bill-summary-row:last-child {
            border-bottom: none;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 2px solid #dee2e6;
        }

        .bill-summary-row.total {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2d3748;
        }

        .bill-notes {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1.5rem;
        }

        .bill-notes-label {
            font-weight: 600;
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .bill-notes-text {
            color: #856404;
            margin: 0;
        }

        .modal-footer {
            border-top: 2px solid #e9ecef;
            padding: 1rem 1.5rem;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <i class="bi bi-tools"></i>
                <span>Hardware Admin</span>
            </a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="/admin_dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin/products" class="nav-link">
                    <i class="bi bi-box-seam"></i>
                    <span>Products</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin_inventory" class="nav-link">
                    <i class="bi bi-boxes"></i>
                    <span>Inventory</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin" class="nav-link">
                    <i class="bi bi-shop"></i>
                    <span>Stores & Users</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="/admin/reports" class="nav-link active">
                    <i class="bi bi-graph-up"></i>
                    <span>Reports</span>
                </a>
            </div>
            <div class="nav-item" style="margin-top: auto;">
                <a href="/logout" class="nav-link logout">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <header class="topbar">
            <h1><i class="bi bi-graph-up me-2"></i>Reports & Analytics</h1>
            <div class="user-info">
                <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
                <span>Admin User</span>
            </div>
        </header>

        <!-- Content -->
        <div class="content-wrapper">
            <!-- Global Date Filter -->
            <div class="report-section">
                <div class="report-header">
                    <div class="report-title">
                        <i class="bi bi-calendar-range"></i>
                        Date Range Selection
                    </div>
                </div>
                <div style="background: #e6f7ff; border-left: 4px solid var(--info-color); padding: 1rem; margin-bottom: 1.5rem; border-radius: 6px;">
                    <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                        <i class="bi bi-info-circle me-2" style="color: var(--info-color);"></i>
                        <strong>Quick Start:</strong> The date picker is set to today's date by default. Select your desired date range and store, then click "Generate Reports" to view visual analytics and detailed data tables.
                    </p>
                </div>
                <div class="date-filters">
                    <div class="filter-group">
                        <label><i class="bi bi-calendar-range me-1"></i>Date Range</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="date-range-picker" class="form-control date-range-input" placeholder="Select date range">
                            <i class="bi bi-calendar3"></i>
                        </div>
                        <input type="hidden" id="global-start-date">
                        <input type="hidden" id="global-end-date">
                    </div>
                    <div class="filter-group">
                        <label>Store</label>
                        <select id="global-store" class="form-select">
                            <option value="">All Stores</option>
                        </select>
                    </div>
                    <div style="padding-top: 1.75rem;">
                        <button class="btn-custom btn-primary-custom" onclick="loadAllReports()">
                            <i class="bi bi-search"></i>
                            Generate Reports
                        </button>
                        <button class="btn-custom btn-success-custom" onclick="exportAllReports()">
                            <i class="bi bi-download"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabbed Content -->
            <div class="tabs-container">
                <!-- Tab Navigation -->
                <div class="tabs-nav">
                    <button class="tab-button active" onclick="switchTab('analytics')" id="tab-analytics">
                        <i class="bi bi-graph-up"></i>
                        <span>Visual Analytics</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('sales')" id="tab-sales">
                        <i class="bi bi-cash-stack"></i>
                        <span>Sales Report</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('products')" id="tab-products">
                        <i class="bi bi-box-seam"></i>
                        <span>Product Sales</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('stock')" id="tab-stock">
                        <i class="bi bi-boxes"></i>
                        <span>Stock Report</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('payments')" id="tab-payments">
                        <i class="bi bi-credit-card"></i>
                        <span>Payments</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Visual Analytics Tab -->
                    <div class="tab-pane active" id="pane-analytics">
                        <!-- Summary Cards -->
                        <div class="summary-cards" id="summary-cards" style="margin-bottom: 2rem;">
                            <div class="summary-card">
                                <div class="summary-card-label">Total Sales</div>
                                <div class="summary-card-value">₹<span id="total-sales">0</span></div>
                            </div>
                            <div class="summary-card success">
                                <div class="summary-card-label">Total Bills</div>
                                <div class="summary-card-value"><span id="total-bills">0</span></div>
                            </div>
                            <div class="summary-card warning">
                                <div class="summary-card-label">Products Sold</div>
                                <div class="summary-card-value"><span id="products-sold">0</span></div>
                            </div>
                            <div class="summary-card info">
                                <div class="summary-card-label">Avg Bill Value</div>
                                <div class="summary-card-value">₹<span id="avg-bill">0</span></div>
                            </div>
                        </div>

                        <!-- Sales & Payment Charts -->
                        <div class="charts-grid">
                            <!-- Sales Trend Chart -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <div class="chart-title">
                                        <i class="bi bi-graph-up"></i>
                                        Sales Trend
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="salesTrendChart"></canvas>
                                </div>
                            </div>

                            <!-- Payment Methods Chart -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <div class="chart-title">
                                        <i class="bi bi-credit-card"></i>
                                        Payment Methods Distribution
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="paymentMethodsChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Top Products Chart -->
                        <div class="chart-container">
                            <div class="chart-header">
                                <div class="chart-title">
                                    <i class="bi bi-bar-chart-line"></i>
                                    Top 10 Products by Revenue
                                </div>
                            </div>
                            <div class="chart-wrapper tall">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>

                        <!-- Category & Store Charts -->
                        <div class="charts-grid">
                            <!-- Category Distribution -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <div class="chart-title">
                                        <i class="bi bi-pie-chart"></i>
                                        Category Distribution
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>

                            <!-- Store Performance -->
                            <div class="chart-container">
                                <div class="chart-header">
                                    <div class="chart-title">
                                        <i class="bi bi-shop"></i>
                                        Store Performance Comparison
                                    </div>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="storePerformanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Report Tab -->
                    <div class="tab-pane" id="pane-sales">
                        <div id="sales-report-content">
                            <div class="empty-state">
                                <i class="bi bi-clipboard-data"></i>
                                <p>Select date range and click "Generate Reports" to view sales data</p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Sales Tab -->
                    <div class="tab-pane" id="pane-products">
                        <div id="product-report-content">
                            <div class="empty-state">
                                <i class="bi bi-box"></i>
                                <p>Select date range and click "Generate Reports" to view product sales</p>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Report Tab -->
                    <div class="tab-pane" id="pane-stock">
                        <div id="stock-report-content">
                            <div class="empty-state">
                                <i class="bi bi-archive"></i>
                                <p>Select date range and click "Generate Reports" to view stock levels</p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods Tab -->
                    <div class="tab-pane" id="pane-payments">
                        <div id="payment-report-content">
                            <div class="empty-state">
                                <i class="bi bi-credit-card"></i>
                                <p>Select date range and click "Generate Reports" to view payment details</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Bills List Modal -->
    <div class="modal fade" id="billsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="billsModalTitle">Bills</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="billsModalBody">
                    <!-- Bills list will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Details Modal -->
    <div class="modal fade" id="billDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="billDetailsModalTitle">Bill Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="billDetailsModalBody">
                    <!-- Bill details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="prevBillBtn" onclick="navigateBill('prev')" disabled>
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary" id="nextBillBtn" onclick="navigateBill('next')" disabled>
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        /* ========================================
           INITIALIZATION & DATE PICKER SETUP
           ======================================== */
        
        // Initialize Flatpickr Date Range Picker - Defaults to Today's Date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            
            // Initialize flatpickr with range mode, defaulting to today
            flatpickr("#date-range-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: [today, today],
                showMonths: 2,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        // Format dates as YYYY-MM-DD
                        const startDate = selectedDates[0].toISOString().split('T')[0];
                        const endDate = selectedDates[1].toISOString().split('T')[0];
                        
                        // Update hidden inputs
                        document.getElementById('global-start-date').value = startDate;
                        document.getElementById('global-end-date').value = endDate;
                    }
                },
                onReady: function(selectedDates, dateStr, instance) {
                    // Set initial values for hidden inputs
                    if (selectedDates.length === 2) {
                        const startDate = selectedDates[0].toISOString().split('T')[0];
                        const endDate = selectedDates[1].toISOString().split('T')[0];
                        
                        document.getElementById('global-start-date').value = startDate;
                        document.getElementById('global-end-date').value = endDate;
                    }
                }
            });
            
            loadStores();
            initializeCharts();
        });

        /* ========================================
           CHART INITIALIZATION & CONFIGURATION
           ======================================== */
        
        // Chart instances - stores references to all Chart.js instances
        let charts = {
            salesTrend: null,
            paymentMethods: null,
            topProducts: null,
            category: null,
            storePerformance: null
        };

        // Bill navigation state
        let currentBillsList = [];
        let currentBillIndex = -1;
        let billDetailsModalInstance = null;

        // Initialize all charts with default configurations
        function initializeCharts() {
            // Sales Trend Chart - Line chart showing daily sales progression
            const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
            charts.salesTrend = new Chart(salesTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sales (₹)',
                        data: [],
                        borderColor: 'rgb(66, 153, 225)',
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '₹' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });

            // Payment Methods Chart
            const paymentMethodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
            charts.paymentMethods = new Chart(paymentMethodsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Cash', 'UPI', 'Card', 'Credit'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(72, 187, 120, 0.8)',
                            'rgba(66, 153, 225, 0.8)',
                            'rgba(159, 122, 234, 0.8)',
                            'rgba(237, 137, 54, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return label + ': ₹' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });

            // Top Products Chart
            const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
            charts.topProducts = new Chart(topProductsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgb(102, 126, 234)',
                        borderWidth: 2,
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    indexAxis: 'x',
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return 'Revenue: ₹' + context.parsed.y.toLocaleString('en-IN', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Revenue (₹)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                autoSkip: false,
                                font: {
                                    size: 11
                                },
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 12) {
                                        return label.substring(0, 12) + '...';
                                    }
                                    return label;
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            right: 20,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(72, 187, 120, 0.8)',
                            'rgba(66, 153, 225, 0.8)',
                            'rgba(159, 122, 234, 0.8)',
                            'rgba(237, 137, 54, 0.8)',
                            'rgba(229, 62, 62, 0.8)',
                            'rgba(56, 178, 172, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 10
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });

            // Store Performance Chart
            const storePerformanceCtx = document.getElementById('storePerformanceChart').getContext('2d');
            charts.storePerformance = new Chart(storePerformanceCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Sales (₹)',
                        data: [],
                        backgroundColor: 'rgba(72, 187, 120, 0.8)',
                        borderColor: 'rgb(72, 187, 120)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Sales: ₹' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    }
                }
            });
        }

        /* ========================================
           TAB NAVIGATION
           ======================================== */

        // Switch between tabs
        function switchTab(tabName) {
            // Remove active class from all tabs and panes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            // Add active class to selected tab and pane
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('pane-' + tabName).classList.add('active');
        }

        /* ========================================
           DATA LOADING FUNCTIONS
           ======================================== */

        // Load stores dropdown - Populates store filter with active stores
        async function loadStores() {
            try {
                const response = await fetch('/api/admin/stores');
                const stores = await response.json();
                
                const select = document.getElementById('global-store');
                let html = '<option value="">All Stores</option>';
                stores.forEach(store => {
                    if (store.is_active) {
                        html += `<option value="${store.store_id}">${store.store_name}</option>`;
                    }
                });
                select.innerHTML = html;
            } catch (error) {
                console.error('Error loading stores:', error);
            }
        }

        // Load all reports
        async function loadAllReports() {
            const startDate = document.getElementById('global-start-date').value;
            const endDate = document.getElementById('global-end-date').value;
            const storeId = document.getElementById('global-store').value;
            
            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }
            
            // Show loading
            showLoading();
            
            // Load all reports
            await Promise.all([
                loadSalesReport(startDate, endDate, storeId),
                loadProductReport(startDate, endDate, storeId),
                loadStockReport(storeId),
                loadPaymentReport(startDate, endDate, storeId),
                loadStorePerformance(startDate, endDate)
            ]);
            
            // Update summary
            updateSummary();
        }

        // Load store performance for chart
        async function loadStorePerformance(startDate, endDate) {
            try {
                // If a specific store is selected, don't show store comparison
                const storeId = document.getElementById('global-store').value;
                if (storeId) {
                    charts.storePerformance.data.labels = ['Selected Store'];
                    charts.storePerformance.data.datasets[0].data = [0];
                    charts.storePerformance.update();
                    return;
                }

                let url = `/api/admin/reports/sales?start_date=${startDate}&end_date=${endDate}`;
                const response = await fetch(url);
                const data = await response.json();
                
                // Group by store if we have store information
                const storeResponse = await fetch('/api/admin/stores');
                const stores = await storeResponse.json();
                
                const storePerformance = {};
                
                // Initialize all stores
                stores.forEach(store => {
                    if (store.is_active) {
                        storePerformance[store.store_name] = 0;
                    }
                });
                
                // Aggregate sales by store (if store info is available in sales data)
                // This is a placeholder - adjust based on your actual API structure
                for (const store of stores) {
                    if (store.is_active) {
                        try {
                            let storeUrl = `/api/admin/reports/sales?start_date=${startDate}&end_date=${endDate}&store_id=${store.store_id}`;
                            const storeResponse = await fetch(storeUrl);
                            const storeData = await storeResponse.json();
                            const totalSales = storeData.reduce((sum, day) => sum + parseFloat(day.total_sales || 0), 0);
                            storePerformance[store.store_name] = totalSales;
                        } catch (err) {
                            console.error(`Error loading data for store ${store.store_name}:`, err);
                        }
                    }
                }
                
                const storeLabels = Object.keys(storePerformance);
                const storeValues = Object.values(storePerformance);
                
                charts.storePerformance.data.labels = storeLabels;
                charts.storePerformance.data.datasets[0].data = storeValues;
                charts.storePerformance.update();
                
            } catch (error) {
                console.error('Error loading store performance:', error);
            }
        }

        // Show loading state
        function showLoading() {
            const loadingHtml = '<div class="loading"><i class="bi bi-arrow-repeat"></i><p>Loading data...</p></div>';
            document.getElementById('sales-report-content').innerHTML = loadingHtml;
            document.getElementById('product-report-content').innerHTML = loadingHtml;
            document.getElementById('stock-report-content').innerHTML = loadingHtml;
            document.getElementById('payment-report-content').innerHTML = loadingHtml;
        }

        // Load sales report
        async function loadSalesReport(startDate, endDate, storeId) {
            try {
                let url = `/api/admin/reports/sales?start_date=${startDate}&end_date=${endDate}`;
                if (storeId) url += `&store_id=${storeId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('sales-report-content').innerHTML = 
                        '<div class="empty-state"><i class="bi bi-clipboard-data"></i><p>No sales data found for selected period</p></div>';
                    return;
                }
                
                // Update Sales Trend Chart
                const labels = [];
                const salesData = [];
                const paymentData = { cash: 0, upi: 0, card: 0, credit: 0 };
                
                data.forEach(row => {
                    labels.push(new Date(row.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }));
                    salesData.push(parseFloat(row.total_sales));
                    paymentData.cash += parseFloat(row.cash_sales || 0);
                    paymentData.upi += parseFloat(row.upi_sales || 0);
                    paymentData.card += parseFloat(row.card_sales || 0);
                    paymentData.credit += parseFloat(row.credit_sales || 0);
                });
                
                charts.salesTrend.data.labels = labels;
                charts.salesTrend.data.datasets[0].data = salesData;
                charts.salesTrend.update();
                
                // Update Payment Methods Chart
                charts.paymentMethods.data.datasets[0].data = [
                    paymentData.cash,
                    paymentData.upi,
                    paymentData.card,
                    paymentData.credit
                ];
                charts.paymentMethods.update();
                
                let html = `
                    <div class="table-responsive">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total Bills</th>
                                    <th>Total Sales</th>
                                    <th>Cash</th>
                                    <th>UPI</th>
                                    <th>Credit</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(row => {
                    const formattedDate = new Date(row.date).toLocaleDateString('en-GB');
                    html += `
                        <tr>
                            <td>
                                <a href="javascript:void(0)" 
                                   onclick="showBillsByDate('${row.date}')" 
                                   style="color: var(--info-color); text-decoration: underline; cursor: pointer; font-weight: 600;">
                                    ${formattedDate}
                                </a>
                            </td>
                            <td>${row.total_bills}</td>
                            <td>₹${parseFloat(row.total_sales).toFixed(2)}</td>
                            <td>₹${parseFloat(row.cash_sales || 0).toFixed(2)}</td>
                            <td>₹${parseFloat(row.upi_sales || 0).toFixed(2)}</td>
                            <td>₹${parseFloat(row.credit_sales || 0).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('sales-report-content').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading sales report:', error);
                document.getElementById('sales-report-content').innerHTML = 
                    '<div class="empty-state text-danger"><i class="bi bi-exclamation-circle"></i><p>Error loading sales report</p></div>';
            }
        }

        // Load product report
        async function loadProductReport(startDate, endDate, storeId) {
            try {
                let url = `/api/admin/reports/products?start_date=${startDate}&end_date=${endDate}`;
                if (storeId) url += `&store_id=${storeId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('product-report-content').innerHTML = 
                        '<div class="empty-state"><i class="bi bi-box"></i><p>No product sales data found</p></div>';
                    return;
                }
                
                // Update Top Products Chart (top 10)
                const top10 = data.slice(0, 10);
                const productLabels = top10.map(p => p.product_name);
                const productRevenue = top10.map(p => parseFloat(p.total_revenue));
                
                charts.topProducts.data.labels = productLabels;
                charts.topProducts.data.datasets[0].data = productRevenue;
                charts.topProducts.update();
                
                // Update Category Chart
                const categoryData = {};
                data.forEach(row => {
                    const category = row.category || 'Uncategorized';
                    if (!categoryData[category]) {
                        categoryData[category] = 0;
                    }
                    categoryData[category] += parseFloat(row.total_revenue);
                });
                
                const categoryLabels = Object.keys(categoryData);
                const categoryValues = Object.values(categoryData);
                
                charts.category.data.labels = categoryLabels;
                charts.category.data.datasets[0].data = categoryValues;
                charts.category.update();
                
                let html = `
                    <div class="table-responsive">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Quantity Sold</th>
                                    <th>Total Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(row => {
                    html += `
                        <tr>
                            <td>${row.product_name}</td>
                            <td>${row.brand || 'N/A'}</td>
                            <td>${row.category || 'N/A'}</td>
                            <td>${parseFloat(row.total_quantity).toFixed(2)}</td>
                            <td>₹${parseFloat(row.total_revenue).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('product-report-content').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading product report:', error);
                document.getElementById('product-report-content').innerHTML = 
                    '<div class="empty-state text-danger"><i class="bi bi-exclamation-circle"></i><p>Error loading product report</p></div>';
            }
        }

        // Load stock report
        async function loadStockReport(storeId) {
            try {
                let url = '/api/admin/reports/stock';
                if (storeId) url += `?store_id=${storeId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.length === 0) {
                    document.getElementById('stock-report-content').innerHTML = 
                        '<div class="empty-state"><i class="bi bi-archive"></i><p>No stock data found</p></div>';
                    return;
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>Store</th>
                                    <th>Current Stock</th>
                                    <th>Min Level</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.forEach(row => {
                    const qty = parseFloat(row.quantity || 0);
                    const minLevel = parseFloat(row.min_stock_level || 0);
                    const status = qty <= minLevel ? 
                        '<span style="color: var(--danger-color); font-weight: 600;">Low Stock</span>' : 
                        '<span style="color: var(--success-color); font-weight: 600;">OK</span>';
                    
                    html += `
                        <tr>
                            <td>${row.product_name}</td>
                            <td>${row.brand || 'N/A'}</td>
                            <td>${row.category || 'N/A'}</td>
                            <td>${row.store_name}</td>
                            <td>${qty.toFixed(2)}</td>
                            <td>${minLevel.toFixed(2)}</td>
                            <td>${status}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('stock-report-content').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading stock report:', error);
                document.getElementById('stock-report-content').innerHTML = 
                    '<div class="empty-state text-danger"><i class="bi bi-exclamation-circle"></i><p>Error loading stock report</p></div>';
            }
        }

        // Load payment methods report
        async function loadPaymentReport(startDate, endDate, storeId) {
            try {
                let url = `/api/admin/reports/sales?start_date=${startDate}&end_date=${endDate}`;
                if (storeId) url += `&store_id=${storeId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Aggregate payment data
                let totalCash = 0, totalUPI = 0, totalCredit = 0;
                data.forEach(row => {
                    totalCash += parseFloat(row.cash_sales || 0);
                    totalUPI += parseFloat(row.upi_sales || 0);
                    totalCredit += parseFloat(row.credit_sales || 0);
                });
                
                const total = totalCash + totalUPI + totalCredit;
                
                let html = `
                    <div class="summary-cards">
                        <div class="summary-card success">
                            <div class="summary-card-label">Cash Payments</div>
                            <div class="summary-card-value">₹${totalCash.toFixed(2)}</div>
                            <small>${total > 0 ? ((totalCash / total) * 100).toFixed(1) : 0}% of total</small>
                        </div>
                        <div class="summary-card info">
                            <div class="summary-card-label">UPI Payments</div>
                            <div class="summary-card-value">₹${totalUPI.toFixed(2)}</div>
                            <small>${total > 0 ? ((totalUPI / total) * 100).toFixed(1) : 0}% of total</small>
                        </div>
                        <div class="summary-card warning">
                            <div class="summary-card-label">Credit Sales</div>
                            <div class="summary-card-value">₹${totalCredit.toFixed(2)}</div>
                            <small>${total > 0 ? ((totalCredit / total) * 100).toFixed(1) : 0}% of total</small>
                        </div>
                    </div>
                `;
                
                document.getElementById('payment-report-content').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading payment report:', error);
                document.getElementById('payment-report-content').innerHTML = 
                    '<div class="empty-state text-danger"><i class="bi bi-exclamation-circle"></i><p>Error loading payment report</p></div>';
            }
        }

        // Update summary cards
        async function updateSummary() {
            try {
                const startDate = document.getElementById('global-start-date').value;
                const endDate = document.getElementById('global-end-date').value;
                const storeId = document.getElementById('global-store').value;
                
                let url = `/api/admin/reports/sales?start_date=${startDate}&end_date=${endDate}`;
                if (storeId) url += `&store_id=${storeId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                let totalSales = 0, totalBills = 0;
                data.forEach(row => {
                    totalSales += parseFloat(row.total_sales || 0);
                    totalBills += parseInt(row.total_bills || 0);
                });
                
                // Get product count
                let productUrl = `/api/admin/reports/products?start_date=${startDate}&end_date=${endDate}`;
                if (storeId) productUrl += `&store_id=${storeId}`;
                const productResponse = await fetch(productUrl);
                const productData = await productResponse.json();
                const productsSold = productData.length;
                
                const avgBill = totalBills > 0 ? totalSales / totalBills : 0;
                
                document.getElementById('total-sales').textContent = totalSales.toFixed(2);
                document.getElementById('total-bills').textContent = totalBills;
                document.getElementById('products-sold').textContent = productsSold;
                document.getElementById('avg-bill').textContent = avgBill.toFixed(2);
                
            } catch (error) {
                console.error('Error updating summary:', error);
            }
        }

        // Export all reports (placeholder)
        function exportAllReports() {
            alert('Export functionality will download all reports as Excel/PDF');
            // TODO: Implement actual export
        }

        // Show bills for a specific date
        async function showBillsByDate(date) {
            try {
                const storeId = document.getElementById('global-store').value;
                let url = `/api/admin/reports/bills-by-date?date=${date}`;
                if (storeId) url += `&store_id=${storeId}`;
                
                const response = await fetch(url);
                const bills = await response.json();
                
                // Store bills for navigation
                currentBillsList = bills;
                
                const modal = new bootstrap.Modal(document.getElementById('billsModal'));
                document.getElementById('billsModalTitle').textContent = `Bills for ${new Date(date).toLocaleDateString('en-GB')}`;
                
                if (bills.length === 0) {
                    document.getElementById('billsModalBody').innerHTML = 
                        '<div class="empty-state"><i class="bi bi-receipt"></i><p>No bills found for this date</p></div>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Bill #</th>
                                        <th>Customer</th>
                                        <th>Contact</th>
                                        <th>Amount</th>
                                        <th>Time</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    bills.forEach((bill, index) => {
                        const time = new Date(bill.created_at).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        html += `
                            <tr>
                                <td><strong>${bill.bill_number}</strong></td>
                                <td>${bill.customer_name || 'Walk-in'}</td>
                                <td>${bill.customer_contact || '-'}</td>
                                <td><strong>₹${parseFloat(bill.total_amount).toFixed(2)}</strong></td>
                                <td>${time}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="showBillDetails(${bill.bill_id}, ${index})">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    document.getElementById('billsModalBody').innerHTML = html;
                }
                
                modal.show();
                
            } catch (error) {
                console.error('Error loading bills:', error);
                alert('Error loading bills for this date');
            }
        }

        // Show bill details
        async function showBillDetails(billId, billIndex = -1) {
            try {
                // Set current index for navigation
                currentBillIndex = billIndex;
                
                const response = await fetch(`/api/admin/reports/bill-details/${billId}`);
                const bill = await response.json();
                
                if (bill.error) {
                    alert('Error loading bill details');
                    return;
                }
                
                // Initialize modal instance only once
                if (!billDetailsModalInstance) {
                    billDetailsModalInstance = new bootstrap.Modal(document.getElementById('billDetailsModal'));
                }
                
                document.getElementById('billDetailsModalTitle').textContent = 'Bill Details';
                
                // Update navigation buttons
                updateNavigationButtons();
                
                // Parse payment split
                let paymentHtml = '';
                if (bill.payment_split) {
                    const payments = typeof bill.payment_split === 'string' ? JSON.parse(bill.payment_split) : bill.payment_split;
                    if (payments.cash && payments.cash > 0) {
                        paymentHtml += `<div class="payment-badge cash"><i class="bi bi-cash-coin"></i> Cash: ₹${parseFloat(payments.cash).toFixed(2)}</div>`;
                    }
                    if (payments.upi && payments.upi > 0) {
                        paymentHtml += `<div class="payment-badge upi"><i class="bi bi-phone"></i> UPI: ₹${parseFloat(payments.upi).toFixed(2)}</div>`;
                    }
                    if (payments.card && payments.card > 0) {
                        paymentHtml += `<div class="payment-badge card"><i class="bi bi-credit-card"></i> Card: ₹${parseFloat(payments.card).toFixed(2)}</div>`;
                    }
                    if (payments.credit && payments.credit > 0) {
                        paymentHtml += `<div class="payment-badge credit"><i class="bi bi-wallet2"></i> Credit: ₹${parseFloat(payments.credit).toFixed(2)}</div>`;
                    }
                }
                
                const billDate = new Date(bill.created_at);
                const formattedDate = billDate.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                const formattedTime = billDate.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let html = `
                    <div class="bill-details-header">
                        <h5><i class="bi bi-receipt"></i> ${bill.bill_number}</h5>
                        <div class="bill-number">${formattedDate} at ${formattedTime}</div>
                    </div>
                    
                    <div class="bill-info-card">
                        <div class="bill-info-row">
                            <div class="bill-info-item">
                                <div class="bill-info-label"><i class="bi bi-person"></i> Customer</div>
                                <div class="bill-info-value">${bill.customer_name || 'Walk-in Customer'}</div>
                            </div>
                            <div class="bill-info-item">
                                <div class="bill-info-label"><i class="bi bi-telephone"></i> Contact</div>
                                <div class="bill-info-value">${bill.customer_contact || 'N/A'}</div>
                            </div>
                            <div class="bill-info-item">
                                <div class="bill-info-label"><i class="bi bi-person-badge"></i> Staff</div>
                                <div class="bill-info-value">${bill.staff_name || 'N/A'}</div>
                            </div>
                        </div>
                        
                        ${paymentHtml ? `
                        <div class="bill-info-item" style="margin-top: 1rem;">
                            <div class="bill-info-label"><i class="bi bi-credit-card"></i> Payment Methods</div>
                            <div class="payment-badges" style="margin-top: 0.5rem;">
                                ${paymentHtml}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="items-section">
                        <div class="items-header">
                            <i class="bi bi-box-seam"></i> Items (${bill.items.length})
                        </div>
                        <div class="table-responsive">
                            <table class="bill-items-table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th style="text-align: center;">Qty</th>
                                        <th style="text-align: right;">Price</th>
                                        <th style="text-align: right;">Discount</th>
                                        <th style="text-align: right;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                bill.items.forEach((item, index) => {
                    html += `
                        <tr>
                            <td>
                                <div style="font-weight: 500;">${item.product_name}</div>
                                ${item.product_brand ? `<div style="font-size: 0.85rem; color: #6c757d;">${item.product_brand}</div>` : ''}
                            </td>
                            <td style="text-align: center;">${parseFloat(item.quantity).toFixed(2)}</td>
                            <td style="text-align: right;">₹${parseFloat(item.unit_price).toFixed(2)}</td>
                            <td style="text-align: right; color: ${parseFloat(item.item_discount || 0) > 0 ? '#dc3545' : '#6c757d'};">
                                ${parseFloat(item.item_discount || 0) > 0 ? '-' : ''}₹${parseFloat(item.item_discount || 0).toFixed(2)}
                            </td>
                            <td style="text-align: right; font-weight: 600;">₹${parseFloat(item.total).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bill-summary">
                        <div class="bill-summary-row">
                            <span>Subtotal</span>
                            <span>₹${parseFloat(bill.subtotal).toFixed(2)}</span>
                        </div>
                        <div class="bill-summary-row" style="color: ${parseFloat(bill.discount_amount || 0) > 0 ? '#dc3545' : '#6c757d'};">
                            <span>Discount</span>
                            <span>${parseFloat(bill.discount_amount || 0) > 0 ? '-' : ''}₹${parseFloat(bill.discount_amount || 0).toFixed(2)}</span>
                        </div>
                        <div class="bill-summary-row total">
                            <span>Total Amount</span>
                            <span>₹${parseFloat(bill.total_amount).toFixed(2)}</span>
                        </div>
                    </div>
                `;
                
                if (bill.notes) {
                    html += `
                        <div class="bill-notes">
                            <div class="bill-notes-label"><i class="bi bi-sticky"></i> Notes</div>
                            <p class="bill-notes-text">${bill.notes}</p>
                        </div>
                    `;
                }
                
                document.getElementById('billDetailsModalBody').innerHTML = html;
                
                // Only show modal if it's not already visible
                const modalElement = document.getElementById('billDetailsModal');
                if (!modalElement.classList.contains('show')) {
                    billDetailsModalInstance.show();
                }
                
            } catch (error) {
                console.error('Error loading bill details:', error);
                alert('Error loading bill details');
            }
        }

        // Update navigation button states
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBillBtn');
            const nextBtn = document.getElementById('nextBillBtn');
            
            // If no bills list or index not set, disable both
            if (currentBillsList.length === 0 || currentBillIndex === -1) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            // Enable/disable based on position in list
            prevBtn.disabled = currentBillIndex <= 0;
            nextBtn.disabled = currentBillIndex >= currentBillsList.length - 1;
        }

        // Navigate between bills
        function navigateBill(direction) {
            if (currentBillsList.length === 0 || currentBillIndex === -1) {
                return;
            }
            
            let newIndex = currentBillIndex;
            
            if (direction === 'prev' && currentBillIndex > 0) {
                newIndex = currentBillIndex - 1;
            } else if (direction === 'next' && currentBillIndex < currentBillsList.length - 1) {
                newIndex = currentBillIndex + 1;
            } else {
                return; // No navigation needed
            }
            
            // Get the bill ID from the list
            const bill = currentBillsList[newIndex];
            showBillDetails(bill.bill_id, newIndex);
        }
    </script>
</body>
</html>