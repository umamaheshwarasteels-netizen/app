<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Billing System - Hardware Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #4F46E5;
            --primary-light: #6366F1;
            --primary-dark: #4338CA;
            --success-color: #059669;
            --success-light: #10B981;
            --warning-color: #D97706;
            --warning-light: #F59E0B;
            --danger-color: #DC2626;
            --danger-light: #EF4444;
            --info-color: #7C3AED;
            --dark-bg: #0F172A;
            --dark-bg-light: #1E293B;
            --light-bg: #F8FAFC;
            --white: #FFFFFF;
            --border-color: #E2E8F0;
            --border-color-light: #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-tertiary: #94A3B8;
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #EFF6FF 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Navbar Styles */
        .navbar {
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            color: white;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 32px;
            height: 72px;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .navbar-brand i {
            font-size: 28px;
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .navbar-menu {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .navbar-menu a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .navbar-menu a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-light), var(--info-color));
            transition: width 0.3s ease;
        }
        
        .navbar-menu a:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }
        
        .navbar-menu a.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .navbar-menu a i {
            font-size: 16px;
        }
        
        /* Layout Wrapper */
        .layout-wrapper {
            display: flex;
            
            
            min-height: calc(100vh - 70px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
        }
        
        .sidebar-menu {
            display: flex;
            flex-direction: column;
            list-style: none;
        }
        
        .sidebar-menu li {
            margin: 0;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-weight: 500;
            font-size: 14px;
        }
        
        .sidebar-menu a:hover {
            background: var(--light-gray);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }
        
        .sidebar-menu a.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
            border-left-color: var(--primary-color);
        }
        
        .sidebar-menu i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: var(--light-gray);
        }
        
        /* Section Container */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        /* Panel Styles */
        .panel {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            box-shadow: var(--shadow-md);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .panel-header i {
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .panel-header h2 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.3px;
        }
        
        /* Alert Messages */
        #alertMessage {
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            animation: slideDown 0.3s ease;
            box-shadow: var(--shadow-md);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .alert i {
            font-size: 20px;
        }
        
        /* Form Elements */
        .form-section {
            margin-bottom: 10px;
        }
        
        .form-section-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 14px;
        }
        
        .form-section-label i {
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            width: 100%;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea,
        .form-section input[type="text"],
        .input-group select,
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            color: var(--text-primary);
        }
        
        .form-group select,
        .input-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .form-section input[type="text"]:focus,
        .input-group select:focus,
        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder,
        .form-section input[type="text"]::placeholder,
        .input-group input::placeholder {
            color: #a0aec0;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            text-decoration: none;
            box-shadow: var(--shadow-sm);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-outline-primary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .btn-outline-primary:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-outline-primary.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Billing Grid */
        .billing-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 25px;
        }
        
        /* Product List Items */
        #productList {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            width: 100%;
            gap: 12px;
        }
        
        .product-item {
            background: white;
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            min-height: 120px;
            gap: 8px;
        }
        
        .product-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        
        .product-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 22px;
            color: white;
        }
        
        .product-item-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 2px;
            line-height: 1.3;
        }
        
        .product-item-brand {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .product-item-rate {
            font-size: 14px;
            font-weight: 600;
            color: var(--success-color);
            margin-top: auto;
        }
        
        .product-item-stock {
            position: static;
            margin-top: auto;
        }
        
        /* Badge */
        .badge {
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-info {
            background: #ddd6fe;
            color: #5b21b6;
        }
        
        .badge-primary {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-dark);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .badge-gray {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        /* Cart Items */
        .cart-item {
            background: var(--light-gray);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1.5px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .cart-item:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .cart-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }
        
        .cart-item-details {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            width: 100%;
            gap: 10px;
            margin-top: 10px;
        }
        
        .cart-item-details label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }
        
        .cart-item-details input {
            padding: 10px 12px;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            width: 100%;
        }
        
        .cart-item-details input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Summary */
        .summary-line {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 15px;
        }
        
        .summary-line.total {
            border-top: 2px solid var(--text-primary);
            border-bottom: none;
            font-size: 18px;
            font-weight: 700;
            padding: 16px 0 0 0;
            margin-top: 8px;
        }
        
        /* Payment Split */
        .payment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .payment-item.active {
            background: rgba(99, 102, 241, 0.05);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-sm);
        }
        
        .payment-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: var(--primary-color);
        }
        
        .payment-item i {
            flex-shrink: 0;
            font-size: 20px;
        }
        
        .payment-item label {
            flex: 1;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-primary);
            margin: 0;
        }
        
        .payment-item input[type="number"] {
            width: 130px;
            padding: 10px 12px;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-align: right;
            flex-shrink: 0;
        }
        
        .payment-item input[type="number"]:disabled {
            background: var(--light-gray);
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .payment-item input[type="number"]:not(:disabled) {
            background: white;
            border-color: var(--primary-color);
        }
        
        .payment-item input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 18px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }
        
        .stat-icon.red {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }
        
        .stat-icon.purple {
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
        }
        
        .stat-icon.green {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
        }
        
        .stat-details h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .stat-details p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: var(--light-gray);
        }
        
        thead th {
            padding: 16px 18px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        tbody td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: var(--light-gray);
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal[style*="display: block"] {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: scale(0.95) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        .modal-header i {
            font-size: 22px;
        }
        
        .modal-body {
            padding: 28px;
        }
        
        .close {
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.9;
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }
        
        
        /* Add to Cart Modal Specific Styles */
        .modal.show {
            display: flex;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-header h3 {
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-product-info {
            background: var(--light-gray);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .modal-product-info h4 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .modal-product-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .modal-form-group {
            margin-bottom: 20px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .modal-form-group label i {
            color: var(--primary-color);
            margin-right: 6px;
        }

        .modal-form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .modal-form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--light-gray);
            border-radius: 0 0 16px 16px;
        }

        .modal-footer .btn {
            min-width: 120px;
        }

        /* Customer Button Styles */
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-sm i {
            font-size: 12px;
        }

        /* Cart Items Container with Scroll */
        .cart-items-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 15px;
        }

        .cart-items-container::-webkit-scrollbar {
            width: 6px;
        }

        .cart-items-container::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        .cart-items-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 10px;
        }

        .cart-items-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Cart Item Row Layout */
        .cart-item-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 0.8fr 1fr 0.8fr 0.5fr;
            gap: 12px;
            padding: 12px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 8px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .cart-item-row:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-color);
        }

        .cart-item-info {
            display: flex;
            flex-direction: column;
        }

        .cart-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .cart-item-brand {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .cart-item-field {
            display: flex;
            flex-direction: column;
        }

        .cart-item-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cart-item-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .cart-item-total {
            font-size: 15px;
            color: var(--success-color);
            font-weight: 700;
        }

        .cart-item-remove {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-item-remove button {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-item-remove button:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .cart-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .cart-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Compact Cart Item Layout */
        .cart-item-compact {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .cart-item-compact:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .cart-item-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .cart-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .cart-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .btn-edit {
            background: var(--primary-color);
            color: white;
        }

        .btn-edit:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .cart-item-details-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 14px;
        }

        .cart-detail-item {
            color: var(--text-secondary);
        }

        .cart-detail-item strong {
            color: var(--text-primary);
            margin-right: 4px;
        }

        .cart-total-highlight {
            color: var(--success-color);
            font-weight: 600;
            font-size: 15px;
        }

        .cart-total-highlight strong {
            color: var(--success-color);
        }

        /* Adjust container height to show approximately 2 items */
        .cart-items-container {
            max-height: 280px;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 15px;
        }
        
        
        /* Filters */
        .filters {
            background: white;
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 10px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 11px 14px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Product Grid for Quotations */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        
        .product-card {
            background: white;
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 6px;
            min-height: 120px;
        }
        
        .product-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        
        .product-card.selected {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
            box-shadow: var(--shadow-sm);
        }
        
        /* Selected Items for Quotations */
        .item-card {
            background: var(--light-gray);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1.5px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .item-card:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        
        .item-inputs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            width: 100%;
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-inputs label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
        }
        
        .item-inputs input {
            padding: 10px 12px;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            width: 100%;
        }
        
        .item-inputs input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .billing-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                width: 200px;
            }
        }
        
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 20px;
            }
            
            .layout-wrapper {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .sidebar-menu {
            display: flex;
            flex-direction: column;
                display: flex;
                overflow-x: auto;
            }
            
            .sidebar-menu li {
                flex-shrink: 0;
            }
            
            .main-content {
                padding: 12px;
            }
            
            #productList {
                grid-template-columns: repeat(5, 1fr);
            width: 100%;
                gap: 12px;
            }
            
            .products-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .panel {
                padding: 12px;
            }
        }
        
        /* Hide elements */
        .hidden {
            display: none !important;
        }
    
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-icon.red {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
        }
        
        .stat-icon.purple {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stat-icon.green {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            color: white;
        }
        
        .stat-details h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-details p {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            overflow: hidden;
        }
        
        @keyframes slideIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-header i {
            font-size: 22px;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close {
            color: white;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.9;
        }
        
        .close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        
        /* Billing Grid */
        .billing-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 25px;
        }
        
        /* Product Selection Full Width Panel */
        .panel .panel-header h2 {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel .panel-header h2::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-radius: 4px;
            display: inline-block;
        }
        
        /* Form Section - Compact Style */
        .form-section {
            margin-bottom: 10px;
            padding: 0;
            background: transparent;
            border: none;
        }
        
        .form-section > * {
            margin-bottom: 0;
        }
        
        /* Cart Items */
        .cart-item {
            background: var(--light-gray);
            padding: 28px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .cart-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .cart-item-details {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            width: 100%;
            gap: 10px;
            margin-top: 10px;
        }
        
        .cart-item-details input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
        }
        
        /* Payment Split */
        .payment-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 28px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .payment-item.active {
            background: rgba(99, 102, 241, 0.05);
            border-color: var(--primary-color);
        }
        
        .payment-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .payment-item i {
            flex-shrink: 0;
        }
        
        .payment-item label {
            flex: 1;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            color: var(--text-primary);
            margin: 0;
        }
        
        .payment-item input[type="number"] {
            width: 120px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            text-align: right;
            flex-shrink: 0;
        }
        
        .payment-item input[type="number"]:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .payment-item input[type="number"]:not(:disabled) {
            background: white;
            border-color: var(--primary-color);
        }
        
        .payment-item input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Summary */
        .summary-line {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .summary-line.total {
            border-top: 2px solid var(--text-primary);
            border-bottom: none;
            font-size: 18px;
            font-weight: 700;
            padding: 15px 0 0 0;
        }
        
        /* Product Grid for Quotations */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        
        .product-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
        }
        
        .product-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }
        
        .product-card.selected {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
        }
        
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .sidebar-menu {
            display: flex;
            flex-direction: column;
                display: flex;
                overflow-x: auto;
            }
            
            .sidebar-menu li {
                flex-shrink: 0;
            }
            
            .products-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        /* Hide elements */
        .hidden {
            display: none !important;
        }
        
        /* Filter Section */
        .filters {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
            background: white;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Selected Items Container for Quotations */
        .selected-section {
            background: white;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }
        
        .item-card {
            background: var(--light-gray);
            padding: 28px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .item-inputs {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            width: 100%;
            gap: 10px;
            margin-top: 10px;
        }
        
        .item-inputs input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Top Navbar -->
        <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <i class="fas fa-hammer"></i>
                <span>Hardware Store</span>
            </div>
            <div class="navbar-menu">
                <a href="/staff/dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/staff_billing" class="active">
                    <i class="fas fa-cash-register"></i>
                    <span>Billing</span>
                </a>
                <a href="/inventory">
                    <i class="fas fa-boxes"></i>
                    <span>Inventory</span>
                </a>
                <a href="/customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </a>
                <a href="/reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
				<!--<a href="/quotations">
                    <i class="fas fa-undo"></i>
                    <span>quotation</span>
                </a>-->
                <a href="/logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Layout Wrapper -->
    <div class="layout-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li>
                    <a href="#" class="nav-link active" data-section="billing">
                        <i class="fas fa-cash-register"></i>
                        <span>Billing</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-section="credit-management">
                        <i class="fas fa-money-check-alt"></i>
                        <span>Credit Management</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-section="credit-notes">
                        <i class="fas fa-receipt"></i>
                        <span>Credit Notes</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-section="quotations">
                        <i class="fas fa-file-invoice"></i>
                        <span>Quotations</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Alert Container -->
            <div id="alertMessage"></div>

            <!-- BILLING SECTION -->
            <section id="billing-section" class="section active">
                <div class="billing-grid">
                    <!-- Left Panel - Product Selection -->
                    <div class="panel">
                        <!-- <div class="panel-header"> -->
                            <!-- <i class="fas fa-box"></i> -->
                            <!-- <h2>Product Selection</h2> -->
                        <!-- </div> -->

                        <!-- Filters -->
                        <div class="form-section">
                            <div class="form-section-label">
                                <i class="fas fa-filter"></i>
                                <span>Filters</span><br>
                            </div>
                            <div class="input-group">
                                <select id="brandFilter" onchange="loadProducts()">
                                    <option value="">All Brands</option>
                                </select>
                                <select id="categoryFilter" onchange="loadProducts()">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                        </div>

                        <!-- Search -->
                        <div class="form-section">
                            <div class="form-section-label">
                                <i class="fas fa-search"></i>
                                <span>Search Product</span>
                            </div>
							
                            <input type="text" id="productSearch" placeholder="Type product name..." oninput="filterProducts()" onfocus="this.select()">
                        </div>

                        <!-- Product List -->
                        <div id="productList" style="max-height: calc(100vh - 400px); overflow-y: auto;"></div>
                    </div>

                    <!-- Right Panel - Cart & Payment -->
                    <div>
                        <!-- Cart -->
                        <div class="panel">
                            <div class="panel-header" style="justify-content: space-between; display: flex; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-shopping-cart"></i>
                                    <h2>Cart</h2>
                                </div>
                                <button class="btn btn-sm" onclick="openAddCustomerModal()" style="background: var(--success-color); color: white; padding: 8px 16px; font-size: 13px;">
                                    <i class="fas fa-user-plus"></i> Add Customer
                                </button>
                            </div>
                            
                            <!-- Customer Info Display -->
                            <div id="cartCustomerInfo" style="display: none; background: var(--light-gray); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                            <i class="fas fa-user" style="color: var(--success-color);"></i> 
                                            <span id="cartCustomerName"></span>
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                                            <i class="fas fa-phone"></i> <span id="cartCustomerMobile"></span>
                                        </div>
                                        <div id="cartCustomerSales" style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; display: none;">
                                            <i class="fas fa-chart-line"></i> <span></span>
                                        </div>
                                        <div id="cartCustomerCredit" style="font-size: 13px; color: #166534; font-weight: 600; display: none;">
                                            <i class="fas fa-ticket-alt"></i> <span></span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm" onclick="clearCartCustomer()" style="background: var(--danger-color); color: white; padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="cartItems"></div>
                            
                            <!-- Summary -->
                            <div style="margin-top: 20px;">
                                <div class="summary-line">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">0.00</span>
                                </div>
                                <div class="summary-line">
                                    <span>Item Discounts:</span>
                                    <span id="itemDiscounts">-0.00</span>
                                </div>
                                <div class="summary-line total">
                                    <span>Total Amount:</span>
                                    <span id="totalAmount">0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Split -->
                        <div class="panel">
                            <div class="panel-header" style="border-bottom: none; padding-bottom: 10px;">
                                <i class="fas fa-credit-card"></i>
                                <h2>Payment Method</h2>
                            </div>
                            
                            <!-- Quick Pay / Split Payment Buttons -->
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <button class="btn" id="quickPayBtn" onclick="showQuickPayOptions()" style="flex: 1; background: white; color: var(--primary-color); border: 2px solid var(--primary-color);">
                                    <i class="fas fa-bolt"></i> Quick Pay
                                </button>
                                <button class="btn btn-primary" id="splitPayBtn" onclick="showSplitPayment()" style="flex: 1;">
                                    <i class="fas fa-divide"></i> Split Payment
                                </button>
                            </div>
                            
                            <!-- Quick Pay Options (Initially Hidden) -->
                            <div id="quickPayOptions" style="display: none;">
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr);
            width: 100%; gap: 10px; margin-bottom: 15px;">
                                    <button class="btn" onclick="quickPayMethod('cash')" style="padding: 28px; background: white; border: 2px solid #10b981; color: #10b981;">
                                        <i class="fas fa-money-bill-wave" style="font-size: 24px; display: block; margin-bottom: 5px;"></i>
                                        <span style="font-size: 13px;">Cash</span>
                                    </button>
                                    <button class="btn" onclick="quickPayMethod('upi')" style="padding: 28px; background: white; border: 2px solid #6366f1; color: #6366f1;">
                                        <i class="fas fa-mobile-alt" style="font-size: 24px; display: block; margin-bottom: 5px;"></i>
                                        <span style="font-size: 13px;">UPI / Card</span>
                                    </button>
                                    <button class="btn" onclick="quickPayMethod('credit')" style="padding: 28px; background: white; border: 2px solid #f59e0b; color: #f59e0b;">
                                        <i class="fas fa-credit-card" style="font-size: 24px; display: block; margin-bottom: 5px;"></i>
                                        <span style="font-size: 13px;">Credit (Account)</span>
                                    </button>
                                    <button class="btn" onclick="quickPayMethod('creditNote')" style="padding: 28px; background: white; border: 2px solid #10b981; color: #10b981;" id="quickPayCreditNoteBtn" disabled>
                                        <i class="fas fa-ticket-alt" style="font-size: 24px; display: block; margin-bottom: 5px;"></i>
                                        <span style="font-size: 13px;">Credit Note</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Split Payment Options (Initially Hidden) -->
                            <div id="splitPaymentOptions" style="display: none;">
                                <div class="payment-item" id="cashPaymentItem">
                                    <input type="checkbox" id="useCash" onchange="togglePaymentMethod('cash')">
                                    <i class="fas fa-money-bill-wave" style="color: var(--success-color); font-size: 20px;"></i>
                                    <label for="useCash">Cash</label>
                                    <input type="number" id="cashAmount" value="0" step="0.01" min="0" disabled oninput="calculateSplitPayment()">
                                </div>
                                
                                <div class="payment-item" id="upiPaymentItem">
                                    <input type="checkbox" id="useUPI" onchange="togglePaymentMethod('upi')">
                                    <i class="fas fa-mobile-alt" style="color: var(--primary-color); font-size: 20px;"></i>
                                    <label for="useUPI">UPI</label>
                                    <input type="number" id="upiAmount" value="0" step="0.01" min="0" disabled oninput="calculateSplitPayment()">
                                </div>
                                
                                <div class="payment-item" id="creditPaymentItem">
                                    <input type="checkbox" id="useCredit" onchange="togglePaymentMethod('credit')">
                                    <i class="fas fa-credit-card" style="color: var(--warning-color); font-size: 20px;"></i>
                                    <label for="useCredit">Credit (Account)</label>
                                    <input type="number" id="creditAmount" value="0" step="0.01" min="0" disabled oninput="calculateSplitPayment()">
                                </div>
                                
                                <div class="payment-item" id="creditNotePaymentItem" style="display: none;">
                                    <input type="checkbox" id="useCreditNote" onchange="togglePaymentMethod('creditNote')">
                                    <i class="fas fa-ticket-alt" style="color: var(--success-color); font-size: 20px;"></i>
                                    <label for="useCreditNote">Credit Note</label>
                                    <input type="number" id="creditNotePaymentAmount" value="0" step="0.01" min="0" disabled oninput="calculateSplitPayment()">
                                </div>
                                
                                <!-- Remaining Amount Display -->
                                <div id="remainingAmountBox" style="margin-top: 15px; padding: 28px; border: 2px solid var(--success-color); border-radius: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 600; font-size: 15px;">REMAINING:</span>
                                        <span id="remainingAmount" style="font-weight: 700; font-size: 20px; color: var(--success-color);">0.00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selected Payment Summary (shown after Quick Pay selection) -->
                            <div id="selectedPaymentSummary" style="display: none; margin-top: 15px; padding: 28px; background: var(--light-gray); border-radius: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Payment Method:</span>
                                    <span id="selectedMethodName" style="font-weight: 700; color: var(--primary-color);"></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: 600;">Amount:</span>
                                    <span id="selectedMethodAmount" style="font-weight: 700; font-size: 20px; color: var(--success-color);">0.00</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-success" style="width: 100%; margin-top: 15px; padding: 14px;" onclick="completeSale()">
                                <i class="fas fa-check-circle"></i> Complete Sale
                            </button>
                            
                            <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="clearCart()">
                                <i class="fas fa-times-circle"></i> Clear Cart
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CREDIT MANAGEMENT SECTION -->
            <section id="credit-management-section" class="section">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon red">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="totalOutstanding">0.00</h3>
                            <p>Total Outstanding</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="totalCustomers">0</h3>
                            <p>Customers with Credit</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-details">
                            <h3 id="totalBills">0</h3>
                            <p>Outstanding Bills</p>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label>Search Customer</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="creditSearchInput" placeholder="Search by name or mobile..." oninput="filterCredits()" style="flex: 1;" onfocus="this.select()">
                            <button class="btn" onclick="clearCreditSearch()" style="background: #e2e8f0; color: #334155; padding: 10px 16px;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Sort By</label>
                        <select id="creditSortBy" onchange="sortCredits()">
                            <option value="amount_desc">Amount (High to Low)</option>
                            <option value="amount_asc">Amount (Low to High)</option>
                            <option value="name_asc">Name (A to Z)</option>
                            <option value="name_desc">Name (Z to A)</option>
                        </select>
                    </div>
                </div>

                <!-- Credits Content -->
                <div id="creditsContent"></div>
            </section>

            <!-- CREDIT NOTES SECTION -->
            <section id="credit-notes-section" class="section">
                <div class="billing-grid">
                    <!-- Issue Credit Note -->
                    <div class="panel">
                        <div class="panel-header">
                            <i class="fas fa-plus-circle"></i>
                            <h2>Issue Credit Note</h2>
                        </div>
                        
                        <!-- Credit Note Type Selection -->
                        <div class="form-group">
                            <label>Credit Note Type</label>
                            <select id="cnTypeSelect" onchange="handleCreditNoteTypeChange()">
                                <option value="return">Product Return</option>
                                <option value="advance">Advance Payment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Customer Mobile</label>
                            <div class="input-group">
                                <input type="text" id="cnCustomerMobile" placeholder="Enter mobile number" maxlength="10" onfocus="this.select()">
                                <button class="btn btn-primary" onclick="searchCustomerForCreditNote()">
                                    <i class="fas fa-search"></i> Search
                                </button>
                                <button class="btn" onclick="clearCreditNoteSearch()" style="background: #e2e8f0; color: #334155;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Return Type Section -->
                        <div id="cnReturnSection" style="display: none;">
                            <div id="cnCustomerDetails"></div>
                            
                            <div class="form-group">
                                <label>Select Bill</label>
                                <select id="cnBillSelect" onchange="loadBillItems()">
                                    <option value="">Select a bill</option>
                                </select>
                            </div>
                            
                            <div id="cnBillItems" style="display: none;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Qty Sold</th>
                                            <th>Price</th>
                                            <th>Return Qty</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cnItemsBody"></tbody>
                                </table>
                                
                                <div class="summary-line total" style="margin-top: 15px;">
                                    <span>Total Credit:</span>
                                    <span><span id="cnTotalCredit">0.00</span></span>
                                </div>
                                
                                <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="processCreditNote()">
                                    <i class="fas fa-check"></i> Issue Credit Note
                                </button>
                            </div>
                        </div>
                        
                        <!-- Advance Payment Section -->
                        <div id="cnAdvanceSection" style="display: none;">
                            <div id="cnAdvanceCustomerDetails"></div>
                            
                            <div class="form-group">
                                <label>Advance Amount *</label>
                                <input type="number" id="cnAdvanceAmount" placeholder="Enter advance amount" step="0.01" min="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label>Payment Method *</label>
                                <select id="cnAdvancePaymentMethod">
                                    <option value="cash">Cash</option>
                                    <option value="upi">UPI</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="card">Card</option>
                                    <option value="cheque">Cheque</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Payment Reference</label>
                                <input type="text" id="cnAdvanceReference" placeholder="Transaction ID / Cheque Number (Optional)">
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="cnAdvanceNotes" rows="3" placeholder="Purpose of advance payment (Optional)"></textarea>
                            </div>
                            
                            <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="processAdvancePayment()">
                                <i class="fas fa-check"></i> Record Advance Payment
                            </button>
                        </div>
                    </div>

                    <!-- Credit Notes List -->
                    <div class="panel">
                        <div class="panel-header">
                            <i class="fas fa-list"></i>
                            <h2>Credit Notes History</h2>
                        </div>
                        
                        <!-- Search by Mobile or CN# -->
                        <!-- Search by Mobile or CN# -->
                        <div class="form-section" style="margin-bottom: 20px;">
                            <div class="form-section-label">
                                <i class="fas fa-search"></i>
                                <span>Search by Customer Mobile or CN#</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="cnSearchInput" placeholder="Type mobile number or CN# to search..." style="flex: 1;" oninput="debounceCNSearch()" onfocus="this.select()">
                                <button class="btn" onclick="clearCNSearch()" style="background: #e2e8f0; color: #334155;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> Search updates as you type (min 3 characters)
                            </div>
                        </div>
                        
                        <!-- Table with scrolling -->
                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                            <table>
                                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <tr>
                                        <th>CN #</th>
                                        <th>Type</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Remaining</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="cnHistoryTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- QUOTATIONS SECTION -->
            <section id="quotations-section" class="section">
                <div class="billing-grid">
                    <!-- Product Selection for Quotation -->
                    <div class="panel">
                        <div class="panel-header">
                            <i class="fas fa-box"></i>
                            <h2>Select Products</h2>
                        </div>
                        
                        <div class="form-section">
                            <div class="input-group">
                                <select id="quoteBrandFilter" onchange="loadQuoteProducts()">
                                    <option value="">All Brands</option>
                                </select>
                                <select id="quoteCategoryFilter" onchange="loadQuoteProducts()">
                                    <option value="">All Categories</option>
                                </select>
                                <input type="text" id="quoteProductSearch" placeholder="Search products..." oninput="filterQuoteProducts()" onfocus="this.select()">
                            </div>
                        </div>
                        
                        <div id="quoteProductList" class="products-grid" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>

                    <!-- Quotation Details -->
                    <div>
                        <!-- Selected Items -->
                        <div class="panel">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fas fa-list"></i>
                                    <h2>Selected Items</h2>
                                </div>
                                
                                <!-- Add Customer Button (Small) -->
                                <button class="btn btn-primary" id="quoteAddCustomerButton" onclick="openQuoteCustomerModal()" style="padding: 8px 16px; font-size: 13px; white-space: nowrap;">
                                    <i class="fas fa-user-plus"></i> Add Customer
                                </button>
                            </div>
                            
                            <!-- Customer Info Display (Right after heading) -->
                            <div id="quoteCustomerInfoPanel" style="display: none; margin-top: 0; margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 10px; border: 1.5px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                    <i class="fas fa-user" style="color: var(--primary-color);"></i>
                                    <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0;">Customer Details</h3>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 16px; font-weight: 600; color: var(--primary-color); margin-bottom: 4px;" id="quoteCustomerDisplayName">Customer Name</div>
                                        <div style="color: var(--text-secondary); font-size: 13px;">
                                            <i class="fas fa-phone"></i> <span id="quoteCustomerDisplayMobile"></span>
                                        </div>
                                        <div style="color: var(--text-secondary); font-size: 13px; margin-top: 4px;" id="quoteCustomerDisplayAddress">
                                            <i class="fas fa-map-marker-alt"></i> <span></span>
                                        </div>
                                    </div>
                                    <button class="btn btn-danger" onclick="clearQuoteCustomer()" style="padding: 6px 10px; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Selected Items List -->
                            <div id="quoteSelectedItems" style="max-height: 260px; overflow-y: auto; margin-bottom: 16px;"></div>
                            
                            <div class="form-group">
                                <label>Overall Discount (%)</label>
                                <input type="number" id="quoteDiscountPercent" value="0" min="0" max="100" step="0.1" oninput="updateQuoteSummary()" onfocus="this.select()">
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <div class="summary-line">
                                    <span>Subtotal:</span>
                                    <span id="quoteSubtotal">0.00</span>
                                </div>
                                <div class="summary-line">
                                    <span>Discount:</span>
                                    <span id="quoteDiscountAmount">-0.00</span>
                                </div>
                                <div class="summary-line total">
                                    <span>Grand Total:</span>
                                    <span id="quoteGrandTotal">0.00</span>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-success" onclick="generateQuotation()">
                                    <i class="fas fa-download"></i> Generate PDF
                                </button>
                                <button class="btn btn-danger" onclick="clearQuotation()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Clear Credit Modal -->
    <div id="clearCreditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Record Payment</h2>
                <span class="close" onclick="closeClearModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="clearCustomerInfo"></div>
                <form id="clearCreditForm">
                    <input type="hidden" id="clearBillId" name="bill_id">
                    <input type="hidden" id="clearCustomerId" name="customer_id">
                    
                    <div class="form-group">
                        <label>Payment Amount</label>
                        <input type="number" id="clearPaymentAmount" name="payment_amount" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="clearPaymentMethod" name="payment_method" required>
                            <option value="cash">Cash</option>
                            <option value="upi">UPI</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Reference Number</label>
                        <input type="text" id="clearPaymentReference" name="payment_reference" placeholder="Optional">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="clearNotes" name="notes" rows="2" placeholder="Optional notes"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-check"></i> Record Payment
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- View Bills Modal -->
    <div id="viewBillsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                    <h2 style="margin: 0;">Outstanding Bills</h2>
                    <button class="btn btn-primary btn-sm" onclick="printOutstandingBills()" style="margin-left: auto;">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                <span class="close" onclick="closeViewBillsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="billsCustomerInfo"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Original Credit</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let cart = [];
        let currentCustomer = null;
        let customerCreditNotes = [];
        let selectedCreditNoteAmount = 0;
        let allProducts = [];
        let selectedStore = null;
        
        // Credit Management Variables
        let selectedCustomerForCredit = null;
        let selectedBillForCredit = null;
        let allCreditsData = {}; // Store all credits data for filtering/sorting
        
        // Credit Note Variables
        let currentCustomerIdForCN = null;
        let currentSaleIdForCN = null;
        let currentBillItemsForCN = [];
        
        // Quotation Variables
        let quoteSelectedItems = [];
        let quoteDiscountPercentage = 0;
        let allQuoteProducts = [];
        let quoteCustomerData = null;
        let currentQuoteProduct = null;

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active link
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Show selected section
                const sectionId = this.dataset.section;
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId + '-section').classList.add('active');
                
                // Load section data
                loadSectionData(sectionId);
            });
        });

        function loadSectionData(section) {
            switch(section) {
                case 'billing':
                    loadBrands();
                    break;
                case 'credit-management':
                    loadCredits();
                    break;
                case 'credit-notes':
                    loadCreditNotes();
                    break;
                case 'quotations':
                    loadQuoteBrands();
                    break;
            }
        }

        // =========================
        // BILLING SECTION FUNCTIONS
        // =========================
        
        async function loadBrands() {
            try {
                // Load products first to extract brands
                const response = await fetch('/api/products');
                const products = await response.json();
                
                // Extract unique brands
                const brands = [...new Set(products.map(p => p.brand).filter(Boolean))].sort();
                
                const brandFilter = document.getElementById('brandFilter');
                brandFilter.innerHTML = '<option value="">All Brands</option>';
                brands.forEach(brand => {
                    brandFilter.innerHTML += `<option value="${brand}">${brand}</option>`;
                });
                
                // Extract unique categories
                const categories = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
                
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                });
                
                loadProducts();
            } catch (error) {
                console.error('Error loading brands:', error);
                showAlert('Error loading brands', 'danger');
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                let products = await response.json();
                
                // Client-side filtering
                const brand = document.getElementById('brandFilter').value;
                const category = document.getElementById('categoryFilter').value;
                
                if (brand) {
                    products = products.filter(p => p.brand === brand);
                }
                if (category) {
                    products = products.filter(p => p.category === category);
                }
                
                // Map backend fields to expected frontend fields
                allProducts = products.map(p => ({
                    ...p,
                    stock: p.current_stock || 0,
                    rate: p.price || p.rate || 0
                }));
                
                displayProducts(allProducts);
            } catch (error) {
                console.error('Error loading products:', error);
                showAlert('Error loading products', 'danger');
            }
        }

        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.product_name.toLowerCase().includes(search) ||
                (p.brand && p.brand.toLowerCase().includes(search))
            );
            displayProducts(filtered);
        }

        function displayProducts(products) {
            const container = document.getElementById('productList');
            
            if (products.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #999; padding: 40px;">No products found</div>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const inCart = cart.find(item => item.product_id === product.product_id);
                const stockClass = product.stock > 10 ? 'success' : product.stock > 0 ? 'warning' : 'danger';
                
                return `
                    <div class="product-item" style="${inCart ? 'border-color: var(--success-color); background: rgba(16, 185, 129, 0.05);' : ''}" 
                         onclick="addToCart(${product.product_id})">
                        <!-- <div class="product-item-icon"> -->
                            <!-- <i class="fas fa-box"></i> -->
                        <!-- </div> -->
                        <div class="product-item-name">${product.product_name}</div>
                        <div class="product-item-brand">${product.brand || 'No Brand'}</div>
                        <span class="badge badge-${stockClass} product-item-stock" style="margin-top: 8px;">
                            ${Math.round(product.stock)} ${product.unit || 'pcs'}
                        </span>
                        ${inCart ? '<div style="margin-top: 8px; color: var(--success-color); font-size: 12px; font-weight: 600;"><i class="fas fa-check-circle"></i> In Cart</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // Store current product being added
        let currentProductToAdd = null;

        function addToCart(productId) {
            const product = allProducts.find(p => p.product_id === productId);
            if (!product) return;
            
            const existing = cart.find(item => item.product_id === productId);
            if (existing) {
                showAlert('Product already in cart', 'warning');
                return;
            }
            
            // Open modal with product details
            currentProductToAdd = product;
            const availableStock = parseFloat(product.stock || product.current_stock || 0);
            
            document.getElementById('modalProductName').textContent = product.product_name;
            document.getElementById('modalProductBrand').textContent = product.brand || 'No brand';
            document.getElementById('modalProductStock').textContent = `Available Stock: ${availableStock} ${product.unit || 'units'}`;
            document.getElementById('modalQuantity').value = '1';
            document.getElementById('modalQuantity').max = availableStock; // Set max attribute
            document.getElementById('modalPrice').value = parseFloat(product.rate || 0);
            document.getElementById('modalDiscount').value = '0';
            
            // Add real-time validation
            const quantityInput = document.getElementById('modalQuantity');
            const stockWarning = document.getElementById('stockWarning');
            
            quantityInput.oninput = function() {
                const enteredQty = parseFloat(this.value) || 0;
                if (enteredQty > availableStock) {
                    stockWarning.style.display = 'block';
                    this.style.borderColor = 'var(--danger-color)';
                } else {
                    stockWarning.style.display = 'none';
                    this.style.borderColor = 'var(--border-color)';
                }
            };
            
            const modal = document.getElementById('addToCartModal');
            modal.classList.add('show');
        }

        function closeAddToCartModal() {
            const modal = document.getElementById('addToCartModal');
            modal.classList.remove('show');
            currentProductToAdd = null;
        }


        function handleModalAction() {
            if (currentEditIndex !== null) {
                confirmEditCartItem();
            } else {
                confirmAddToCart();
            }
        }
        function confirmAddToCart() {
            if (!currentProductToAdd) return;
            
            const quantity = parseFloat(document.getElementById('modalQuantity').value) || 0;
            const price = parseFloat(document.getElementById('modalPrice').value) || 0;
            const discount = parseFloat(document.getElementById('modalDiscount').value) || 0;
            
            if (quantity <= 0) {
                showAlert('Please enter a valid quantity', 'danger');
                return;
            }
            
            if (price < 0) {
                showAlert('Price cannot be negative', 'danger');
                return;
            }
            
            // Check stock availability - use stock or current_stock field
            const availableStock = parseFloat(currentProductToAdd.stock || currentProductToAdd.current_stock || 0);
            if (quantity > availableStock) {
                showAlert(`Insufficient stock! Only ${availableStock} ${currentProductToAdd.unit || 'units'} available in inventory.`, 'danger');
                return;
            }
            
            cart.push({
                ...currentProductToAdd,
                quantity: quantity,
                rate: price,
                discountPercent: discount
            });
            
            closeAddToCartModal();
            renderCart();
            displayProducts(allProducts.filter(p => 
                p.product_name.toLowerCase().includes(document.getElementById('productSearch').value.toLowerCase())
            ));
            
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Cart is empty</p>
                    </div>
                `;
                calculateTotal();
                return;
            }
            
            container.innerHTML = '<div class="cart-items-container">' + cart.map((item, index) => {
                const itemTotal = (item.quantity * item.rate * (1 - item.discountPercent / 100)).toFixed(2);
                return `
                    <div class="cart-item-compact">
                        <div class="cart-item-header-row">
                            <div class="cart-item-title">
                                <strong>${item.product_name}</strong>
                            </div>
                            <div class="cart-item-actions">
                                <button onclick="editCartItem(${index})" class="btn-icon btn-edit" title="Edit item">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="removeFromCart(${index})" class="btn-icon btn-delete" title="Delete item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="cart-item-details-row">
                            <span class="cart-detail-item"><strong>Brand:</strong> ${item.brand || '-'}</span>
                            <span class="cart-detail-item"><strong>Qty:</strong> ${item.quantity}</span>
                            <span class="cart-detail-item"><strong>Price:</strong> ${item.rate.toFixed(2)}</span>
                            <span class="cart-detail-item"><strong>Disc:</strong> ${item.discountPercent}%</span>
                            <span class="cart-detail-item cart-total-highlight"><strong>Total:</strong> ${itemTotal}</span>
                        </div>
                    </div>
                `;
            }).join('') + '</div>';
            
            calculateTotal();
        }

        function updateCartItem(index, field, value) {
            cart[index][field] = parseFloat(value) || 0;
            renderCart();
        }

        let currentEditIndex = null;

        function editCartItem(index) {
            const item = cart[index];
            
            // Store edit index
            currentEditIndex = index;
            currentProductToAdd = item;
            
            const availableStock = parseFloat(item.stock || item.current_stock || 0);
            
            document.getElementById('modalProductName').textContent = item.product_name;
            document.getElementById('modalProductBrand').textContent = item.brand || 'No brand';
            document.getElementById('modalProductStock').textContent = `Available Stock: ${availableStock} ${item.unit || 'units'}`;
            
            document.getElementById('modalQuantity').value = item.quantity;
            document.getElementById('modalQuantity').max = availableStock;
            document.getElementById('modalPrice').value = item.rate;
            document.getElementById('modalDiscount').value = item.discountPercent;
            
            // Add real-time validation
            const quantityInput = document.getElementById('modalQuantity');
            const stockWarning = document.getElementById('stockWarning');
            
            quantityInput.oninput = function() {
                const enteredQty = parseFloat(this.value) || 0;
                if (enteredQty > availableStock) {
                    stockWarning.style.display = 'block';
                    this.style.borderColor = 'var(--danger-color)';
                } else {
                    stockWarning.style.display = 'none';
                    this.style.borderColor = 'var(--border-color)';
                }
            };
            
            // Change modal title and button
            const modalTitle = document.querySelector('#addToCartModal .modal-header h3');
            modalTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Cart Item';
            
            const modalButton = document.getElementById('modalActionButton');
            modalButton.innerHTML = '<i class="fas fa-check"></i> Update Item';
            
            const modal = document.getElementById('addToCartModal');
            modal.classList.add('show');
        }
        function confirmEditCartItem() {
            if (currentEditIndex === null) return confirmAddToCart();
            
            const quantity = parseFloat(document.getElementById('modalQuantity').value) || 0;
            const price = parseFloat(document.getElementById('modalPrice').value) || 0;
            const discount = parseFloat(document.getElementById('modalDiscount').value) || 0;
            
            if (quantity <= 0) {
                showAlert('Please enter a valid quantity', 'danger');
                return;
            }
            
            if (price < 0) {
                showAlert('Price cannot be negative', 'danger');
                return;
            }
            
            const availableStock = parseFloat(currentProductToAdd.stock || currentProductToAdd.current_stock || 0);
            if (quantity > availableStock) {
                showAlert(`Insufficient stock! Only ${availableStock} ${currentProductToAdd.unit || 'units'} available in inventory.`, 'danger');
                return;
            }
            
            // Update cart item
            cart[currentEditIndex].quantity = quantity;
            cart[currentEditIndex].rate = price;
            cart[currentEditIndex].discountPercent = discount;
            
            // Reset modal state
            currentEditIndex = null;
            const modalTitle = document.querySelector('#addToCartModal .modal-header h3');
            modalTitle.innerHTML = '<i class="fas fa-cart-plus"></i> Add to Cart';
            
            const modalButton = document.getElementById('modalActionButton');
            modalButton.innerHTML = '<i class="fas fa-check"></i> Add to Cart';
            
            closeAddToCartModal();
            renderCart();
        }
        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            displayProducts(allProducts.filter(p => 
                p.product_name.toLowerCase().includes(document.getElementById('productSearch').value.toLowerCase())
            ));
        }

        function calculateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
            const itemDiscounts = cart.reduce((sum, item) => {
                const itemSubtotal = item.quantity * item.rate;
                const discountAmount = (itemSubtotal * item.discountPercent) / 100;
                return sum + discountAmount;
            }, 0);
            
            const total = subtotal - itemDiscounts;
            
            document.getElementById('subtotal').textContent = '' + subtotal.toFixed(2);
            document.getElementById('itemDiscounts').textContent = '-' + itemDiscounts.toFixed(2);
            document.getElementById('totalAmount').textContent = '' + Math.max(0, total).toFixed(2);
            
            calculateSplitPayment();
        }

        async function searchCustomer() {
            const mobile = document.getElementById('customerMobile').value.trim();
            
            if (!mobile || mobile.length !== 10) {
                showAlert('Please enter a valid 10-digit mobile number', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`/api/customers/search?mobile=${mobile}`);
                const data = await response.json();
                
                if (data.found && data.customer) {
                    currentCustomer = data.customer;
                    customerCreditNotes = data.credit_notes || [];
                    
                    document.getElementById('customerDetails').innerHTML = `
                        <div style="padding: 28px; background: var(--light-gray); border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 16px;">${data.customer.customer_name}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                Mobile: ${data.customer.mobile}
                            </div>
                            ${data.customer.total_sales ? `
                                <div style="margin-top: 8px; font-size: 13px; color: #666;">
                                    Total Sales: ${data.customer.total_sales.toFixed(2)}
                                </div>
                            ` : ''}
                            ${customerCreditNotes.length > 0 ? `
                                <div style="margin-top: 10px; padding: 10px; background: #dcfce7; border-radius: 6px; color: #166534;">
                                    <i class="fas fa-ticket-alt"></i> 
                                    Credit Notes Available: ${customerCreditNotes.reduce((sum, cn) => sum + parseFloat(cn.remaining_balance || 0), 0).toFixed(2)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    document.getElementById('customerInfoCard').style.display = 'block';
                    
                    // Show credit note option if available
                    if (customerCreditNotes.length > 0) {
                        document.getElementById('creditNotePaymentItem').style.display = 'flex';
                    }
                    
                    // Hide alert
                    document.getElementById('alertMessage').innerHTML = '';
                } else {
                    // Customer not found - show form to create new customer
                    currentCustomer = null;
                    customerCreditNotes = [];
                    document.getElementById('creditNotePaymentItem').style.display = 'none';
                    
                    document.getElementById('customerDetails').innerHTML = `
                        <div style="padding: 28px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107;">
                            <div style="font-weight: 600; margin-bottom: 15px; color: #856404;">
                                <i class="fas fa-user-plus"></i> New Customer
                            </div>
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="newCustomerName" placeholder="Enter customer name" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label>Address (Optional)</label>
                                <textarea id="newCustomerAddress" rows="2" placeholder="Enter address" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;"></textarea>
                            </div>
                            <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="createNewCustomer()">
                                <i class="fas fa-check"></i> Create Customer
                            </button>
                        </div>
                    `;
                    document.getElementById('customerInfoCard').style.display = 'block';
                    
                    showAlert('Customer not found. Please enter details to create new customer.', 'warning');
                }
            } catch (error) {
                showAlert('Error searching customer', 'danger');
                console.error(error);
            }
        }
        
        async function createNewCustomer() {
            const mobile = document.getElementById('customerMobile').value.trim();
            const name = document.getElementById('newCustomerName').value.trim();
            const address = document.getElementById('newCustomerAddress').value.trim();
            
            if (!name) {
                showAlert('Please enter customer name', 'danger');
                document.getElementById('newCustomerName').focus();
                return;
            }
            
            try {
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_name: name,
                        mobile: mobile,
                        address: address
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('Customer created successfully!', 'success');
                    
                    // Set the new customer as current customer
                    currentCustomer = {
                        customer_id: data.customer_id,
                        customer_name: name,
                        mobile: mobile,
                        address: address
                    };
                    
                    // Update the display
                    document.getElementById('customerDetails').innerHTML = `
                        <div style="padding: 28px; background: var(--light-gray); border-radius: 8px;">
                            <div style="font-weight: 600; font-size: 16px;">${name}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                Mobile: ${mobile}
                            </div>
                            ${address ? `
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Address: ${address}
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px; padding: 8px; background: #dcfce7; border-radius: 6px; color: #166534; font-size: 12px;">
                                <i class="fas fa-check-circle"></i> New customer created
                            </div>
                        </div>
                    `;
                } else {
                    showAlert('Error creating customer: ' + (data.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error creating customer: ' + error.message, 'danger');
                console.error(error);
            }
        }

        function togglePaymentMethod(method) {
            const checkbox = document.getElementById('use' + (method === 'upi' ? 'UPI' : method === 'creditNote' ? 'CreditNote' : method.charAt(0).toUpperCase() + method.slice(1)));
            const input = document.getElementById(method + (method === 'creditNote' ? 'PaymentAmount' : 'Amount'));
            const paymentItem = document.getElementById(method + 'PaymentItem');
            
            if (checkbox.checked) {
                input.disabled = false;
                paymentItem.classList.add('active');
            } else {
                input.disabled = true;
                input.value = '0';
                paymentItem.classList.remove('active');
            }
            
            calculateSplitPayment();
        }

        function showQuickPayOptions() {
            // Hide split payment options
            document.getElementById('splitPaymentOptions').style.display = 'none';
            document.getElementById('selectedPaymentSummary').style.display = 'none';
            
            // Show quick pay options
            document.getElementById('quickPayOptions').style.display = 'block';
            
            // Enable credit note button if customer has credit notes
            if (customerCreditNotes && customerCreditNotes.length > 0) {
                document.getElementById('quickPayCreditNoteBtn').disabled = false;
            } else {
                document.getElementById('quickPayCreditNoteBtn').disabled = true;
            }
        }
        
        function quickPayMethod(method) {
            const total = parseFloat(document.getElementById('totalAmount').textContent.replace('', '')) || 0;
            
            // Reset all payment methods
            resetAllPayments();
            
            // Set the selected method
            let methodName = '';
            let maxAmount = total;
            
            switch(method) {
                case 'cash':
                    document.getElementById('useCash').checked = true;
                    document.getElementById('cashAmount').value = total.toFixed(2);
                    document.getElementById('cashAmount').disabled = false;
                    methodName = 'Cash';
                    break;
                case 'upi':
                    document.getElementById('useUPI').checked = true;
                    document.getElementById('upiAmount').value = total.toFixed(2);
                    document.getElementById('upiAmount').disabled = false;
                    methodName = 'UPI / Card';
                    break;
                case 'credit':
                    document.getElementById('useCredit').checked = true;
                    document.getElementById('creditAmount').value = total.toFixed(2);
                    document.getElementById('creditAmount').disabled = false;
                    methodName = 'Credit (Account)';
                    break;
                case 'creditNote':
                    maxAmount = Math.min(total, customerCreditNotes.reduce((sum, cn) => sum + parseFloat(cn.remaining_balance || 0), 0));
                    document.getElementById('useCreditNote').checked = true;
                    document.getElementById('creditNotePaymentAmount').value = maxAmount.toFixed(2);
                    document.getElementById('creditNotePaymentAmount').disabled = false;
                    methodName = 'Credit Note';
                    break;
            }
            
            // Hide quick pay options
            document.getElementById('quickPayOptions').style.display = 'none';
            
            // Show payment summary
            document.getElementById('selectedMethodName').textContent = methodName;
            document.getElementById('selectedMethodAmount').textContent = '' + maxAmount.toFixed(2);
            document.getElementById('selectedPaymentSummary').style.display = 'block';
        }
        
        function showSplitPayment() {
            // Hide quick pay options and summary
            document.getElementById('quickPayOptions').style.display = 'none';
            document.getElementById('selectedPaymentSummary').style.display = 'none';
            
            // Reset all payments
            resetAllPayments();
            
            // Show split payment options
            document.getElementById('splitPaymentOptions').style.display = 'block';
            
            // Show credit note option if available
            if (customerCreditNotes && customerCreditNotes.length > 0) {
                document.getElementById('creditNotePaymentItem').style.display = 'flex';
            }
            
            // Calculate initial remaining
            calculateSplitPayment();
        }
        
        function resetAllPayments() {
            // Uncheck all
            document.getElementById('useCash').checked = false;
            document.getElementById('useUPI').checked = false;
            document.getElementById('useCredit').checked = false;
            if (document.getElementById('useCreditNote')) {
                document.getElementById('useCreditNote').checked = false;
            }
            
            // Reset amounts
            document.getElementById('cashAmount').value = '0';
            document.getElementById('upiAmount').value = '0';
            document.getElementById('creditAmount').value = '0';
            document.getElementById('creditNotePaymentAmount').value = '0';
            
            // Disable all
            document.getElementById('cashAmount').disabled = true;
            document.getElementById('upiAmount').disabled = true;
            document.getElementById('creditAmount').disabled = true;
            document.getElementById('creditNotePaymentAmount').disabled = true;
            
            // Remove active class
            document.querySelectorAll('.payment-item').forEach(item => item.classList.remove('active'));
        }
        
        function calculateSplitPayment() {
            const total = parseFloat(document.getElementById('totalAmount').textContent.replace('', '')) || 0;
            
            // Calculate total payment
            const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
            const upiAmount = parseFloat(document.getElementById('upiAmount').value) || 0;
            const creditAmount = parseFloat(document.getElementById('creditAmount').value) || 0;
            const creditNoteAmount = parseFloat(document.getElementById('creditNotePaymentAmount').value) || 0;
            const totalPayment = cashAmount + upiAmount + creditAmount + creditNoteAmount;
            
            // Calculate remaining
            const remaining = total - totalPayment;
            
            if (document.getElementById('remainingAmount')) {
                document.getElementById('remainingAmount').textContent = '' + remaining.toFixed(2);
                
                // Change color based on remaining amount
                const remainingElem = document.getElementById('remainingAmount');
                const remainingBox = document.getElementById('remainingAmountBox');
                
                if (Math.abs(remaining) < 0.01) {
                    remainingElem.style.color = 'var(--success-color)';
                    if (remainingBox) remainingBox.style.borderColor = 'var(--success-color)';
                } else if (remaining > 0) {
                    remainingElem.style.color = 'var(--warning-color)';
                    if (remainingBox) remainingBox.style.borderColor = 'var(--warning-color)';
                } else {
                    remainingElem.style.color = 'var(--danger-color)';
                    if (remainingBox) remainingBox.style.borderColor = 'var(--danger-color)';
                }
            }
        }

        async function completeSale() {
            if (cart.length === 0) {
                showAlert('Cart is empty', 'danger');
                return;
            }
            
            // Check for cartCustomer instead of currentCustomer
            if (!cartCustomer) {
                showAlert('Please add a customer to complete the sale', 'danger');
                return;
            }
            
            const useCash = document.getElementById('useCash').checked;
            const useUPI = document.getElementById('useUPI').checked;
            const useCredit = document.getElementById('useCredit').checked;
            const useCreditNote = document.getElementById('useCreditNote')?.checked || false;
            
            if (!useCash && !useUPI && !useCredit && !useCreditNote) {
                showAlert('Please select at least one payment method', 'danger');
                return;
            }
            
            const totalPayable = parseFloat(document.getElementById('totalAmount').textContent.replace('', ''));
            const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
            const upiAmount = parseFloat(document.getElementById('upiAmount').value) || 0;
            const creditAmount = parseFloat(document.getElementById('creditAmount').value) || 0;
            const creditNoteAmount = parseFloat(document.getElementById('creditNotePaymentAmount').value) || 0;
            const totalPaid = cashAmount + upiAmount + creditAmount + creditNoteAmount;
            
            if (Math.abs(totalPaid - totalPayable) > 0.01) {
                showAlert('Payment amounts do not match total payable', 'danger');
                return;
            }
            
            const itemsForSale = cart.map(item => {
                const itemSubtotal = item.quantity * item.rate;
                const discountAmount = (itemSubtotal * item.discountPercent) / 100;
                return {
                    ...item,
                    discount: discountAmount
                };
            });
            
            // Handle new customer creation first
            let customerId = cartCustomer.customer_id;
            
            if (cartCustomer.new && !customerId) {
                // Create new customer
                try {
                    const newCustomerResponse = await fetch('/api/customers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer_name: cartCustomer.customer_name,
                            mobile: cartCustomer.mobile,
                            address: cartCustomer.address || ''
                        })
                    });
                    
                    const newCustomerData = await newCustomerResponse.json();
                    if (newCustomerData.success) {
                        customerId = newCustomerData.customer_id;
                        cartCustomer.customer_id = customerId;
                    } else {
                        showAlert('Error creating customer: ' + newCustomerData.message, 'danger');
                        return;
                    }
                } catch (error) {
                    showAlert('Error creating customer: ' + error.message, 'danger');
                    return;
                }
            }
            
            const saleData = {
                customer_id: customerId,
                items: itemsForSale,
                payment_split: {
                    cash: cashAmount,
                    upi: upiAmount,
                    credit: creditAmount,
                    credit_note: creditNoteAmount
                },
                credit_notes_used: useCreditNote ? customerCreditNotes : []
            };
            
            try {
                const response = await fetch('/api/sales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });
                
                const data = await response.json();
                if (data.success) {
                    const billNumber = data.bill_number;
                    const billId = data.bill_id || data.sale_id;
                    
                    // Clear cart immediately after successful sale
                    try {
                        clearCart();
                    } catch (clearError) {
                        console.error('Error clearing cart:', clearError);
                        // Still show success since sale completed
                    }
                    
                    // Show print bill modal
                    showPrintBillModal(billId, billNumber, parseFloat(document.getElementById('totalAmount').textContent.replace('', '')));
                } else {
                    showAlert('Error: ' + data.message, 'danger');
                }
            } catch (error) {
                showAlert('Error completing sale: ' + error.message, 'danger');
            }
        }
        
        // Print Bill Function
        function printBill(billId) {
            window.open(`/api/bills/${billId}/print`, '_blank');
        }
        
        // Global variable to store bill info for modal
        let currentBillForPrint = null;
        
        // Show print bill modal
        function showPrintBillModal(billId, billNumber, amount) {
            currentBillForPrint = billId;
            document.getElementById('billNumber').textContent = billNumber;
            document.getElementById('billAmount').textContent = `${parseFloat(amount).toFixed(2)}`;
            
            const modal = document.getElementById('printBillModal');
            modal.classList.add('show');
        }
        
        // Close print bill modal
        function closePrintBillModal() {
            const modal = document.getElementById('printBillModal');
            modal.classList.remove('show');
            currentBillForPrint = null;
        }
        
        // Print bill from modal
        function printBillFromModal() {
            if (currentBillForPrint) {
                printBill(currentBillForPrint);
            }
            closePrintBillModal();
        }
        
        // Print Payment Receipt Function
        function printPaymentReceipt(paymentId) {
            window.open(`/api/credit-payments/${paymentId}/print`, '_blank');
        }
        
        // Global variable to store payment info for modal
        let currentPaymentForPrint = null;
        
        // Show print receipt modal
        function showPrintReceiptModal(paymentId, paymentNumber, amount) {
            currentPaymentForPrint = paymentId;
            document.getElementById('receiptNumber').textContent = paymentNumber;
            document.getElementById('paymentAmount').textContent = `${parseFloat(amount).toFixed(2)}`;
            
            const modal = document.getElementById('printReceiptModal');
            modal.classList.add('show');
        }
        
        // Close print receipt modal
        function closePrintReceiptModal() {
            const modal = document.getElementById('printReceiptModal');
            modal.classList.remove('show');
            currentPaymentForPrint = null;
        }
        
        // Print receipt from modal
        function printReceiptFromModal() {
            if (currentPaymentForPrint) {
                printPaymentReceipt(currentPaymentForPrint);
            }
            closePrintReceiptModal();
        }

        function clearCart() {
            cart = [];
            currentCustomer = null;
            customerCreditNotes = [];
            cartCustomer = null;
            
            // Helper function to safely update element
            const safeSetValue = (id, value) => {
                const elem = document.getElementById(id);
                if (elem) elem.value = value;
            };
            
            const safeSetDisplay = (id, display) => {
                const elem = document.getElementById(id);
                if (elem) elem.style.display = display;
            };
            
            const safeSetChecked = (id, checked) => {
                const elem = document.getElementById(id);
                if (elem) elem.checked = checked;
            };
            
            const safeSetDisabled = (id, disabled) => {
                const elem = document.getElementById(id);
                if (elem) elem.disabled = disabled;
            };
            
            const safeRemoveClass = (id, className) => {
                const elem = document.getElementById(id);
                if (elem) elem.classList.remove(className);
            };
            
            // Hide cart customer info
            safeSetDisplay('cartCustomerInfo', 'none');
            safeSetDisplay('customerInfoCard', 'none');
            safeSetDisplay('creditNotePaymentItem', 'none');
            
            // Reset payment UI
            safeSetDisplay('quickPayOptions', 'none');
            safeSetDisplay('splitPaymentOptions', 'none');
            safeSetDisplay('selectedPaymentSummary', 'none');
            
            // Clear input fields
            safeSetValue('customerMobile', '');
            safeSetValue('productSearch', '');
            
            // Uncheck payment methods
            safeSetChecked('useCash', false);
            safeSetChecked('useUPI', false);
            safeSetChecked('useCredit', false);
            safeSetChecked('useCreditNote', false);
            
            // Reset payment amounts
            safeSetValue('cashAmount', '0');
            safeSetValue('upiAmount', '0');
            safeSetValue('creditAmount', '0');
            safeSetValue('creditNotePaymentAmount', '0');
            
            // Disable payment amount fields
            safeSetDisabled('cashAmount', true);
            safeSetDisabled('upiAmount', true);
            safeSetDisabled('creditAmount', true);
            safeSetDisabled('creditNotePaymentAmount', true);
            
            // Remove active payment cards
            safeRemoveClass('cashPaymentItem', 'active');
            safeRemoveClass('upiPaymentItem', 'active');
            safeRemoveClass('creditPaymentItem', 'active');
            safeRemoveClass('creditNotePaymentItem', 'active');
            
            // Render empty cart and recalculate
            renderCart();
        }

        // ===================================
        // CREDIT MANAGEMENT SECTION FUNCTIONS
        // ===================================
        
        async function loadCredits() {
            try {
                const response = await fetch('/api/admin/customers-with-credits');
                
                if (!response.ok) {
                    throw new Error('Failed to load credits');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load credits');
                }
                
                // Calculate totals
                let totalOutstanding = 0;
                let totalBills = 0;
                
                data.customers.forEach(customer => {
                    customer.bills.forEach(bill => {
                        totalOutstanding += parseFloat(bill.remaining_credit || 0);
                        totalBills++;
                    });
                });
                
                // Update stats
                document.getElementById('totalOutstanding').textContent = `${totalOutstanding.toFixed(2)}`;
                document.getElementById('totalCustomers').textContent = data.customers.length;
                document.getElementById('totalBills').textContent = totalBills;
                
                // Group credits by store (all will be in one store for staff)
                allCreditsData = {};
                
                data.customers.forEach(customer => {
                    if (customer.bills.length > 0) {
                        const storeName = customer.bills[0].store_name || 'Main Store';
                        if (!allCreditsData[storeName]) {
                            allCreditsData[storeName] = [];
                        }
                        allCreditsData[storeName].push(customer);
                    }
                });
                
                // Apply initial sort
                sortCredits();
                
            } catch (error) {
                console.error('Error loading credits:', error);
                showAlert('Error loading credit data: ' + error.message, 'danger');
                
                // Show empty state
                document.getElementById('totalOutstanding').textContent = '0.00';
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('totalBills').textContent = '0';
                document.getElementById('creditsContent').innerHTML = `
                    <div class="panel">
                        <div style="text-align: center; padding: 60px 20px; color: #666;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #999; margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 10px; color: #333;">Unable to Load Credits</h3>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function filterCredits() {
            const searchTerm = document.getElementById('creditSearchInput').value.toLowerCase();
            
            if (!searchTerm) {
                sortCredits();
                return;
            }
            
            // Filter credits by customer name or mobile
            const filteredData = {};
            
            Object.entries(allCreditsData).forEach(([storeName, customers]) => {
                const filteredCustomers = customers.filter(customer => 
                    customer.customer_name.toLowerCase().includes(searchTerm) ||
                    (customer.mobile && customer.mobile.includes(searchTerm))
                );
                
                if (filteredCustomers.length > 0) {
                    filteredData[storeName] = filteredCustomers;
                }
            });
            
            displayCredits(filteredData);
        }

        function clearCreditSearch() {
            document.getElementById('creditSearchInput').value = '';
            filterCredits();
        }

        function sortCredits() {
            const sortBy = document.getElementById('creditSortBy').value;
            const sortedData = {};
            
            Object.entries(allCreditsData).forEach(([storeName, customers]) => {
                const sorted = [...customers];
                
                switch(sortBy) {
                    case 'amount_desc':
                        sorted.sort((a, b) => {
                            const aTotal = a.bills.reduce((sum, bill) => sum + parseFloat(bill.remaining_credit || 0), 0);
                            const bTotal = b.bills.reduce((sum, bill) => sum + parseFloat(bill.remaining_credit || 0), 0);
                            return bTotal - aTotal;
                        });
                        break;
                    case 'amount_asc':
                        sorted.sort((a, b) => {
                            const aTotal = a.bills.reduce((sum, bill) => sum + parseFloat(bill.remaining_credit || 0), 0);
                            const bTotal = b.bills.reduce((sum, bill) => sum + parseFloat(bill.remaining_credit || 0), 0);
                            return aTotal - bTotal;
                        });
                        break;
                    case 'name_asc':
                        sorted.sort((a, b) => a.customer_name.localeCompare(b.customer_name));
                        break;
                    case 'name_desc':
                        sorted.sort((a, b) => b.customer_name.localeCompare(a.customer_name));
                        break;
                }
                
                sortedData[storeName] = sorted;
            });
            
            displayCredits(sortedData);
        }

        function displayCredits(creditsByStore) {
            const container = document.getElementById('creditsContent');
            
            if (Object.keys(creditsByStore).length === 0) {
                container.innerHTML = '<div class="panel"><p style="text-align: center; color: #999; padding: 40px;">No outstanding credits found</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(creditsByStore).map(([storeName, credits]) => {
                const storeTotal = credits.reduce((sum, c) => 
                    sum + c.bills.reduce((s, b) => s + parseFloat(b.remaining_credit || 0), 0), 0
                );
                const storeBillsCount = credits.reduce((sum, c) => sum + c.bills.length, 0);
                
                return `
                    <div class="panel">
                        <div style="background: var(--light-gray); padding: 28px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; margin-bottom: 10px;">${storeName}</h3>
                            <div style="display: flex; gap: 20px; font-size: 14px;">
                                <div><strong>Customers:</strong> ${credits.length}</div>
                                <div><strong>Bills:</strong> ${storeBillsCount}</div>
                                <div><strong>Total:</strong> ${storeTotal.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Mobile</th>
                                    <th>Bills</th>
                                    <th>Total Credit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${credits.map(customer => {
                                    const customerTotal = customer.bills.reduce((sum, b) => sum + parseFloat(b.remaining_credit || 0), 0);
                                    return `
                                        <tr>
                                            <td><strong>${customer.customer_name}</strong></td>
                                            <td>${customer.mobile || '-'}</td>
                                            <td>${customer.bills.length}</td>
                                            <td><strong style="color: var(--danger-color);">${customerTotal.toFixed(2)}</strong></td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="viewCustomerBills(${customer.customer_id})">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }

        async function viewCustomerBills(customerId) {
            try {
                const response = await fetch(`/api/credit-settlement/outstanding/${customerId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load bills');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load bills');
                }
                
                selectedCustomerForCredit = data.customer;
                
                document.getElementById('billsCustomerInfo').innerHTML = `
                    <div style="padding: 28px; background: var(--light-gray); border-radius: 8px; margin-bottom: 20px;">
                        <h3>${data.customer.customer_name}</h3>
                        <p><strong>Mobile:</strong> ${data.customer.mobile || 'N/A'}</p>
                        <p><strong>Total Outstanding:</strong> ${data.total_outstanding.toFixed(2)}</p>
                    </div>
                `;
                
                const tbody = document.getElementById('billsTable');
                
                if (data.outstanding_bills.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 12px; color: #999;">No outstanding bills</td></tr>';
                } else {
                    tbody.innerHTML = data.outstanding_bills.map(bill => `
                        <tr>
                            <td><strong>${bill.bill_number}</strong></td>
                            <td>${formatDate(bill.created_at)}</td>
                            <td>${parseFloat(bill.total_amount).toFixed(2)}</td>
                            <td>${parseFloat(bill.original_credit_amount).toFixed(2)}</td>
                            <td><strong style="color: var(--danger-color);">${parseFloat(bill.remaining_credit).toFixed(2)}</strong></td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="openClearModal(${bill.bill_id}, ${customerId}, ${parseFloat(bill.remaining_credit).toFixed(2)})">
                                    <i class="fas fa-money-bill-wave"></i> Clear
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
                
                const modal = document.getElementById('viewBillsModal');
                modal.classList.add('show');
                
            } catch (error) {
                console.error('Error loading bills:', error);
                showAlert('Error loading bills: ' + error.message, 'danger');
            }
        }

        function openClearModal(billId, customerId, remainingAmount) {
            // Close the Outstanding Bills modal first
            const billsModal = document.getElementById('viewBillsModal');
            billsModal.classList.remove('show');
            
            document.getElementById('clearBillId').value = billId;
            document.getElementById('clearCustomerId').value = customerId;
            document.getElementById('clearPaymentAmount').value = remainingAmount;
            
            const billInfo = selectedCustomerForCredit ? `
                <div style="padding: 28px; background: var(--light-gray); border-radius: 8px; margin-bottom: 20px;">
                    <h3>${selectedCustomerForCredit.customer_name}</h3>
                    <p><strong>Remaining Credit:</strong> ${remainingAmount}</p>
                </div>
            ` : '<p>Loading bill details...</p>';
            
            document.getElementById('clearCustomerInfo').innerHTML = billInfo;
            
            const modal = document.getElementById('clearCreditModal');
            modal.classList.add('show');
        }

        function closeClearModal() {
            const modal = document.getElementById('clearCreditModal');
            modal.classList.remove('show');
            document.getElementById('clearCreditForm').reset();
            selectedBillForCredit = null;
            
            // Reopen the Outstanding Bills modal if we have a selected customer
            if (selectedCustomerForCredit) {
                const billsModal = document.getElementById('viewBillsModal');
                billsModal.classList.add('show');
            }
        }

        function closeViewBillsModal() {
            const modal = document.getElementById('viewBillsModal');
            modal.classList.remove('show');
            selectedCustomerForCredit = null;
        }

        function printOutstandingBills() {
            if (!selectedCustomerForCredit) {
                showAlert('No customer data available', 'danger');
                return;
            }

            const customerInfo = selectedCustomerForCredit;
            const billsTable = document.getElementById('billsTable');
            const rows = billsTable.querySelectorAll('tr');
            
            if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('td[colspan]'))) {
                showAlert('No outstanding bills to print', 'warning');
                return;
            }

            // Use the backend PDF route instead of browser print window
            const customerId = customerInfo.customer_id;
            window.open(`/api/outstanding/${customerId}/print`, '_blank');
        }

        document.getElementById('clearCreditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            const formData = new FormData(e.target);
            const data = {
                bill_id: parseInt(formData.get('bill_id')),
                customer_id: parseInt(formData.get('customer_id')),
                payment_amount: parseFloat(formData.get('payment_amount')),
                payment_method: formData.get('payment_method'),
                payment_reference: formData.get('payment_reference') || null,
                notes: formData.get('notes') || null
            };
            
            try {
                const response = await fetch('/api/credit-settlement/record-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const paymentId = result.payment_id;
                    const paymentNumber = result.payment_number;
                    
                    // Close the payment modal first
                    closeClearModal();
                    
                    // Show the print receipt modal
                    showPrintReceiptModal(paymentId, paymentNumber, data.payment_amount);
                    
                    // Refresh the data
                    if (data.customer_id) {
                        viewCustomerBills(data.customer_id);
                    }
                    
                    loadCredits();
                } else {
                    showAlert('Error: ' + (result.message || 'Failed to record payment'), 'danger');
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Record Payment';
            }
        });

        // ==============================
        // CREDIT NOTES SECTION FUNCTIONS
        // ==============================
        
        // Handle credit note type change
        function handleCreditNoteTypeChange() {
            const cnType = document.getElementById('cnTypeSelect').value;
            const returnSection = document.getElementById('cnReturnSection');
            const advanceSection = document.getElementById('cnAdvanceSection');
            
            // Reset mobile input
            document.getElementById('cnCustomerMobile').value = '';
            currentCustomerIdForCN = null;
            
            if (cnType === 'return') {
                returnSection.style.display = 'none';
                advanceSection.style.display = 'none';
            } else if (cnType === 'advance') {
                returnSection.style.display = 'none';
                advanceSection.style.display = 'none';
            }
        }
        
        async function searchCustomerForCreditNote() {
            const mobile = document.getElementById('cnCustomerMobile').value.trim();
            const cnType = document.getElementById('cnTypeSelect').value;
            
            if (!mobile || mobile.length !== 10) {
                showAlert('Please enter a valid 10-digit mobile number', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`/api/customers/search?mobile=${mobile}`);
                const data = await response.json();
                
                if (data.found && data.customer) {
                    currentCustomerIdForCN = data.customer.customer_id;
                    
                    if (cnType === 'return') {
                        // Load customer's bills for returns
                        const billsResponse = await fetch(`/api/customers/${data.customer.customer_id}/bills`);
                        const billsData = await billsResponse.json();
                        
                        document.getElementById('cnCustomerDetails').innerHTML = `
                            <div style="padding: 28px; background: var(--light-gray); border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; font-size: 16px;">${data.customer.customer_name}</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Mobile: ${data.customer.mobile}</div>
                            </div>
                        `;
                        
                        const billSelect = document.getElementById('cnBillSelect');
                        billSelect.innerHTML = '<option value="">Select a bill</option>';
                        
                        const bills = Array.isArray(billsData) ? billsData : (billsData.bills || []);
                        
                        if (bills.length === 0) {
                            billSelect.innerHTML = '<option value="">No bills found for this customer</option>';
                        } else {
                            bills.forEach(sale => {
                                billSelect.innerHTML += `<option value="${sale.sale_id || sale.bill_id}">Bill #${sale.bill_number} - ${formatDate(sale.created_at)}</option>`;
                            });
                        }
                        
                        document.getElementById('cnReturnSection').style.display = 'block';
                        document.getElementById('cnAdvanceSection').style.display = 'none';
                        
                    } else if (cnType === 'advance') {
                        // Show advance payment form
                        document.getElementById('cnAdvanceCustomerDetails').innerHTML = `
                            <div style="padding: 28px; background: var(--light-gray); border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-weight: 600; font-size: 16px;">${data.customer.customer_name}</div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">Mobile: ${data.customer.mobile}</div>
                            </div>
                        `;
                        
                        document.getElementById('cnReturnSection').style.display = 'none';
                        document.getElementById('cnAdvanceSection').style.display = 'block';
                    }
                } else {
                    // Customer not found - show form to create new customer
                    currentCustomerIdForCN = null;
                    
                    const customerForm = `
                        <div style="padding: 28px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; margin-bottom: 15px;">
                            <div style="font-weight: 600; margin-bottom: 15px; color: #856404;">
                                <i class="fas fa-user-plus"></i> New Customer
                            </div>
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" id="cnNewCustomerName" placeholder="Enter customer name" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;">
                            </div>
                            <div class="form-group" style="margin-top: 10px;">
                                <label>Address (Optional)</label>
                                <textarea id="cnNewCustomerAddress" rows="2" placeholder="Enter address" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px;"></textarea>
                            </div>
                            <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="createNewCustomerForCN()">
                                <i class="fas fa-check"></i> Create Customer
                            </button>
                        </div>
                    `;
                    
                    if (cnType === 'return') {
                        document.getElementById('cnCustomerDetails').innerHTML = customerForm;
                        document.getElementById('cnReturnSection').style.display = 'block';
                        document.getElementById('cnAdvanceSection').style.display = 'none';
                    } else if (cnType === 'advance') {
                        document.getElementById('cnAdvanceCustomerDetails').innerHTML = customerForm;
                        document.getElementById('cnReturnSection').style.display = 'none';
                        document.getElementById('cnAdvanceSection').style.display = 'block';
                    }
                    
                    showAlert('Customer not found. Please enter details to create new customer.', 'warning');
                }
            } catch (error) {
                console.error('Error searching customer:', error);
                showAlert('Error searching customer', 'danger');
            }
        }
        
        function clearCreditNoteSearch() {
            document.getElementById('cnCustomerMobile').value = '';
            document.getElementById('cnReturnSection').style.display = 'none';
            document.getElementById('cnAdvanceSection').style.display = 'none';
            document.getElementById('cnCustomerDetails').innerHTML = '';
            document.getElementById('cnAdvanceCustomerDetails').innerHTML = '';
            currentCustomerIdForCN = null;
        }
        
        async function createNewCustomerForCN() {
            const mobile = document.getElementById('cnCustomerMobile').value.trim();
            const name = document.getElementById('cnNewCustomerName').value.trim();
            const address = document.getElementById('cnNewCustomerAddress').value.trim();
            
            if (!name) {
                showAlert('Please enter customer name', 'danger');
                document.getElementById('cnNewCustomerName').focus();
                return;
            }
            
            try {
                const response = await fetch('/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_name: name,
                        mobile: mobile,
                        address: address
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showAlert('Customer created successfully! Note: This customer has no bills yet, so credit notes cannot be issued.', 'success');
                    
                    currentCustomerIdForCN = data.customer_id;
                    
                    // Update the display
                    document.getElementById('cnCustomerDetails').innerHTML = `
                        <div style="padding: 28px; background: var(--light-gray); border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 600; font-size: 16px;">${name}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">Mobile: ${mobile}</div>
                            <div style="margin-top: 10px; padding: 8px; background: #dcfce7; border-radius: 6px; color: #166534; font-size: 12px;">
                                <i class="fas fa-check-circle"></i> New customer created
                            </div>
                        </div>
                    `;
                    
                    // Show empty bill select
                    const billSelect = document.getElementById('cnBillSelect');
                    billSelect.innerHTML = '<option value="">No bills found for this customer</option>';
                } else {
                    showAlert('Error creating customer: ' + (data.message || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error creating customer: ' + error.message, 'danger');
                console.error(error);
            }
        }

        async function loadBillItems() {
            const saleId = document.getElementById('cnBillSelect').value;
            
            if (!saleId) {
                document.getElementById('cnBillItems').style.display = 'none';
                return;
            }
            
            currentSaleIdForCN = saleId;
            
            try {
                const response = await fetch(`/api/sales/${saleId}/with-returns`);
                const sale = await response.json();
                currentBillItemsForCN = sale.items;
                
                const tbody = document.getElementById('cnItemsBody');
                tbody.innerHTML = sale.items.map((item, idx) => {
                    const price = parseFloat(item.price || item.rate || 0);
                    const originalQty = parseFloat(item.quantity);
                    const returnableQty = parseFloat(item.returnable_quantity || 0);
                    const returnedQty = originalQty - returnableQty;
                    const canReturn = returnableQty > 0;
                    
                    return `
                        <tr style="${!canReturn ? 'opacity: 0.5; background: #f8f9fa;' : ''}">
                            <td>
                                <strong>${item.product_name}</strong>
                                ${!canReturn ? '<div style="color: #dc3545; font-size: 12px; margin-top: 4px;"><i class="fas fa-lock"></i> Fully Returned</div>' : ''}
                            </td>
                            <td>
                                <div style="font-weight: 600;">${originalQty.toFixed(2)} ${item.unit || ''}</div>
                                ${returnedQty > 0 ? `<div style="color: #dc3545; font-size: 12px; margin-top: 4px;">Returned: ${returnedQty.toFixed(2)}</div>` : ''}
                                ${canReturn ? `<div style="color: #28a745; font-size: 12px; margin-top: 4px;">Available: ${returnableQty.toFixed(2)}</div>` : ''}
                            </td>
                            <td>${price.toFixed(2)}</td>
                            <td>
                                <input type="number" id="cn_return_qty_${idx}" value="0" min="0" max="${returnableQty}" 
                                       step="0.01" oninput="if(this.value > ${returnableQty}) this.value = ${returnableQty}; calculateCNCredit();" ${!canReturn ? 'disabled' : ''} onfocus="this.select()"
                                       style="width: 100px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
                                ${canReturn ? `<div style="color: #6c757d; font-size: 11px; margin-top: 4px;">Max: ${returnableQty.toFixed(2)}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.getElementById('cnBillItems').style.display = 'block';
                calculateCNCredit();
            } catch (error) {
                showAlert('Error loading bill items', 'danger');
            }
        }

        function calculateCNCredit() {
            let total = 0;
            currentBillItemsForCN.forEach((item, idx) => {
                const returnQty = parseFloat(document.getElementById(`cn_return_qty_${idx}`).value) || 0;
                const price = parseFloat(item.price || item.rate || 0);
                total += returnQty * price;
            });
            document.getElementById('cnTotalCredit').textContent = total.toFixed(2);
        }

        async function processCreditNote() {
            const items = [];
            
            currentBillItemsForCN.forEach((item, idx) => {
                const returnQty = parseFloat(document.getElementById(`cn_return_qty_${idx}`).value) || 0;
                if (returnQty > 0) {
                    const price = parseFloat(item.price || item.rate || 0);
                    items.push({
                        product_id: item.product_id,
                        return_qty: returnQty,
                        original_rate: price
                    });
                }
            });
            
            if (items.length === 0) {
                showAlert('Please enter return quantities', 'danger');
                return;
            }
            
            const data = {
                customer_id: currentCustomerIdForCN,
                sale_id: currentSaleIdForCN,
                items: items
            };
            
            try {
                const response = await fetch('/api/credit_notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('Credit note issued successfully! CN #' + result.credit_note_id, 'success');
                    
                    // Reset all form fields and state
                    document.getElementById('cnReturnSection').style.display = 'none';
                    document.getElementById('cnBillItems').style.display = 'none';
                    document.getElementById('cnCustomerMobile').value = '';
                    document.getElementById('cnCustomerDetails').innerHTML = '';
                    document.getElementById('cnBillSelect').innerHTML = '<option value="">Select a bill</option>';
                    
                    // Clear state variables
                    currentCustomerIdForCN = null;
                    currentSaleIdForCN = null;
                    currentBillItemsForCN = [];
                    
                    // Reload credit notes list to show the new one
                    loadCreditNotes();
                } else {
                    showAlert('Error: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('Error processing credit note', 'danger');
            }
        }

        async function processAdvancePayment() {
            const amount = parseFloat(document.getElementById('cnAdvanceAmount').value);
            const paymentMethod = document.getElementById('cnAdvancePaymentMethod').value;
            const reference = document.getElementById('cnAdvanceReference').value.trim();
            const notes = document.getElementById('cnAdvanceNotes').value.trim();
            
            // Validation
            if (!currentCustomerIdForCN) {
                showAlert('Please search and select a customer first', 'danger');
                return;
            }
            
            if (!amount || amount <= 0) {
                showAlert('Please enter a valid advance amount', 'danger');
                return;
            }
            
            if (!paymentMethod) {
                showAlert('Please select a payment method', 'danger');
                return;
            }
            
            const data = {
                customer_id: currentCustomerIdForCN,
                amount: amount,
                payment_method: paymentMethod,
                payment_reference: reference || null,
                notes: notes || null
            };
            
            try {
                const response = await fetch('/api/credit-notes/advance-payment-v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Advance payment of ${amount.toFixed(2)} recorded successfully! CN #${result.credit_number}`, 'success');
                    
                    // Reset all form fields and sections
                    document.getElementById('cnAdvanceSection').style.display = 'none';
                    document.getElementById('cnCustomerMobile').value = '';
                    document.getElementById('cnAdvanceCustomerDetails').innerHTML = '';
                    document.getElementById('cnAdvanceAmount').value = '';
                    document.getElementById('cnAdvancePaymentMethod').value = 'cash';
                    document.getElementById('cnAdvanceReference').value = '';
                    document.getElementById('cnAdvanceNotes').value = '';
                    
                    // Clear state
                    currentCustomerIdForCN = null;
                    
                    // Reload credit notes list
                    loadCreditNotes();
                } else {
                    showAlert('Error: ' + (result.message || 'Failed to record advance payment'), 'danger');
                }
            } catch (error) {
                console.error('Error processing advance payment:', error);
                showAlert('Error processing advance payment: ' + error.message, 'danger');
            }
        }

        
        
        // Debounce timer for dynamic search
        
        // Debounce timer for dynamic search
        let cnSearchTimeout = null;
        let isSearching = false;
        
        // Debounced search function (called on every keystroke)
        function debounceCNSearch() {
            // Clear previous timeout
            if (cnSearchTimeout) {
                clearTimeout(cnSearchTimeout);
            }
            
            const searchInput = document.getElementById('cnSearchInput').value.trim();
            
            // If empty, show all
            if (!searchInput) {
                loadCreditNotes();
                return;
            }
            
            // Wait 300ms after user stops typing before searching
            cnSearchTimeout = setTimeout(() => {
                // Only search if input is at least 3 characters
                if (searchInput.length >= 3) {
                    searchCreditNotes();
                }
            }, 300);
        }
        
        // Search Credit Notes by Mobile or CN#
        async function searchCreditNotes() {
            const searchInput = document.getElementById('cnSearchInput').value.trim();
            
            if (!searchInput) {
                loadCreditNotes();
                return;
            }
            
            // Prevent multiple simultaneous searches
            if (isSearching) return;
            isSearching = true;
            
            const tbody = document.getElementById('cnHistoryTable');
            const currentContent = tbody.innerHTML;
            
            try {
                // Check if input is CN# (contains CN or starts with #) or mobile number
                const isCN = searchInput.toUpperCase().includes('CN') || searchInput.startsWith('#');
                const isMobile = /^\d+$/.test(searchInput);
                
                let url = '/api/credit_notes';
                
                if (isCN) {
                    // Search by CN# - clean the input
                    let cnNumber = searchInput.toUpperCase().replace(/[^A-Z0-9-]/g, '');
                    if (!cnNumber.startsWith('CN')) {
                        cnNumber = 'CN' + cnNumber;
                    }
                    url += `?cn_number=${cnNumber}`;
                } else if (isMobile) {
                    // Search by mobile (supports partial)
                    url += `?mobile=${searchInput}`;
                } else {
                    // Try as text search
                    url += `?mobile=${searchInput}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Search failed');
                }
                
                const creditNotes = await response.json();
                
                // Handle different response formats
                const notes = Array.isArray(creditNotes) ? creditNotes : (creditNotes.credit_notes || []);
                
                if (notes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: #999; font-size: 16px; margin-bottom: 8px;">
                                    <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                                    No credit notes found
                                </div>
                                <div style="color: #666; font-size: 14px;">
                                    No results for: "${searchInput}"
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    displayCreditNotes(notes);
                }
                
            } catch (error) {
                console.error('Error searching credit notes:', error);
                // Restore previous content on error
                tbody.innerHTML = currentContent;
            } finally {
                isSearching = false;
            }
        }
        
        // Clear CN Search
        function clearCNSearch() {
            document.getElementById('cnSearchInput').value = '';
            if (cnSearchTimeout) {
                clearTimeout(cnSearchTimeout);
            }
            loadCreditNotes();
        }
        
        // Display Credit Notes
        function displayCreditNotes(creditNotes) {
            const tbody = document.getElementById('cnHistoryTable');
            
            if (!creditNotes || creditNotes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            <div style="color: #999; font-size: 16px;">
                                <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                                No credit notes found
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = creditNotes.map(cn => {
                    const amount = parseFloat(cn.amount || cn.total_amount || 0);
                    const remaining = parseFloat(cn.remaining_balance || 0);
                    
                    // Determine type - check bill_number pattern or is_advance flag
                    const isAdvance = cn.is_advance || 
                                    (cn.bill_number && cn.bill_number.startsWith('ADV-')) ||
                                    (cn.credit_number && cn.credit_number.includes('ADV'));
                    
                    const typeBadge = isAdvance ? 
                        '<span class="badge" style="background: #8b5cf6; color: white;">Advance</span>' :
                        '<span class="badge badge-primary">Return</span>';
                    
                    let badgeClass = 'badge-success';
                    let statusText = 'Active';
                    
                    if (remaining <= 0) {
                        badgeClass = 'badge-gray';
                        statusText = 'Used';
                    } else if (remaining > 0 && remaining < amount) {
                        badgeClass = 'badge-warning';
                        statusText = 'Partial';
                    }
                    
                    const creditId = cn.credit_id;
                    
                    return `
                        <tr>
                            <td><strong>#${cn.credit_number || cn.credit_id}</strong></td>
                            <td>${typeBadge}</td>
                            <td>${cn.customer_name || 'N/A'}<br><small style="color: #666;">${cn.mobile || ''}</small></td>
                            <td><strong>${amount.toFixed(2)}</strong></td>
                            <td><strong style="color: ${remaining > 0 ? 'var(--success-color)' : '#999'};">${remaining.toFixed(2)}</strong></td>
                            <td><span class="badge ${badgeClass}">${statusText}</span></td>
                            <td>${formatDate(cn.created_at)}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="printCreditNote(${creditId})" title="Print Credit Note">
                                    <i class="fas fa-print"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        async function loadCreditNotes() {
            try {
                const response = await fetch('/api/credit_notes');
                const creditNotes = await response.json();
                const notes = Array.isArray(creditNotes) ? creditNotes : (creditNotes.credit_notes || []);
                displayCreditNotes(notes);
            } catch (error) {
                console.error('Error loading credit notes:', error);
                const tbody = document.getElementById('cnHistoryTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                            Error loading credit notes
                        </td>
                    </tr>
                `;
            }
        }
        // Print Credit Note Function
        function printCreditNote(creditId) {
            window.open(`/api/credit-notes/${creditId}/print`, '_blank');
        }

        // ============================
        // QUOTATIONS SECTION FUNCTIONS
        // ============================
        
        async function loadQuoteBrands() {
            try {
                // Load products first to extract brands and categories
                const response = await fetch('/api/products');
                const products = await response.json();
                
                // Extract unique brands
                const brands = [...new Set(products.map(p => p.brand).filter(Boolean))].sort();
                
                const brandFilter = document.getElementById('quoteBrandFilter');
                brandFilter.innerHTML = '<option value="">All Brands</option>';
                brands.forEach(brand => {
                    brandFilter.innerHTML += `<option value="${brand}">${brand}</option>`;
                });
                
                // Extract unique categories
                const categories = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
                
                const categoryFilter = document.getElementById('quoteCategoryFilter');
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
                });
                
                loadQuoteProducts();
            } catch (error) {
                console.error('Error loading brands:', error);
                showAlert('Error loading brands', 'danger');
            }
        }

        async function loadQuoteProducts() {
            try {
                const response = await fetch('/api/products');
                let products = await response.json();
                
                // Client-side filtering
                const brand = document.getElementById('quoteBrandFilter').value;
                const category = document.getElementById('quoteCategoryFilter').value;
                
                if (brand) {
                    products = products.filter(p => p.brand === brand);
                }
                if (category) {
                    products = products.filter(p => p.category === category);
                }
                
                // Map backend fields to expected frontend fields
                allQuoteProducts = products.map(p => ({
                    ...p,
                    stock: p.current_stock || 0,
                    rate: p.price || p.rate || 0
                }));
                
                displayQuoteProducts(allQuoteProducts);
            } catch (error) {
                console.error('Error loading products:', error);
                showAlert('Error loading products', 'danger');
            }
        }

        function filterQuoteProducts() {
            const search = document.getElementById('quoteProductSearch').value.toLowerCase();
            const filtered = allQuoteProducts.filter(p => 
                p.product_name.toLowerCase().includes(search) ||
                (p.brand && p.brand.toLowerCase().includes(search))
            );
            displayQuoteProducts(filtered);
        }

        function displayQuoteProducts(products) {
            const container = document.getElementById('quoteProductList');
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 12px;">No products found</p>';
                return;
            }
            
            container.innerHTML = products.map(product => {
                const isSelected = quoteSelectedItems.find(item => item.product_id === product.product_id);
                const stock = product.current_stock || product.stock || 0;
                const stockClass = stock > 10 ? 'success' : stock > 0 ? 'warning' : 'danger';
                
                return `
                    <div class="product-card ${isSelected ? 'selected' : ''}" onclick="toggleQuoteProduct(${product.product_id})">
                        <div style="font-weight: 600; font-size: 15px; margin-bottom: 2px; line-height: 1.3; color: var(--text-primary);">${product.product_name}</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.3px;">${product.brand || ''}</div>
                        <span class="badge badge-${stockClass}" style="margin-top: auto;">
                            ${Math.round(stock)} ${product.unit || 'pcs'}
                        </span>
                        ${isSelected ? '<div style="margin-top: 8px; color: var(--success-color); font-size: 12px; font-weight: 600;"><i class="fas fa-check-circle"></i> Added</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleQuoteProduct(productId) {
            const product = allQuoteProducts.find(p => p.product_id === productId);
            if (!product) return;
            
            const existingIndex = quoteSelectedItems.findIndex(item => item.product_id === productId);
            
            if (existingIndex >= 0) {
                // If already selected, remove it
                quoteSelectedItems.splice(existingIndex, 1);
                displayQuoteProducts(allQuoteProducts.filter(p => 
                    p.product_name.toLowerCase().includes(document.getElementById('quoteProductSearch').value.toLowerCase())
                ));
                renderQuoteSelectedItems();
            } else {
                // Open modal to add with quantity, price, discount
                openQuoteAddToCartModal(product);
            }
        }

        function openQuoteAddToCartModal(product) {
            currentQuoteProduct = product;
            
            // Set product details
            document.getElementById('quoteModalProductName').textContent = product.product_name;
            document.getElementById('quoteModalProductBrand').textContent = product.brand || 'No Brand';
            
            const stock = product.current_stock || product.stock || 0;
            document.getElementById('quoteModalProductStock').textContent = `Available Stock: ${Math.round(stock)} ${product.unit || 'pcs'}`;
            
            // Set default values
            document.getElementById('quoteModalQuantity').value = '1';
            document.getElementById('quoteModalPrice').value = parseFloat(product.rate || product.price || 0).toFixed(2);
            document.getElementById('quoteModalDiscount').value = '0';
            
            // Show modal
            document.getElementById('quoteAddToCartModal').style.display = 'block';
        }

        function closeQuoteAddToCartModal() {
            document.getElementById('quoteAddToCartModal').style.display = 'none';
            currentQuoteProduct = null;
        }

        function addQuoteItemFromModal() {
            if (!currentQuoteProduct) return;
            
            const quantity = parseFloat(document.getElementById('quoteModalQuantity').value) || 0;
            const price = parseFloat(document.getElementById('quoteModalPrice').value) || 0;
            const discount = parseFloat(document.getElementById('quoteModalDiscount').value) || 0;
            
            if (quantity <= 0) {
                showAlert('Please enter a valid quantity', 'danger');
                return;
            }
            
            if (price < 0) {
                showAlert('Please enter a valid price', 'danger');
                return;
            }
            
            // Add to selected items
            quoteSelectedItems.push({
                ...currentQuoteProduct,
                quantity: quantity,
                unit_price: price,
                discount_percentage: discount
            });
            
            // Update displays
            displayQuoteProducts(allQuoteProducts.filter(p => 
                p.product_name.toLowerCase().includes(document.getElementById('quoteProductSearch').value.toLowerCase())
            ));
            renderQuoteSelectedItems();
            
            // Close modal
            closeQuoteAddToCartModal();
        }

        function renderQuoteSelectedItems() {
            const container = document.getElementById('quoteSelectedItems');
            
            if (quoteSelectedItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 12px;">No items selected</p>';
                updateQuoteSummary();
                return;
            }
            
            container.innerHTML = quoteSelectedItems.map((item, index) => {
                const itemTotal = calculateQuoteItemTotal(item);
                return `
                    <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; border: 1.5px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 15px;">${item.product_name}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" onclick="editQuoteItem(${index})" style="padding: 6px 10px; font-size: 12px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="removeQuoteItem(${index})" style="padding: 6px 10px; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 10px 12px; border-radius: 8px; font-weight: 600;">
                            <span style="color: var(--text-primary);">Brand: <span style="font-weight: 700;">${item.brand || 'N/A'}</span></span>
                            <span style="color: var(--text-primary);">Qty: <span style="font-weight: 700;">${item.quantity}</span></span>
                            <span style="color: var(--text-primary);">Price: <span style="font-weight: 700;">${parseFloat(item.unit_price).toFixed(2)}</span></span>
                            <span style="color: var(--text-primary);">Disc: <span style="font-weight: 700;">${item.discount_percentage}%</span></span>
                            <span style="color: var(--success-color); font-weight: 700; font-size: 14px;">Total: ${itemTotal.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateQuoteSummary();
        }

        function editQuoteItem(index) {
            const item = quoteSelectedItems[index];
            if (!item) return;
            
            // Set current product for editing
            currentQuoteProduct = { ...item, index: index };
            
            // Set product details
            document.getElementById('quoteModalProductName').textContent = item.product_name;
            document.getElementById('quoteModalProductBrand').textContent = item.brand || 'No Brand';
            
            const stock = item.current_stock || item.stock || 0;
            document.getElementById('quoteModalProductStock').textContent = `Available Stock: ${Math.round(stock)} ${item.unit || 'pcs'}`;
            
            // Set current values
            document.getElementById('quoteModalQuantity').value = item.quantity;
            document.getElementById('quoteModalPrice').value = item.unit_price;
            document.getElementById('quoteModalDiscount').value = item.discount_percentage;
            
            // Change button text and action
            const addButton = document.querySelector('#quoteAddToCartModal .btn-primary');
            addButton.innerHTML = '<i class="fas fa-check"></i> Update Item';
            addButton.onclick = updateQuoteItemFromModal;
            
            // Show modal
            document.getElementById('quoteAddToCartModal').style.display = 'block';
        }

        function updateQuoteItemFromModal() {
            if (!currentQuoteProduct || currentQuoteProduct.index === undefined) return;
            
            const quantity = parseFloat(document.getElementById('quoteModalQuantity').value) || 0;
            const price = parseFloat(document.getElementById('quoteModalPrice').value) || 0;
            const discount = parseFloat(document.getElementById('quoteModalDiscount').value) || 0;
            
            if (quantity <= 0) {
                showAlert('Please enter a valid quantity', 'danger');
                return;
            }
            
            if (price < 0) {
                showAlert('Please enter a valid price', 'danger');
                return;
            }
            
            // Update the item
            quoteSelectedItems[currentQuoteProduct.index].quantity = quantity;
            quoteSelectedItems[currentQuoteProduct.index].unit_price = price;
            quoteSelectedItems[currentQuoteProduct.index].discount_percentage = discount;
            
            // Update displays
            renderQuoteSelectedItems();
            
            // Reset button
            const addButton = document.querySelector('#quoteAddToCartModal .btn-primary');
            addButton.innerHTML = '<i class="fas fa-check"></i> Add to Quotation';
            addButton.onclick = addQuoteItemFromModal;
            
            // Close modal
            closeQuoteAddToCartModal();
        }

        function calculateQuoteItemTotal(item) {
            const baseTotal = item.quantity * item.unit_price;
            const discountAmount = (baseTotal * (item.discount_percentage || 0)) / 100;
            return baseTotal - discountAmount;
        }

        function updateQuoteItem(index, field, value) {
            quoteSelectedItems[index][field] = parseFloat(value) || 0;
            renderQuoteSelectedItems();
        }

        function removeQuoteItem(index) {
            quoteSelectedItems.splice(index, 1);
            renderQuoteSelectedItems();
            displayQuoteProducts(allQuoteProducts.filter(p => 
                p.product_name.toLowerCase().includes(document.getElementById('quoteProductSearch').value.toLowerCase())
            ));
        }

        function updateQuoteSummary() {
            const subtotal = quoteSelectedItems.reduce((sum, item) => sum + calculateQuoteItemTotal(item), 0);
            quoteDiscountPercentage = parseFloat(document.getElementById('quoteDiscountPercent').value) || 0;
            const discountAmount = (subtotal * quoteDiscountPercentage) / 100;
            const grandTotal = subtotal - discountAmount;
            
            document.getElementById('quoteSubtotal').textContent = '' + subtotal.toFixed(2);
            document.getElementById('quoteDiscountAmount').textContent = '-' + discountAmount.toFixed(2);
            document.getElementById('quoteGrandTotal').textContent = '' + grandTotal.toFixed(2);
        }

        async function generateQuotation() {
            if (!quoteCustomerData) {
                showAlert('Please add customer details', 'danger');
                return;
            }
            
            const customerName = quoteCustomerData.name;
            const customerMobile = quoteCustomerData.mobile;
            const customerAddress = quoteCustomerData.address || '';
            
            if (quoteSelectedItems.length === 0) {
                showAlert('Please add at least one item', 'danger');
                return;
            }
            
            const itemsWithoutPrice = quoteSelectedItems.filter(item => !item.unit_price || item.unit_price === 0);
            if (itemsWithoutPrice.length > 0) {
                showAlert('Please enter prices for all items', 'danger');
                return;
            }
            
            const quotationData = {
                customer_name: customerName,
                customer_mobile: customerMobile,
                customer_address: customerAddress,
                items: quoteSelectedItems,
                discount_percentage: quoteDiscountPercentage
            };
            
            try {
                const response = await fetch('/api/quotations/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(quotationData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate quotation');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Quotation_${customerName.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showAlert('Quotation generated successfully!', 'success');
                
                if (confirm('Quotation downloaded! Do you want to create another quotation?')) {
                    clearQuotation();
                }
            } catch (error) {
                showAlert('Error generating quotation: ' + error.message, 'danger');
            }
        }

        function clearQuotation() {
            if (confirm('Are you sure you want to clear this quotation?')) {
                quoteSelectedItems = [];
                quoteDiscountPercentage = 0;
                quoteCustomerData = null;
                document.getElementById('quoteDiscountPercent').value = '0';
                
                // Hide customer info panel and show add button
                document.getElementById('quoteCustomerInfoPanel').style.display = 'none';
                const addButton = document.getElementById('quoteAddCustomerButton');
                if (addButton) addButton.style.display = 'inline-block';
                
                renderQuoteSelectedItems();
                displayQuoteProducts(allQuoteProducts);
            }
        }

        // Quote Customer Modal Functions
        function openQuoteCustomerModal() {
            document.getElementById('quoteCustomerModal').style.display = 'block';
            document.getElementById('quoteModalCustomerName').value = '';
            document.getElementById('quoteModalCustomerMobile').value = '';
            document.getElementById('quoteModalCustomerAddress').value = '';
        }

        function closeQuoteCustomerModal() {
            document.getElementById('quoteCustomerModal').style.display = 'none';
        }

        function saveQuoteCustomer() {
            const name = document.getElementById('quoteModalCustomerName').value.trim();
            const mobile = document.getElementById('quoteModalCustomerMobile').value.trim();
            const address = document.getElementById('quoteModalCustomerAddress').value.trim();
            
            // Validation
            if (!name) {
                showAlert('Please enter customer name', 'danger');
                return;
            }
            
            if (!mobile || mobile.length !== 10 || !/^\d{10}$/.test(mobile)) {
                showAlert('Please enter a valid 10-digit mobile number', 'danger');
                return;
            }
            
            // Save customer data
            quoteCustomerData = {
                name: name,
                mobile: mobile,
                address: address
            };
            
            // Display customer info
            displayQuoteCustomerInfo();
            
            // Close modal
            closeQuoteCustomerModal();
        }

        function displayQuoteCustomerInfo() {
            if (!quoteCustomerData) return;
            
            // Update display elements
            document.getElementById('quoteCustomerDisplayName').textContent = quoteCustomerData.name;
            document.getElementById('quoteCustomerDisplayMobile').textContent = quoteCustomerData.mobile;
            
            const addressDiv = document.getElementById('quoteCustomerDisplayAddress');
            if (quoteCustomerData.address) {
                addressDiv.querySelector('span').textContent = quoteCustomerData.address;
                addressDiv.style.display = 'block';
            } else {
                addressDiv.style.display = 'none';
            }
            
            // Show customer info panel and hide add button
            document.getElementById('quoteCustomerInfoPanel').style.display = 'block';
            const addButton = document.getElementById('quoteAddCustomerButton');
            if (addButton) addButton.style.display = 'none';
        }

        function clearQuoteCustomer() {
            if (confirm('Remove customer details?')) {
                quoteCustomerData = null;
                
                // Hide customer info panel and show add button
                document.getElementById('quoteCustomerInfoPanel').style.display = 'none';
                const addButton = document.getElementById('quoteAddCustomerButton');
                if (addButton) addButton.style.display = 'inline-block';
            }
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'warning' ? 'exclamation-triangle' : 'exclamation-triangle';
            
            alertDiv.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            setTimeout(() => {
                alertDiv.innerHTML = '';
            }, 5000);
        }

        // Close modals on outside click





        // Cart Customer Management
        let cartCustomer = null;
        // currentCustomer and customerCreditNotes already declared globally above

        function openAddCustomerModal() {
            // Clear previous values
            document.getElementById('modalCustomerMobile').value = '';
            document.getElementById('modalCustomerDetails').innerHTML = '';
            
            const modal = document.getElementById('addCustomerModal');
            modal.classList.add('show');
        }

        function closeAddCustomerModal() {
            const modal = document.getElementById('addCustomerModal');
            modal.classList.remove('show');
        }

        async function searchCustomerInModal() {
            const mobile = document.getElementById('modalCustomerMobile').value.trim();
            
            if (!mobile || mobile.length !== 10) {
                showAlert('Please enter a valid 10-digit mobile number', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`/api/customers/search?mobile=${mobile}`);
                const data = await response.json();
                
                const detailsDiv = document.getElementById('modalCustomerDetails');
                
                if (data.found && data.customer) {
                    // Customer found
                    currentCustomer = data.customer;
                    customerCreditNotes = data.credit_notes || [];
                    const totalCreditBalance = customerCreditNotes.reduce((sum, cn) => sum + parseFloat(cn.remaining_balance || 0), 0);
                    
                    detailsDiv.innerHTML = `
                        <div style="padding: 20px; background: var(--light-gray); border-radius: 12px;">
                            <div style="font-weight: 600; font-size: 18px; margin-bottom: 12px; color: var(--text-primary);">
                                ${data.customer.customer_name}
                            </div>
                            
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                                Mobile: ${data.customer.mobile}
                            </div>
                            
                            ${data.customer.total_sales ? `
                                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                                    Total Sales: ${parseFloat(data.customer.total_sales).toFixed(2)}
                                </div>
                            ` : ''}
                            
                            ${customerCreditNotes.length > 0 ? `
                                <div style="margin-top: 12px; padding: 12px; background: #dcfce7; border-radius: 8px;">
                                    <div style="color: #166534; font-weight: 600;">
                                        <i class="fas fa-ticket-alt"></i> Credit Notes Available: ${totalCreditBalance.toFixed(2)}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <button class="btn btn-primary" onclick="addCustomerToCart()" style="margin-top: 15px; width: 100%;">
                                <i class="fas fa-check"></i> Add Customer
                            </button>
                        </div>
                    `;
                } else {
                    // Customer not found - ask for name
                    currentCustomer = null;
                    customerCreditNotes = [];
                    
                    detailsDiv.innerHTML = `
                        <div style="padding: 20px; background: #fff3cd; border-radius: 12px; border: 1px solid #ffc107;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #856404;">
                                <i class="fas fa-user-plus"></i> New Customer
                            </div>
                            <p style="color: #856404; margin: 0 0 15px 0; font-size: 14px;">
                                No customer found with mobile: ${mobile}
                            </p>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; color: #856404; font-weight: 500;">
                                    Customer Name <span style="color: #dc2626;">*</span>
                                </label>
                                <input type="text" id="newCustomerNameInput" placeholder="Enter customer name" 
                                    style="width: 100%; padding: 12px 16px; border: 1.5px solid #ffc107; border-radius: 10px; font-size: 15px;">
                            </div>
                            
                            <button class="btn btn-primary" onclick="addNewCustomerToCart('${mobile}')" style="width: 100%;">
                                <i class="fas fa-check"></i> Add Customer
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                showAlert('Error searching customer', 'danger');
                console.error('Error:', error);
            }
        }

        function addNewCustomerToCart(mobile) {
            const nameInput = document.getElementById('newCustomerNameInput');
            const name = nameInput ? nameInput.value.trim() : '';
            
            if (!name) {
                showAlert('Please enter customer name', 'danger');
                return;
            }
            
            // Store new customer with name
            currentCustomer = { 
                mobile: mobile, 
                customer_name: name, 
                new: true 
            };
            
            // Add to cart
            addCustomerToCart();
        }

        function addCustomerToCart() {
            if (!currentCustomer) return;
            
            // Store customer
            cartCustomer = currentCustomer;
            
            // Display in cart
            displayCartCustomer();
            
            // Show credit note option if available
            if (customerCreditNotes.length > 0) {
                const creditNoteItem = document.getElementById('creditNotePaymentItem');
                if (creditNoteItem) {
                    creditNoteItem.style.display = 'flex';
                }
            }
            
            // Close modal
            closeAddCustomerModal();
            
            // No success notification
        }

        function displayCartCustomer() {
            if (!cartCustomer) return;
            
            const container = document.getElementById('cartCustomerInfo');
            document.getElementById('cartCustomerName').textContent = cartCustomer.customer_name || 'Customer';
            document.getElementById('cartCustomerMobile').textContent = cartCustomer.mobile;
            
            // Show total sales if available
            const salesDiv = document.getElementById('cartCustomerSales');
            if (cartCustomer.total_sales) {
                salesDiv.querySelector('span').textContent = `Total Sales: ${parseFloat(cartCustomer.total_sales).toFixed(2)}`;
                salesDiv.style.display = 'block';
            } else {
                salesDiv.style.display = 'none';
            }
            
            // Show credit notes if available
            const creditDiv = document.getElementById('cartCustomerCredit');
            if (customerCreditNotes && customerCreditNotes.length > 0) {
                const totalCredit = customerCreditNotes.reduce((sum, cn) => sum + parseFloat(cn.remaining_balance || 0), 0);
                creditDiv.querySelector('span').textContent = `Credit Notes Available: ${totalCredit.toFixed(2)}`;
                creditDiv.style.display = 'block';
            } else {
                creditDiv.style.display = 'none';
            }
            
            container.style.display = 'block';
        }

        function clearCartCustomer() {
            if (confirm('Remove customer from this cart?')) {
                cartCustomer = null;
                currentCustomer = null;
                customerCreditNotes = [];
                document.getElementById('cartCustomerInfo').style.display = 'none';
                
                // Hide credit note option
                const creditNoteItem = document.getElementById('creditNotePaymentItem');
                if (creditNoteItem) {
                    creditNoteItem.style.display = 'none';
                }
                
            }
        }

        window.onclick = function(event) {
            const clearModal = document.getElementById('clearCreditModal');
            const billsModal = document.getElementById('viewBillsModal');
            const addToCartModal = document.getElementById('addToCartModal');
            const addCustomerModal = document.getElementById('addCustomerModal');
            const quoteCustomerModal = document.getElementById('quoteCustomerModal');
            const quoteAddToCartModal = document.getElementById('quoteAddToCartModal');
            
            if (event.target === clearModal) {
                closeClearModal();
            }
            if (event.target === billsModal) {
                closeViewBillsModal();
            }
            if (event.target === addToCartModal) {
                closeAddToCartModal();
            }
            if (event.target === addCustomerModal) {
                closeAddCustomerModal();
            }
            if (event.target === quoteCustomerModal) {
                closeQuoteCustomerModal();
            }
            if (event.target === quoteAddToCartModal) {
                closeQuoteAddToCartModal();
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadBrands();
        });
    </script>

    <!-- Print Bill Modal -->
    <div id="printBillModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    Sale Completed Successfully!
                </h2>
                <span class="close" onclick="closePrintBillModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div style="margin-bottom: 25px;">
                    <i class="fas fa-file-invoice" style="font-size: 64px; color: #2563eb; margin-bottom: 15px;"></i>
                    <p style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 10px;">
                        Bill Generated Successfully
                    </p>
                    <p id="billNumberDisplay" style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">
                        Bill #: <span id="billNumber" style="font-weight: 600; color: #2563eb;"></span>
                    </p>
                    <p id="billAmountDisplay" style="font-size: 14px; color: #6b7280;">
                        Amount: <span id="billAmount" style="font-weight: 600; color: #1f2937;"></span>
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="printBillFromModal()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px;">
                        <i class="fas fa-print"></i> Print Bill
                    </button>
                    <button onclick="closePrintBillModal()" class="btn btn-secondary" style="padding: 12px 30px; font-size: 16px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                
                <p style="font-size: 12px; color: #9ca3af; margin-top: 20px; margin-bottom: 0;">
                    You can also print this bill later from the sales history
                </p>
            </div>
        </div>
    </div>

    <!-- Payment Receipt Print Modal -->
    <div id="printReceiptModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white;">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    Payment Recorded Successfully!
                </h2>
                <span class="close" onclick="closePrintReceiptModal()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 30px;">
                <div style="margin-bottom: 25px;">
                    <i class="fas fa-receipt" style="font-size: 64px; color: #16a34a; margin-bottom: 15px;"></i>
                    <p style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 10px;">
                        Payment Receipt Generated
                    </p>
                    <p id="receiptNumberDisplay" style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">
                        Receipt #: <span id="receiptNumber" style="font-weight: 600; color: #16a34a;"></span>
                    </p>
                    <p id="paymentAmountDisplay" style="font-size: 14px; color: #6b7280;">
                        Amount: <span id="paymentAmount" style="font-weight: 600; color: #1f2937;"></span>
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="printReceiptFromModal()" class="btn btn-success" style="padding: 12px 30px; font-size: 16px;">
                        <i class="fas fa-print"></i> Print Receipt
                    </button>
                    <button onclick="closePrintReceiptModal()" class="btn btn-secondary" style="padding: 12px 30px; font-size: 16px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
                
                <p style="font-size: 12px; color: #9ca3af; margin-top: 20px; margin-bottom: 0;">
                    You can also print this receipt later from the payment history
                </p>
            </div>
        </div>
    </div>

    <!-- Add to Cart Modal -->
    <div id="addToCartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cart-plus"></i> Add to Cart</h3>
                <button class="modal-close" onclick="closeAddToCartModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-product-info">
                    <h4 id="modalProductName"></h4>
                    <p id="modalProductBrand"></p>
                    <p id="modalProductStock" style="margin-top: 8px; font-weight: 600; color: var(--success-color);"></p>
                </div>
                <div class="modal-form-group">
                    <label for="modalQuantity">
                        <i class="fas fa-cubes"></i> Quantity
                    </label>
                    <input type="number" id="modalQuantity" value="1" min="0.01" step="0.01" placeholder="Enter quantity" onfocus="this.select()">
                    <small id="stockWarning" style="color: var(--danger-color); display: none; margin-top: 4px;"> Exceeds available stock!</small>
                </div>
                <div class="modal-form-group">
                    <label for="modalPrice">
                        <i class="fas fa-rupee-sign"></i> Unit Price
                    </label>
                    <input type="number" id="modalPrice" value="0" min="0" step="0.01" placeholder="Enter price" onfocus="this.select()">
                </div>
                <div class="modal-form-group">
                    <label for="modalDiscount">
                        <i class="fas fa-percentage"></i> Discount (%)
                    </label>
                    <input type="number" id="modalDiscount" value="0" min="0" max="100" step="0.1" placeholder="Enter discount percentage" onfocus="this.select()">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAddToCartModal()" style="background: #e2e8f0; color: #334155;">
                    Cancel
                </button>
                <button class="btn btn-primary" id="modalActionButton" onclick="handleModalAction()">
                    <i class="fas fa-check"></i> Add to Cart
                </button>
            </div>
            </div>
        </div>
    </div>



    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add Customer</h3>
                <button class="modal-close" onclick="closeAddCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Mobile Number Search -->
                <div class="form-group">
                    <label>Mobile Number</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="modalCustomerMobile" placeholder="Enter 10-digit mobile" maxlength="10" style="flex: 1; padding: 12px 16px; border: 1.5px solid var(--border-color); border-radius: 10px; font-size: 15px;" onfocus="this.select()">
                        <button class="btn btn-primary" onclick="searchCustomerInModal()" style="padding: 12px 24px; white-space: nowrap;">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                
                <!-- Customer Details Display -->
                <div id="modalCustomerDetails" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Quote Add to Cart Modal -->
    <div id="quoteAddToCartModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-cart-plus"></i> Add to Quotation</h3>
                <button class="modal-close" onclick="closeQuoteAddToCartModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-product-info">
                    <h4 id="quoteModalProductName"></h4>
                    <p id="quoteModalProductBrand"></p>
                    <p id="quoteModalProductStock" style="margin-top: 8px; font-weight: 600; color: var(--success-color);"></p>
                </div>
                <div class="modal-form-group">
                    <label for="quoteModalQuantity">
                        <i class="fas fa-cubes"></i> Quantity
                    </label>
                    <input type="number" id="quoteModalQuantity" value="1" min="0.01" step="0.01" placeholder="Enter quantity" onfocus="this.select()">
                </div>
                <div class="modal-form-group">
                    <label for="quoteModalPrice">
                        <i class="fas fa-rupee-sign"></i> Unit Price
                    </label>
                    <input type="number" id="quoteModalPrice" value="0" min="0" step="0.01" placeholder="Enter price" onfocus="this.select()">
                </div>
                <div class="modal-form-group">
                    <label for="quoteModalDiscount">
                        <i class="fas fa-percentage"></i> Discount (%)
                    </label>
                    <input type="number" id="quoteModalDiscount" value="0" min="0" max="100" step="0.1" placeholder="Enter discount percentage" onfocus="this.select()">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeQuoteAddToCartModal()" style="background: #e2e8f0; color: #334155;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="addQuoteItemFromModal()">
                    <i class="fas fa-check"></i> Add to Quotation
                </button>
            </div>
        </div>
    </div>

    <!-- Quote Customer Modal -->
    <div id="quoteCustomerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add Customer Details</h3>
                <button class="modal-close" onclick="closeQuoteCustomerModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name <span style="color: var(--danger-color);">*</span></label>
                    <input type="text" id="quoteModalCustomerName" placeholder="Enter customer name" required>
                </div>
                
                <div class="form-group">
                    <label>Mobile Number <span style="color: var(--danger-color);">*</span></label>
                    <input type="text" id="quoteModalCustomerMobile" placeholder="Enter 10-digit mobile" maxlength="10" required>
                </div>
                
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="quoteModalCustomerAddress" rows="3" placeholder="Enter address (optional)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeQuoteCustomerModal()" style="background: #e2e8f0; color: #334155;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="saveQuoteCustomer()">
                    <i class="fas fa-check"></i> Add Customer
                </button>
            </div>
        </div>
    </div>
</body>
</html>